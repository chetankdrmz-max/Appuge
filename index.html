<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart FarmHer â€” Grow Good Sell Smart</title>

  <!-- UI libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root{ --emerald:#10b981; --muted:#6b7280; --card:#ffffff; --bg:#f3f6f8; }
    html,body { height:100%; margin:0; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#0f172a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 6px 18px rgba(2,6,23,0.06); border: 1px solid rgba(15,23,42,0.04); }

    /* start screen */
    .start-bg { background-image: url('icons/bg-desktop.jpg'); background-size:cover; background-position:center; min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:40px 20px 80px 20px; }
    @media (max-width:768px){ .start-bg{ background-image:url('icons/bg-mobile.png'); } }

    .small-muted { color: var(--muted); font-size:13px; }
    .sidebar { width:280px; background:#fff; border-right:1px solid rgba(15,23,42,0.04); padding:20px; display:flex; flex-direction:column; gap:14px; height:calc(100vh - 40px); position:sticky; top:20px; }
    .sidebar .list { max-height:260px; overflow:auto; border:1px solid rgba(15,23,42,0.04); border-radius:8px; padding:6px; }
    .sidebar button.primary { background:var(--emerald); color:white; padding:10px; border-radius:8px; }
    .nav-tabs button.active { border-bottom:3px solid var(--emerald); color:var(--emerald); font-weight:600; }
    .snapshot-table { max-height:160px; overflow:auto; display:block; }
    .snapshot-table table { width:100%; border-collapse:collapse; }
    .snapshot-table td, .snapshot-table th { padding:8px; border-bottom:1px solid rgba(15,23,42,0.04); font-size:13px; }
    .recommend-card { border-radius:10px; padding:12px; border:1px solid rgba(16,185,129,0.08); background:linear-gradient(180deg, rgba(16,185,129,0.02), transparent); box-shadow: 0 6px 18px rgba(2,6,23,0.04); }
    .strategy-card { border-radius:10px; padding:14px; }
    .strategy-buy { background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; }
    .strategy-wait { background:#fff7ed; border:1px solid #fde68a; color:#92400e; }
    .strategy-sell { background:#fff1f2; border:1px solid #fecaca; color:#7f1d1d; }
    .top-recs { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px; }

    /* charts */
    .chart-card { height:360px; }
    .forecast-card { height:340px; }

    /* brand icon */
    .brand-icon { width:34px; height:34px; display:inline-block; vertical-align:middle; margin-right:10px; border-radius:8px; object-fit:cover; }
    .brand-title { display:inline-block; vertical-align:middle; line-height:1; }
    .brand-sub { display:block; font-size:13px; color:var(--muted); margin-top:4px; }

    /* commodity buttons styling */
    .commodity-btn { display:block; width:100%; text-align:left; padding:10px; border-radius:8px; background:transparent; border:none; font-size:16px; color:inherit; }
    .commodity-btn:hover { background:#f3f4f6; cursor:pointer; transition: background 120ms ease; }
    .commodity-btn.selected { background:var(--emerald); color:#fff; box-shadow:0 6px 12px rgba(16,185,129,0.12); }

    /* scrollbar styling for commodity list (bigger thumb) */
    #commodity-list::-webkit-scrollbar { width:12px; }
    #commodity-list::-webkit-scrollbar-track { background:transparent; }
    #commodity-list::-webkit-scrollbar-thumb { background: rgba(15,23,42,0.12); border-radius:8px; }

    /* mobile tweaks and sidebar overlay */
    @media (max-width:900px) {
      .sidebar { position:fixed; left:-340px; top:0; height:100vh; z-index:1200; box-shadow: 0 12px 40px rgba(2,6,23,0.2); transition:left 240ms ease; }
      body.sidebar-open .sidebar { left:0; }
      .main-wrap { padding:14px; }
      .card { padding:12px; border-radius:10px; }
      .chart-card { height:260px; }
      /* date inputs stacked */
      .date-stack { flex-direction:column; }
      .date-stack input { width:100%; }
      /* make commodity list thumb larger on mobile also */
      #commodity-list::-webkit-scrollbar { width:14px; }
    }

    /* sticky filter apply area */
    .filters-sticky { position:sticky; top:12px; }

    /* focus for date inputs */
    input[type="date"]:focus, select:focus { outline: 2px solid rgba(16,185,129,0.12); border-radius:6px; }
  </style>
</head>
<body>

  <!-- START SCREEN -->
  <div id="start-screen" class="start-bg">
    <div class="card" style="max-width:900px; width:100%; margin-top:24px;">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:12px">
          <img src="icons/Smartfarmher.png" alt="Smart FarmHer" class="brand-icon" />
          <div>
            <div class="brand-title" style="font-size:24px;font-weight:700;color:var(--emerald)">Smart FarmHer</div>
            <div class="brand-sub">Grow Good Sell Smart</div>
          </div>
        </div>
        <div>
          <button id="open-settings" class="small-muted" title="Help & Settings" style="background:none;border:none;color:var(--muted)"><i class="fas fa-ellipsis-v"></i></button>
        </div>
      </div>

      <div style="margin-top:18px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <input id="file-input" type="file" accept=".csv,.xlsx,.xls,text/csv" style="flex:1;padding:12px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/>
        <button id="start-analysis-btn" class="primary" style="padding:10px 18px; border:none; cursor:pointer;"><i class="fas fa-cloud-download-alt"></i> Load Preloaded Data</button>
        <button id="load-local-btn" style="padding:10px 18px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#111827;color:white;"><i class="fas fa-save"></i> Load Saved</button>
      </div>

      <div style="margin-top:8px" class="small-muted">Tip: import your CSV/XLSX file with market rows. Use saved data to keep it on your phone. Use "Load Preloaded Data" to fetch dataset hosted in repo.</div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main-dashboard" style="display:flex;min-height:100vh">
    <!-- Sidebar -->
    <aside class="sidebar filters-sticky" aria-label="Controls">
     
      <div>
        <label class="small-muted">Markets</label>
        <select id="market-select" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"></select>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="geo-locate" title="Detect my location" class="small-muted" style="padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#fff"><i class="fas fa-location-arrow"></i></button>
          <button id="manage-markets-btn" title="Manage markets" class="small-muted" style="padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#fff">Manage</button>
        </div>
      </div>

      <div>
        <label class="small-muted">Category</label>
        <select id="category-filter" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"><option>All</option></select>
      </div>

      <div>
        <label class="small-muted">Commodity</label>
        <div id="commodity-list" class="list" aria-label="Commodities list"></div>
      </div>

      <div>
        <label class="small-muted">Variety</label>
        <select id="variety-filter" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"><option>All</option></select>
      </div>

      <div>
        <label class="small-muted">Date range</label>
        <div class="date-stack" style="display:flex;gap:8px;margin-top:6px">
          <input id="start-date" type="date" placeholder="dd-mm-yyyy" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/>
          <input id="end-date" type="date" placeholder="dd-mm-yyyy" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="apply-filters" class="primary" style="flex:1;border:none">Apply</button>
        <button id="reset-filters" style="flex:1;border-radius:8px;border:1px solid rgba(15,23,42,0.06)">Reset</button>
      </div>

      <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px">
        <button id="add-record-btn" style="background:#2563eb;color:white;padding:10px;border-radius:8px;border:none"><i class="fas fa-plus"></i> Add Record</button>
        <button id="import-csv-btn" style="background:#111827;color:white;padding:10px;border-radius:8px;border:none"><i class="fas fa-file-import"></i> Import CSV/XLSX</button>
        <button id="export-all-btn" style="background:#eef2ff;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)"><i class="fas fa-file-export"></i> Export CSV</button>
        <button id="clear-storage-btn" style="background:#fff1f2;color:#9f1239;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)"><i class="fas fa-trash"></i> Clear Local Save</button>
      </div>
    </aside>

    <!-- Main area -->
    <div class="flex-1 main-wrap" style="padding:24px;">
      <header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
        <header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
  <div style="display:flex;align-items:center;gap:8px">
    <img src="icons/Smartfarmher.png" class="brand-icon" style="width:28px;height:28px"/>
    <div style="font-weight:700;color:var(--emerald);font-size:20px">Smart FarmHer</div>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <button id="show-help-btn" style="background:#f3f4f6;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)">Help</button>
  </div>
</header>

      <!-- tabs -->
      <div style="margin-bottom:16px" class="nav-tabs">
        <button id="tab-dashboard" class="active" style="background:none;border:none;padding:12px 10px;margin-right:6px">Dashboard</button>
        <button id="tab-prediction" style="background:none;border:none;padding:12px 10px;margin-right:6px">Predictive Analysis</button>
        <button id="tab-top-crops" style="background:none;border:none;padding:12px 10px">Top 10 Crops</button>
      </div>

      <!-- Dashboard content -->
      <div id="dashboard-content">
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 style="margin:0">Latest Market Snapshot <span id="snapshot-date" class="small-muted"></span></h3>
              <div class="small-muted" style="margin-top:4px">Latest day across markets</div>
            </div>
            <div class="small-muted">Rows: <span id="snapshot-count">0</span></div>
          </div>

          <div class="snapshot-table card" style="margin-top:12px; padding:0;">
            <table>
              <thead><tr><th style="text-align:left;padding:8px;background:#fbfdff">Market</th><th style="text-align:left;padding:8px;background:#fbfdff">Commodity</th><th style="text-align:left;padding:8px;background:#fbfdff">Variety</th><th style="text-align:right;padding:8px;background:#fbfdff">Modal</th><th style="text-align:right;padding:8px;background:#fbfdff">Min</th><th style="text-align:right;padding:8px;background:#fbfdff">Max</th><th style="text-align:center;padding:8px;background:#fbfdff">Trend</th></tr></thead>
              <tbody id="snapshot-table-body"><tr><td colspan="7" style="text-align:center;padding:12px;color:var(--muted)">No data loaded.</td></tr></tbody>
            </table>
          </div>
        </div>

        <div id="summary-cards" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px"></div>

        <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-bottom:12px">
          <div class="card chart-card">
            <h4 style="margin:0 0 10px 0">Historical Price Trends</h4>
            <canvas id="price-chart" style="width:100%;height:260px"></canvas>
          </div>

          <div class="card">
            <h4 style="margin:0 0 10px 0">7-day Weather (Selected Market)</h4>
            <div id="weather-container" class="small-muted">Add market coordinates or use location detection to view forecast.</div>
            <div style="margin-top:10px" class="small-muted">Weather provided by Open-Meteo (free)</div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4 style="margin:0">Detailed Price Data (last 20 rows)</h4>
            <button id="export-csv" style="background:#0f172a;color:white;padding:8px;border-radius:8px;border:none"><i class="fas fa-download"></i> Export CSV</button>
          </div>
          <div style="margin-top:12px; overflow:auto; max-height:320px">
            <table style="width:100%;border-collapse:collapse">
              <thead style="background:#fbfdff"><tr><th style="padding:10px;text-align:left">Date</th><th style="padding:10px">Market</th><th style="padding:10px">Commodity</th><th style="padding:10px">Variety</th><th style="padding:10px">Modal</th><th style="padding:10px">Min</th><th style="padding:10px">Max</th><th style="padding:10px">Trend</th></tr></thead>
              <tbody id="price-table-body"><tr><td colspan="8" style="padding:12px;color:var(--muted);text-align:center">No data</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Predictive Analysis -->
      <div id="prediction-content" class="hidden">
        <div class="card forecast-card" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">90-Day Price Forecast</h3>
          <div style="height:300px"><canvas id="forecast-chart" style="width:100%;height:100%"></canvas></div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
          <div id="strategy-signal-card" class="strategy-card strategy-wait card">
            <h4 style="margin:0">Strategic Signal</h4>
            <div id="strategy-signal" style="font-size:28px;font-weight:800;margin-top:8px">â€”</div>
            <div id="strategy-detail" class="small-muted" style="margin-top:8px">â€”</div>
          </div>

          <div class="strategy-card card">
            <h4 style="margin:0">Peak Profitability</h4>
            <div id="peak-month" style="font-size:28px;font-weight:700;margin-top:8px">â€”</div>
            <div class="small-muted" style="margin-top:8px">Historically best month</div>
          </div>
        </div>

        <div style="margin-top:12px" id="prediction-outlook"></div>
      </div>

      <!-- Top 10 Crops -->
      <div id="top-crops-content" class="hidden">
        <div class="card" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">Top Crop Recommendations</h3>
          <div id="top-crops-container" class="top-recs"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Add/Edit Modal (simple) -->
  <div id="modal-add-record" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:16px;z-index:50">
    <div class="card" style="max-width:720px;margin:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Add / Edit Record</h3>
        <button onclick="document.getElementById('modal-add-record').style.display='none'">âœ•</button>
      </div>
      <form id="record-form" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px">
        <div><label class="small-muted">Date</label><input id="rec-date" type="date" required style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Market</label><select id="rec-market" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></select></div>
        <div><label class="small-muted">Commodity</label><input id="rec-commodity" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Variety</label><input id="rec-variety" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Category</label><input id="rec-category" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">District</label><input id="rec-district" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Modal (â‚¹/kg)</label><input id="rec-modal" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Min (â‚¹/kg)</label><input id="rec-min" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Max (â‚¹/kg)</label><input id="rec-max" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>

        <div style="grid-column:1 / -1;display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button type="submit" style="background:var(--emerald);border:none;color:white;padding:8px 12px;border-radius:8px">Save</button>
          <button type="button" id="delete-record-btn" style="background:#fee2e2;border:1px solid #fca5a5;color:#9f1239;padding:8px;border-radius:8px">Delete</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* ===================
   Configuration
   =================== */
const PRELOADED_RAW_URL = 'https://raw.githubusercontent.com/chetankdrmz-max/Smart_FarmHer/refs/heads/main/data/Raw_Concatenated.csv';
const STORAGE_KEY = 'agri_dashboard_store_v1';
const IDB_DBNAME = 'agri_analyst_db_v1';
const IDB_STORE = 'store_v1';

/* In-memory */
let commodityRows = [];
let markets = [];
let filteredRows = [];
let currentCommodity = '';
let currentVariety = 'All';
let priceChart=null, forecastChart=null;

/* -----------------------
   IndexedDB helpers (unchanged)
   ----------------------- */
function openIDB(){ return new Promise((res,rej)=>{ const req=indexedDB.open(IDB_DBNAME,1); req.onupgradeneeded=e=>{ const db=e.target.result; if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE); }; req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); }); }
async function idbPut(k,v){ const db=await openIDB(); return new Promise((res,rej)=>{ const tx=db.transaction(IDB_STORE,'readwrite'); tx.objectStore(IDB_STORE).put(v,k); tx.oncomplete=()=>res(tr
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart FarmHer — Grow Good — Sell Smart</title>

  <!-- PWA manifest & theme -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10b981">

  <!-- UI libs (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f0f2f5; }
    .sidebar { -ms-overflow-style: none; scrollbar-width: none; }
    .sidebar::-webkit-scrollbar { display: none; }
    .sidebar-item.active { background-color: #10b981; color: white; }
    .chart-container { position: relative; height: 360px; width: 100%; }
    .tab-active { border-bottom-color: #10b981; color: #059669; font-weight:600; }
    /* Start-screen panel background blur to keep background image visible */
    .start-panel { background: rgba(255,255,255,0.85); backdrop-filter: blur(4px); }
    /* small responsive tweaks */
    @media (max-width:640px) {
      .sidebar { display:none; }
    }
  </style>
</head>
<body class="text-slate-800">

<!-- Background image (lightweight link) -->
<div style="position:fixed;inset:0;z-index:-1;background-image:url('https://images.unsplash.com/photo-1501004318641-b39e6451bec6?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=4d5f843b1f3fca8f2f3f6d08e3acb7f6');background-size:cover;background-position:center;filter:brightness(0.85);"></div>

<!-- START SCREEN -->
<div id="start-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-2xl text-center">
    <div class="start-panel p-8 rounded-2xl shadow-xl border border-slate-200">
      <!-- App title changed per your request -->
      <h1 class="text-3xl font-bold text-emerald-600 mb-1">
        <i class="fas fa-seedling mr-2"></i>Smart FarmHer
      </h1>
      <p class="text-slate-600 mb-4 font-semibold">Grow — Your Agricultural Intelligence Dashboard</p>

      <div class="space-y-3">
        <!-- file input for manual import -->
        <input id="file-input" type="file" accept=".csv,.xlsx,.xls,text/csv" class="w-full" />

        <!-- buttons -->
        <div class="flex gap-3">
          <button id="load-preloaded-btn" class="flex-1 bg-emerald-600 text-white font-bold py-3 rounded-lg">
            <i class="fas fa-cloud-download-alt mr-2"></i>Load Preloaded Data
          </button>
          <button id="load-saved-btn" class="bg-slate-700 text-white font-bold py-3 px-4 rounded-lg">
            <i class="fas fa-save mr-2"></i>Load Saved
          </button>
        </div>

        <p class="text-xs text-slate-400">Tip: use the file input to import your CSV / Excel anytime. Use "Load Saved" to restore previous data stored in your device.</p>
      </div>
    </div>
  </div>
</div>

<!-- MAIN DASHBOARD (hidden initially) -->
<div id="main-dashboard" class="hidden h-screen">
  <div class="flex h-full">
    <!-- Sidebar -->
    <aside class="w-72 bg-white border-r p-3 flex flex-col sidebar overflow-y-auto">
      <div class="h-14 flex items-center justify-center border-b mb-3">
        <h1 class="text-xl font-bold text-emerald-600"><i class="fas fa-seedling mr-2"></i>Smart FarmHer</h1>
      </div>

      <!-- Market selector -->
      <div class="mb-3">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-xs font-semibold text-slate-500 uppercase">Markets</h2>
          <button id="manage-markets-btn" title="Add / edit markets" class="text-xs text-slate-500 hover:text-slate-800"><i class="fas fa-map-marker-alt"></i></button>
        </div>
        <select id="market-select" class="w-full rounded-md p-2 border text-sm"></select>
        <div class="mt-2 text-xs text-slate-400">Select market to show weather & specific market prices</div>
      </div>

      <!-- Controls -->
      <div class="mb-3">
        <h2 class="text-xs font-semibold text-slate-500 uppercase mb-2">Filters</h2>
        <label class="text-xs">Category</label>
        <select id="category-filter" class="w-full rounded-md p-2 border text-sm mb-2"><option value="All">All</option></select>

        <label class="text-xs">Commodity</label>
        <div id="commodity-list" class="h-28 overflow-y-auto border rounded p-1 mb-2"></div>

        <label class="text-xs">Variety</label>
        <select id="variety-filter" class="w-full rounded-md p-2 border text-sm mb-2"></select>

        <label class="text-xs">Date range</label>
        <div class="flex gap-2">
          <input id="start-date" type="date" class="rounded-md p-2 border text-sm w-1/2" />
          <input id="end-date" type="date" class="rounded-md p-2 border text-sm w-1/2" />
        </div>

        <div class="flex gap-2 mt-3">
          <button id="apply-filters" class="flex-1 bg-emerald-600 text-white py-2 rounded-md">Apply</button>
          <button id="reset-filters" class="flex-1 bg-slate-200 py-2 rounded-md">Reset</button>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="mt-auto space-y-2">
        <button id="add-record-btn" class="w-full bg-blue-500 text-white py-2 rounded-md"><i class="fas fa-plus mr-2"></i>Add Record</button>
        <button id="import-csv-btn" class="w-full bg-slate-700 text-white py-2 rounded-md"><i class="fas fa-file-import mr-2"></i>Import CSV/XLSX</button>
        <button id="export-all-btn" class="w-full bg-slate-200 text-slate-800 py-2 rounded-md"><i class="fas fa-file-export mr-2"></i>Export CSV (All)</button>
        <button id="clear-storage-btn" class="w-full bg-red-50 text-red-600 py-2 rounded-md"><i class="fas fa-trash mr-2"></i>Clear Local Save</button>
        <div class="text-xs text-slate-400 mt-2">All edits save to your browser. Export before clearing storage.</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 overflow-y-auto bg-slate-100 p-6">
      <header class="flex items-center justify-between mb-6">
        <h2 id="main-header" class="text-2xl font-bold">Dashboard</h2>
        <div class="flex items-center gap-3">
          <button id="get-recommendations" class="bg-yellow-500 text-white py-2 px-4 rounded-md"><i class="fas fa-star mr-2"></i>Quick Recommendations</button>
          <button id="show-help-btn" class="bg-slate-200 py-2 px-4 rounded-md">Help</button>
        </div>
      </header>

      <!-- Tabs -->
      <div class="border-b mb-4">
        <nav class="flex gap-6">
          <button id="tab-dashboard" class="tab-active py-3 px-1 border-b-2 font-medium">Dashboard</button>
          <button id="tab-prediction" class="py-3 px-1 text-gray-500">Prediction & Weather</button>
          <button id="tab-top-crops" class="py-3 px-1 text-gray-500">Top 10 Crops</button>
        </nav>
      </div>

      <!-- Dashboard content (omitted for brevity in this view) -->
      <div id="dashboard-content">
        <!-- Snapshot and charts... -->
        <div class="bg-white p-4 rounded-lg shadow mb-4">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-semibold text-lg">Latest Market Snapshot <span id="snapshot-date" class="text-emerald-600"></span></h3>
              <p class="text-xs text-slate-500">Shows last available day across markets</p>
            </div>
            <div class="text-xs text-slate-500">Rows: <span id="snapshot-count">0</span></div>
          </div>

          <div class="overflow-x-auto mt-3">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-slate-600 bg-slate-50">
                <tr><th class="p-2">Market</th><th class="p-2">Commodity</th><th class="p-2">Variety</th><th class="p-2">Modal (₹/kg)</th><th class="p-2">Min</th><th class="p-2">Max</th></tr>
              </thead>
              <tbody id="snapshot-table-body"></tbody>
            </table>
          </div>
        </div>

        <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"></div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-4">
          <div class="lg:col-span-3 bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">Historical Price Trends</h4>
            <div class="chart-container"><canvas id="price-chart"></canvas></div>
          </div>
          <div class="lg:col-span-2 bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">Price Distribution</h4>
            <div class="chart-container"><canvas id="distribution-chart"></canvas></div>
          </div>
        </div>

        <div class="bg-white p-4 rounded shadow">
          <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold">Detailed Price Data (last 20 rows)</h4>
            <div class="text-xs text-slate-500">Click a row to edit</div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-slate-600 bg-slate-50">
                <tr><th class="p-2">Date</th><th class="p-2">Market</th><th class="p-2">Commodity</th><th class="p-2">Variety</th><th class="p-2">Modal</th><th class="p-2">Min</th><th class="p-2">Max</th></tr>
              </thead>
              <tbody id="price-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Prediction & Weather -->
      <div id="prediction-content" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2 bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">90-Day Forecast (Selected Commodity / Market)</h4>
            <div class="chart-container"><canvas id="forecast-chart"></canvas></div>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">7-day Weather (Selected Market)</h4>
            <div id="weather-container" class="space-y-2 text-sm text-slate-700"></div>
            <div class="mt-4 text-xs text-slate-500">Weather powered by Open-Meteo (free)</div>
          </div>
        </div>
        <div id="prediction-outlook" class="mt-4"></div>
      </div>

      <!-- Top crops content -->
      <div id="top-crops-content" class="hidden">
        <div class="bg-white p-4 rounded shadow mb-4">
          <h4 class="font-semibold">Top 10 Crops to Grow Next</h4>
          <p class="text-xs text-slate-500">Ranked by profitability score (avg price, trend, volatility)</p>
        </div>
        <div id="top-crops-container" class="space-y-2"></div>
        <!-- Grow sheet / videos area -->
        <div id="grow-sheet" class="mt-4 bg-white p-4 rounded shadow hidden">
          <h4 class="font-semibold">Grow Sheet</h4>
          <div id="grow-sheet-content" class="text-sm text-slate-700"></div>
          <div id="grow-videos" class="mt-3"></div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- MODALS (Add Record / Manage Markets / Recommendations) omitted in this snippet for brevity; your previous code can stay -->

<script>
/* =========================
   Configuration & Globals
   ========================= */
const PRELOADED_RAW_URL = 'https://raw.githubusercontent.com/chetankdrmz-max/Appuge/0d8156a2def60e731e41efb36b95b785a4e6d92b/data/Raw_Concatenated.xlsx';
/* If you prefer CSV version, you can point PRELOADED_RAW_URL to the CSV raw link instead. */

let commodityRows = []; // internal array of data rows
let markets = []; // market objects { name, lat, lon }
let commodityCategories = {}; // computed from data
let filteredData = [];
let currentCommodity = '';
let currentVariety = 'All';

/* DOM elements we need */
const el = {
  startScreen: document.getElementById('start-screen'),
  mainDashboard: document.getElementById('main-dashboard'),
  fileInput: document.getElementById('file-input'),
  loadPreloadedBtn: document.getElementById('load-preloaded-btn'),
  loadSavedBtn: document.getElementById('load-saved-btn'),
  marketSelect: document.getElementById('market-select'),
  categoryFilter: document.getElementById('category-filter'),
  commodityList: document.getElementById('commodity-list'),
  varietyFilter: document.getElementById('variety-filter'),
  startDate: document.getElementById('start-date'),
  endDate: document.getElementById('end-date'),
  snapshotDate: document.getElementById('snapshot-date'),
  snapshotTableBody: document.getElementById('snapshot-table-body'),
  snapshotCount: document.getElementById('snapshot-count'),
  priceTableBody: document.getElementById('price-table-body'),
  summaryCards: document.getElementById('summary-cards'),
  // ... add other needed elements as you had before
};

/* =========================
   CSV / XLSX loading helpers
   ========================= */

/* lightweight CSV fallback (handles basic quoting) */
function parseCSVFallback(text, { delimiter = ',', header = true } = {}) {
  const rows = [];
  let cur = '';
  let row = [];
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i+1];
    if (ch === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; } else { inQuotes = !inQuotes; }
      continue;
    }
    if (ch === delimiter && !inQuotes) { row.push(cur); cur = ''; continue; }
    if ((ch === '\n' || ch === '\r') && !inQuotes) {
      if (ch === '\r' && next === '\n') i++;
      row.push(cur);
      rows.push(row);
      row = [];
      cur = '';
      continue;
    }
    cur += ch;
  }
  if (cur !== '' || row.length > 0) { row.push(cur); rows.push(row); }
  if (!header) return rows;
  const headers = rows.shift().map(h => h.trim());
  return rows.map(r => {
    const obj = {};
    for (let i = 0; i < headers.length; i++) obj[headers[i]] = r[i] !== undefined ? r[i] : '';
    return obj;
  });
}

/* parse CSV text using Papa if available, otherwise fallback */
function parseCSVText(text) {
  if (typeof Papa !== 'undefined') {
    const res = Papa.parse(text, { header: true, skipEmptyLines: true });
    return res.data;
  } else {
    return parseCSVFallback(text, { header: true });
  }
}

/* parse XLSX arrayBuffer using SheetJS (XLSX global) */
function parseXLSXBuffer(buffer) {
  const wb = XLSX.read(buffer, { type: 'array' });
  // take the first sheet named with something meaningful (or the sheet named 'Sheet1')
  const sheetName = wb.SheetNames[0];
  const sheet = wb.Sheets[sheetName];
  const data = XLSX.utils.sheet_to_json(sheet, { defval: '' });
  return data;
}

/* load remote preloaded file (detect extension) */
async function loadPreloadedFromURL(url) {
  const response = await fetch(url);
  if (!response.ok) throw new Error('Network error while fetching preloaded file: ' + response.statusText);
  const contentType = response.headers.get('content-type') || '';
  if (url.toLowerCase().endsWith('.csv') || contentType.includes('text/csv')) {
    const txt = await response.text();
    return parseCSVText(txt);
  } else if (url.toLowerCase().endsWith('.xlsx') || contentType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') || url.toLowerCase().endsWith('.xls')) {
    const ab = await response.arrayBuffer();
    return parseXLSXBuffer(ab);
  } else {
    // try to guess by buffer
    const ab2 = await response.arrayBuffer();
    try {
      return parseXLSXBuffer(ab2);
    } catch (err) {
      // fallback to text
      const txt = new TextDecoder().decode(ab2);
      return parseCSVText(txt);
    }
  }
}

/* =========================
   Data normalization & UI
   ========================= */

/* convert raw row object into our canonical row shape */
function normalizeRow(raw) {
  // columns from your dataset: Date, Commodity, Variety, Market, District, Min_Price_Kg, Max_Price_Kg, Modal_Price_Kg, Source_Sheet (maybe)
  const dateVal = raw.Date || raw.date || raw.DATE;
  const commodity = String(raw.Commodity || raw.commodity || raw.COMMODITY || '').trim();
  const variety = String(raw.Variety || raw.variety || raw.VARIETY || '').trim();
  const market = String(raw.Market || raw.market || raw.MARKET || '').trim();
  const district = String(raw.District || raw.district || raw.DISTRICT || '').trim();
  const minPriceKg = parseFloat(raw.Min_Price_Kg || raw['Min_Price_Kg'] || raw.Min_Price || raw.min || 0) || 0;
  const maxPriceKg = parseFloat(raw.Max_Price_Kg || raw['Max_Price_Kg'] || raw.Max_Price || raw.max || 0) || 0;
  const modalPriceKg = parseFloat(raw.Modal_Price_Kg || raw['Modal_Price_Kg'] || raw.Modal_Price || raw.modal || 0) || 0;
  let parsedDate = new Date(dateVal);
  if (isNaN(parsedDate.getTime())) {
    // try dd-mm-yyyy or yyyy-mm-dd or Excel serial
    const s = String(dateVal).trim();
    if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)) parsedDate = new Date(s);
    else if (/^\d{4}-\d{2}-\d{2}/.test(s)) parsedDate = new Date(s);
    else parsedDate = new Date();
  }
  return {
    date: parsedDate,
    commodity,
    variety,
    market,
    district,
    minPriceKg,
    maxPriceKg,
    modalPriceKg
  };
}

/* load rows into commodityRows (overwrite) and refresh UI */
function loadRowsArray(rows) {
  commodityRows = rows.map(normalizeRow).filter(r => r.commodity && !isNaN(r.date.getTime()) && !isNaN(r.modalPriceKg));
  // derive categories from data (very simple rule: you can replace with your map)
  commodityCategories = {};
  commodityRows.forEach(r => {
    if (!commodityCategories[r.commodity]) {
      // simple heuristic - you may expand
      if (/apple|mango|grape|banana|orange|pineapple/i.test(r.commodity)) commodityCategories[r.commodity] = 'Fruit';
      else if (/tur|gram|dal|arhar|pulse|lentil/i.test(r.commodity)) commodityCategories[r.commodity] = 'Pulse';
      else commodityCategories[r.commodity] = 'Vegetable';
    }
  });
  // add a default market if none
  const firstMarket = commodityRows[0] && commodityRows[0].market;
  if (firstMarket && !markets.find(m => m.name === firstMarket)) {
    markets.push({ name: firstMarket, lat: null, lon: null });
  }
  refreshAllUI();
  // auto-save after load
  saveToLocal().catch(e => console.warn('Save failed after load', e));
}

/* =========================
   UI refresh functions (minimal examples)
   ========================= */
function refreshAllUI() {
  // show dashboard
  el.startScreen.classList.add('hidden');
  el.mainDashboard.classList.remove('hidden');

  // populate market select
  el.marketSelect.innerHTML = '';
  markets.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.name;
    opt.textContent = m.name;
    el.marketSelect.appendChild(opt);
  });

  // populate category filter
  el.categoryFilter.innerHTML = '<option value="All">All</option>';
  const cats = Array.from(new Set(Object.values(commodityCategories)));
  cats.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    el.categoryFilter.appendChild(opt);
  });

  // populate commodity list (respect category)
  populateCommodityList();

  // set default date range
  setDefaultDateRange();

  // update snapshot
  updateSnapshot();
}

/* populate commodity list according to selected category */
function populateCommodityList() {
  const cat = el.categoryFilter.value || 'All';
  const commodities = Array.from(new Set(commodityRows.filter(r => cat === 'All' || (commodityCategories[r.commodity] === cat)).map(r => r.commodity))).sort();
  el.commodityList.innerHTML = '';
  commodities.forEach((c, idx) => {
    const btn = document.createElement('button');
    btn.className = 'block w-full text-left p-2 text-sm hover:bg-slate-50 sidebar-item';
    btn.textContent = c;
    btn.onclick = () => {
      currentCommodity = c;
      document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      populateVarietyFilter();
      applyFilters();
    };
    el.commodityList.appendChild(btn);
    if (idx === 0) {
      btn.classList.add('active');
      currentCommodity = c;
    }
  });
  populateVarietyFilter();
}

/* populate variety select for current commodity */
function populateVarietyFilter() {
  const varieties = Array.from(new Set(commodityRows.filter(r => r.commodity === currentCommodity).map(r => r.variety))).sort();
  el.varietyFilter.innerHTML = '<option value="All">All</option>';
  varieties.forEach(v => {
    const opt = document.createElement('option'); opt.value = v; opt.textContent = v || '—';
    el.varietyFilter.appendChild(opt);
  });
  el.varietyFilter.value = 'All';
  currentVariety = 'All';
}

/* set default date range (last 1 year) */
function setDefaultDateRange() {
  if (!commodityRows.length) return;
  const dates = commodityRows.map(r => r.date.getTime());
  const max = new Date(Math.max(...dates));
  const min = new Date(Math.min(...dates));
  const start = new Date(max); start.setFullYear(start.getFullYear() - 1);
  el.endDate.value = max.toISOString().split('T')[0];
  el.startDate.value = (start < min ? min : start).toISOString().split('T')[0];
}

/* apply filters and update visible charts/tables (simplified) */
function applyFilters() {
  if (!currentCommodity) return;
  const s = new Date(el.startDate.value);
  const e = new Date(el.endDate.value);
  const variety = el.varietyFilter.value || 'All';
  filteredData = commodityRows.filter(r => {
    return r.commodity === currentCommodity &&
           (variety === 'All' || r.variety === variety) &&
           r.date >= s && r.date <= e;
  }).sort((a,b) => a.date - b.date);
  updateSnapshot();
  updateSummaryCards();
  updateDataTable();
  // charts omitted here; you can call updatePriceChart() etc.
}

/* update snapshot (latest date across markets) */
function updateSnapshot() {
  if (!commodityRows.length) {
    el.snapshotDate.textContent = '';
    el.snapshotTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-500">No data loaded.</td></tr>';
    el.snapshotCount.textContent = '0';
    return;
  }
  const dates = commodityRows.map(r => r.date.getTime());
  const latest = new Date(Math.max(...dates));
  el.snapshotDate.textContent = '(' + latest.toLocaleDateString() + ')';
  const snapshot = commodityRows.filter(r => r.date.toDateString() === latest.toDateString());
  el.snapshotCount.textContent = snapshot.length;
  el.snapshotTableBody.innerHTML = snapshot.map(r => `
    <tr class="border-b">
      <td class="p-2">${r.market||''}</td>
      <td class="p-2">${r.commodity}</td>
      <td class="p-2">${r.variety || ''}</td>
      <td class="p-2">₹${r.modalPriceKg.toFixed(2)}</td>
      <td class="p-2">₹${r.minPriceKg.toFixed(2)}</td>
      <td class="p-2">₹${r.maxPriceKg.toFixed(2)}</td>
    </tr>
  `).join('');
}

/* update simple summary cards (latest/avg/min/max) */
function updateSummaryCards() {
  if (!filteredData.length) {
    el.summaryCards.innerHTML = '<div class="col-span-full bg-white p-4 rounded">No data for selected filters</div>';
    return;
  }
  const latest = filteredData[filteredData.length - 1];
  const prices = filteredData.map(d => d.modalPriceKg);
  const avg = prices.reduce((a,b)=>a+b,0)/prices.length;
  const min = Math.min(...prices);
  const max = Math.max(...prices);
  el.summaryCards.innerHTML = `
    <div class="bg-white p-4 rounded shadow">
      <div class="text-sm text-slate-500">Latest Price</div>
      <div class="text-2xl font-bold">₹${latest.modalPriceKg.toFixed(2)}</div>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <div class="text-sm text-slate-500">Average Price</div>
      <div class="text-2xl font-bold">₹${avg.toFixed(2)}</div>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <div class="text-sm text-slate-500">Lowest</div>
      <div class="text-2xl font-bold">₹${min.toFixed(2)}</div>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <div class="text-sm text-slate-500">Highest</div>
      <div class="text-2xl font-bold">₹${max.toFixed(2)}</div>
    </div>
  `;
}

/* update data table (last 20 rows) */
function updateDataTable() {
  const rows = filteredData.slice(-20).reverse();
  el.priceTableBody.innerHTML = rows.map(r => `
    <tr class="border-b">
      <td class="p-2">${r.date.toLocaleDateString()}</td>
      <td class="p-2">${r.market||''}</td>
      <td class="p-2">${r.commodity}</td>
      <td class="p-2">${r.variety||''}</td>
      <td class="p-2">₹${r.modalPriceKg.toFixed(2)}</td>
      <td class="p-2">₹${r.minPriceKg.toFixed(2)}</td>
      <td class="p-2">₹${r.maxPriceKg.toFixed(2)}</td>
    </tr>
  `).join('');
}

/* =========================
   Storage: localStorage + IndexedDB fallback
   ========================= */
const STORAGE_KEY = 'agri_dashboard_store_v1';
const IDB_DBNAME = 'agri_analyst_db_v1';
const IDB_STORE = 'store';

function openIDB() {
  return new Promise((resolve,reject) => {
    const req = indexedDB.open(IDB_DBNAME,1);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE);
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbPut(key, value) {
  const db = await openIDB();
  return new Promise((resolve,reject) => {
    const tx = db.transaction(IDB_STORE, 'readwrite');
    tx.objectStore(IDB_STORE).put(value, key);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}
async function idbGet(key) {
  const db = await openIDB();
  return new Promise((resolve,reject) => {
    const tx = db.transaction(IDB_STORE,'readonly');
    const req = tx.objectStore(IDB_STORE).get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbDelete(key) {
  const db = await openIDB();
  return new Promise((resolve,reject) => {
    const tx = db.transaction(IDB_STORE,'readwrite');
    const req = tx.objectStore(IDB_STORE).delete(key);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

async function saveToLocal() {
  const storeObj = { rows: commodityRows, markets: markets };
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(storeObj));
    // if huge, migrate later
    return { method: 'localStorage' };
  } catch (err) {
    // fallback to IDB
    try {
      await idbPut(STORAGE_KEY, storeObj);
      return { method: 'indexedDB' };
    } catch (idbErr) {
      throw idbErr;
    }
  }
}

function loadFromLocal() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      commodityRows = parsed.rows || [];
      markets = parsed.markets || [];
      // rebuild categories quickly
      commodityCategories = {};
      commodityRows.forEach(r => commodityCategories[r.commodity] = commodityCategories[r.commodity] || 'Vegetable');
      refreshAllUI();
      return true;
    }
  } catch(e) { console.warn(e); }
  // async IDB fallback
  idbGet(STORAGE_KEY).then(obj => {
    if (obj) {
      commodityRows = obj.rows || [];
      markets = obj.markets || [];
      commodityCategories = {};
      commodityRows.forEach(r => commodityCategories[r.commodity] = commodityCategories[r.commodity] || 'Vegetable');
      refreshAllUI();
    }
  }).catch(err => console.warn('IDB load failed', err));
  return !!localStorage.getItem(STORAGE_KEY);
}

/* =========================
   Wire UI actions
   ========================= */

document.addEventListener('DOMContentLoaded', () => {
  // file input: import local file into app
  el.fileInput.addEventListener('change', async (evt) => {
    const file = evt.target.files && evt.target.files[0];
    if (!file) return;
    try {
      if (file.name.toLowerCase().endsWith('.csv')) {
        const txt = await file.text();
        const rows = parseCSVText(txt);
        loadRowsArray(rows);
      } else if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
        const ab = await file.arrayBuffer();
        const rows = parseXLSXBuffer(ab);
        loadRowsArray(rows);
      } else {
        // try to read as text and parse
        const txt = await file.text();
        const rows = parseCSVText(txt);
        loadRowsArray(rows);
      }
      alert('File imported successfully and loaded into the app.');
    } catch (err) {
      console.error('Import failed', err);
      alert('Failed to import file. See console for details.');
    }
  });

  // Load preloaded data from GitHub raw URL (auto-detect format)
  el.loadPreloadedBtn.addEventListener('click', async () => {
    try {
      el.loadPreloadedBtn.disabled = true;
      el.loadPreloadedBtn.textContent = 'Loading…';
      const rows = await loadPreloadedFromURL(PRELOADED_RAW_URL);
      loadRowsArray(rows);
      alert('Preloaded data loaded successfully.');
    } catch (err) {
      console.error('Preloaded load failed', err);
      alert('Failed to load preloaded data. See console for details.');
    } finally {
      el.loadPreloadedBtn.disabled = false;
      el.loadPreloadedBtn.innerHTML = '<i class="fas fa-cloud-download-alt mr-2"></i>Load Preloaded Data';
    }
  });

  // Load saved data from localStorage / IDB
  el.loadSavedBtn.addEventListener('click', () => {
    const ok = loadFromLocal();
    if (!ok) alert('No saved data found in localStorage. If you previously saved a large dataset the app will try IndexedDB (check console).');
  });

  // category change -> repopulate commodity list
  el.categoryFilter.addEventListener('change', populateCommodityList);

  // apply and reset filters
  document.getElementById('apply-filters').addEventListener('click', () => applyFilters());
  document.getElementById('reset-filters').addEventListener('click', () => {
    el.categoryFilter.value = 'All';
    populateCommodityList();
    setDefaultDateRange();
    applyFilters();
  });

  // load any saved automatically (non-blocking)
  loadFromLocal();
});

/* =========================
   End of script
   ========================= */
</script>
</body>
</html>

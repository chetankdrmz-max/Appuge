<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart FarmHer â€” Grow Good Sell Smart</title>

  <!-- UI libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root{ --emerald:#10b981; --muted:#6b7280; --card:#ffffff; --bg:#f3f6f8; }
    html,body { height:100%; margin:0; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#0f172a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 6px 18px rgba(2,6,23,0.06); border: 1px solid rgba(15,23,42,0.04); }
    .start-bg { background-image: url('icons/bg-desktop.jpg'); background-size:cover; background-position:center; min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:40px 20px 80px 20px; }
    @media (max-width:768px){ .start-bg{ background-image:url('icons/bg-mobile.png'); } }
    .small-muted { color: var(--muted); font-size:13px; }
    .sidebar { width:280px; background:#fff; border-right:1px solid rgba(15,23,42,0.04); padding:20px; display:flex; flex-direction:column; gap:14px; height:calc(100vh - 40px); position:sticky; top:20px; }
    .sidebar .list { max-height:260px; overflow:auto; border:1px solid rgba(15,23,42,0.04); border-radius:8px; padding:6px; }
    .nav-tabs button.active { border-bottom:3px solid var(--emerald); color:var(--emerald); font-weight:600; }
    .commodity-btn { display:block; width:100%; text-align:left; padding:10px; border-radius:8px; background:transparent; border:none; font-size:16px; color:inherit; }
    .commodity-btn:hover { background:#f3f4f6; cursor:pointer; transition: background 120ms ease; }
    .commodity-btn.selected { background:var(--emerald); color:#fff; box-shadow:0 6px 12px rgba(16,185,129,0.12); }
    #commodity-list::-webkit-scrollbar { width:12px; }
    #commodity-list::-webkit-scrollbar-thumb { background: rgba(15,23,42,0.12); border-radius:8px; }
    .chart-card { height:360px; }
    .forecast-card { height:340px; }
    .brand-icon { width:34px; height:34px; display:inline-block; vertical-align:middle; margin-right:10px; border-radius:8px; object-fit:cover; }
    .filters-sticky { position:sticky; top:12px; }
    @media (max-width:900px) {
      .sidebar { position:fixed; left:-340px; top:0; height:100vh; z-index:1200; box-shadow: 0 12px 40px rgba(2,6,23,0.2); transition:left 240ms ease; }
      body.sidebar-open .sidebar { left:0; }
      .main-wrap { padding:14px; }
      .date-stack { flex-direction:column; }
      .date-stack input { width:100%; }
      #commodity-list::-webkit-scrollbar { width:14px; }
    }
    input[type="date"]:focus, select:focus { outline: 2px solid rgba(16,185,129,0.12); border-radius:6px; }
    /* diagnostics area */
    #preload-diagnostics { margin-top:12px; font-family:monospace; font-size:12px; color:#7b1fa2; display:none; white-space:pre-wrap; background:#fff7; padding:10px; border-radius:6px; border:1px dashed rgba(15,23,42,0.06); }
  </style>
</head>
<body>

  <!-- START SCREEN -->
  <div id="start-screen" class="start-bg">
    <div class="card" style="max-width:900px; width:100%; margin-top:24px;">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:12px">
          <img src="icons/Smartfarmher.png" alt="Smart FarmHer" class="brand-icon" />
          <div>
            <div class="brand-title" style="font-size:24px;font-weight:700;color:var(--emerald)">Smart FarmHer</div>
            <div class="brand-sub">Grow Good Sell Smart</div>
          </div>
        </div>
      </div>

      <div style="margin-top:18px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <input id="file-input" type="file" accept=".csv,.xlsx,.xls,text/csv" style="flex:1;padding:12px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/>
        <button id="start-analysis-btn" class="primary" style="padding:10px 18px; border:none; cursor:pointer;"><i class="fas fa-cloud-download-alt"></i> Load Preloaded Data</button>
        <button id="load-local-btn" style="padding:10px 18px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#111827;color:white;"><i class="fas fa-save"></i> Load Saved</button>
      </div>

      <div style="margin-top:8px" class="small-muted">Tip: if preload fails we will try alternate routes and show a diagnostic message with details.</div>
      <div id="preload-diagnostics" aria-live="polite"></div>
    </div>
  </div>

  <!-- MAIN (kept unchanged except improved preload behavior in script) -->
  <div id="main-dashboard" style="display:flex;min-height:100vh">
    <aside class="sidebar filters-sticky" aria-label="Controls">
      <div>
        <label class="small-muted">Markets</label>
        <select id="market-select" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"></select>
      </div>

      <div>
        <label class="small-muted">Category</label>
        <select id="category-filter" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"><option>All</option></select>
      </div>

      <div>
        <label class="small-muted">Commodity</label>
        <div id="commodity-list" class="list" aria-label="Commodities list"></div>
      </div>

      <div>
        <label class="small-muted">Variety</label>
        <select id="variety-filter" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"><option>All</option></select>
      </div>

      <div>
        <label class="small-muted">Date range</label>
        <div class="date-stack" style="display:flex;gap:8px;margin-top:6px">
          <input id="start-date" type="date" placeholder="dd-mm-yyyy" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/>
          <input id="end-date" type="date" placeholder="dd-mm-yyyy" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="apply-filters" class="primary" style="flex:1;border:none">Apply</button>
        <button id="reset-filters" style="flex:1;border-radius:8px;border:1px solid rgba(15,23,42,0.06)">Reset</button>
      </div>

      <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px">
        <button id="import-csv-btn" style="background:#111827;color:white;padding:10px;border-radius:8px;border:none"><i class="fas fa-file-import"></i> Import CSV/XLSX</button>
        <button id="clear-storage-btn" style="background:#fff1f2;color:#9f1239;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)"><i class="fas fa-trash"></i> Clear Local Save</button>
      </div>
    </aside>

    <div class="flex-1 main-wrap" style="padding:24px;">
      <header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
        <div style="display:flex;align-items:center;gap:8px">
          <img src="icons/Smartfarmher.png" class="brand-icon" style="width:28px;height:28px"/>
          <div style="font-weight:700;color:var(--emerald);font-size:20px">Smart FarmHer</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button id="show-help-btn" style="background:#f3f4f6;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)">Help</button>
        </div>
      </header>

      <div style="margin-bottom:16px" class="nav-tabs">
        <button id="tab-dashboard" class="active" style="background:none;border:none;padding:12px 10px;margin-right:6px">Dashboard</button>
        <button id="tab-prediction" style="background:none;border:none;padding:12px 10px;margin-right:6px">Predictive Analysis</button>
        <button id="tab-top-crops" style="background:none;border:none;padding:12px 10px">Top 10 Crops</button>
      </div>

      <!-- Dashboard content (unchanged) -->
      <div id="dashboard-content">
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 style="margin:0">Latest Market Snapshot <span id="snapshot-date" class="small-muted"></span></h3>
              <div class="small-muted" style="margin-top:4px">Latest day across markets</div>
            </div>
            <div class="small-muted">Rows: <span id="snapshot-count">0</span></div>
          </div>
          <div class="snapshot-table card" style="margin-top:12px; padding:0;">
            <table>
              <thead><tr><th style="text-align:left;padding:8px;background:#fbfdff">Market</th><th style="text-align:left;padding:8px;background:#fbfdff">Commodity</th><th style="text-align:left;padding:8px;background:#fbfdff">Variety</th><th style="text-align:right;padding:8px;background:#fbfdff">Modal</th><th style="text-align:right;padding:8px;background:#fbfdff">Min</th><th style="text-align:right;padding:8px;background:#fbfdff">Max</th><th style="text-align:center;padding:8px;background:#fbfdff">Trend</th></tr></thead>
              <tbody id="snapshot-table-body"><tr><td colspan="7" style="text-align:center;padding:12px;color:var(--muted)">No data loaded.</td></tr></tbody>
            </table>
          </div>
        </div>

        <div id="summary-cards" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px"></div>

        <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-bottom:12px">
          <div class="card chart-card">
            <h4 style="margin:0 0 10px 0">Historical Price Trends</h4>
            <canvas id="price-chart" style="width:100%;height:260px"></canvas>
          </div>

          <div class="card">
            <h4 style="margin:0 0 10px 0">7-day Weather (Selected Market)</h4>
            <div id="weather-container" class="small-muted">Add market coordinates or use location detection to view forecast.</div>
            <div style="margin-top:10px" class="small-muted">Weather provided by Open-Meteo (free)</div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4 style="margin:0">Detailed Price Data (last 20 rows)</h4>
            <button id="export-csv" style="background:#0f172a;color:white;padding:8px;border-radius:8px;border:none"><i class="fas fa-download"></i> Export CSV</button>
          </div>
          <div style="margin-top:12px; overflow:auto; max-height:320px">
            <table style="width:100%;border-collapse:collapse">
              <thead style="background:#fbfdff"><tr><th style="padding:10px;text-align:left">Date</th><th style="padding:10px">Market</th><th style="padding:10px">Commodity</th><th style="padding:10px">Variety</th><th style="padding:10px">Modal</th><th style="padding:10px">Min</th><th style="padding:10px">Max</th><th style="padding:10px">Trend</th></tr></thead>
              <tbody id="price-table-body"><tr><td colspan="8" style="padding:12px;color:var(--muted);text-align:center">No data</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Predictive Analysis (unchanged) -->
      <div id="prediction-content" class="hidden">
        <div class="card forecast-card" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">90-Day Price Forecast</h3>
          <div style="height:300px"><canvas id="forecast-chart" style="width:100%;height:100%"></canvas></div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
          <div id="strategy-signal-card" class="strategy-card strategy-wait card">
            <h4 style="margin:0">Strategic Signal</h4>
            <div id="strategy-signal" style="font-size:28px;font-weight:800;margin-top:8px">â€”</div>
            <div id="strategy-detail" class="small-muted" style="margin-top:8px">â€”</div>
          </div>

          <div class="strategy-card card">
            <h4 style="margin:0">Peak Profitability</h4>
            <div id="peak-month" style="font-size:28px;font-weight:700;margin-top:8px">â€”</div>
            <div class="small-muted" style="margin-top:8px">Historically best month</div>
          </div>
        </div>

        <div style="margin-top:12px" id="prediction-outlook"></div>
      </div>

      <!-- Top 10 Crops -->
      <div id="top-crops-content" class="hidden">
        <div class="card" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">Top Crop Recommendations</h3>
          <div id="top-crops-container" class="top-recs"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Add/Edit Modal (unchanged) -->
  <div id="modal-add-record" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:16px;z-index:50">
    <div class="card" style="max-width:720px;margin:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Add / Edit Record</h3>
        <button onclick="document.getElementById('modal-add-record').style.display='none'">âœ•</button>
      </div>
      <form id="record-form" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px">
        <div><label class="small-muted">Date</label><input id="rec-date" type="date" required style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Market</label><select id="rec-market" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></select></div>
        <div><label class="small-muted">Commodity</label><input id="rec-commodity" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Variety</label><input id="rec-variety" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Category</label><input id="rec-category" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">District</label><input id="rec-district" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Modal (â‚¹/kg)</label><input id="rec-modal" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Min (â‚¹/kg)</label><input id="rec-min" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Max (â‚¹/kg)</label><input id="rec-max" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>

        <div style="grid-column:1 / -1;display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button type="submit" style="background:var(--emerald);border:none;color:white;padding:8px 12px;border-radius:8px">Save</button>
          <button type="button" id="delete-record-btn" style="background:#fee2e2;border:1px solid #fca5a5;color:#9f1239;padding:8px;border-radius:8px">Delete</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* ===================
   Config & state
   =================== */
const PRELOADED_RAW_URL = 'https://raw.githubusercontent.com/chetankdrmz-max/Smart_FarmHer/refs/heads/main/data/Raw_Concatenated.csv';
const STORAGE_KEY = 'agri_dashboard_store_v1';
let commodityRows = [], markets = [], filteredRows = [], currentCommodity = '', currentVariety='All';
let priceChart=null, forecastChart=null;

/* Minimal CSV fallback parser (kept small & robust) */
function parseCSVFallback(text,{delimiter=',',header=true}={}){ const rows=[]; let cur='',row=[],inQuotes=false; for(let i=0;i<text.length;i++){ const ch=text[i], next=text[i+1]; if(ch==='"'){ if(inQuotes && next==='"'){ cur+='"'; i++; } else { inQuotes=!inQuotes; } continue; } if(ch===delimiter && !inQuotes){ row.push(cur); cur=''; continue; } if((ch=='\n'||ch=='\r') && !inQuotes){ if(ch=='\r' && next=='\n') i++; row.push(cur); rows.push(row); row=[]; cur=''; continue; } cur+=ch; } if(cur!==''||row.length>0){ row.push(cur); rows.push(row);} if(!header) return rows; const headers=rows.shift().map(h=>h.trim()); return rows.map(r=>{ const obj={}; for(let i=0;i<headers.length;i++) obj[headers[i]] = r[i]!==undefined ? r[i] : ''; return obj; });}
function parseCSVText(text,options={header:true,skipEmptyLines:true}){ return new Promise((resolve)=>{ if(typeof Papa !== 'undefined'){ try{ const res = Papa.parse(text, Object.assign({}, options)); resolve(res.data); }catch(e){ resolve(parseCSVFallback(text,{header:options.header})); } } else { resolve(parseCSVFallback(text,{header:options.header})); } }); }

/* normalize rows */
function normalizeRow(r){
  const dateStr = r.Date || r.date || r.DATE || r['Date'] || '';
  const commodity = (r.Commodity || r.commodity || r.Item || r['Commodity'] || '').toString().trim();
  if(!commodity) return null;
  const variety = (r.Variety || r.variety || r.SubVariety || r['Variety'] || '').toString().trim() || 'Default';
  const market = (r.Market || r.market || r.MarketName || r['Market'] || '').toString().trim() || 'Default Market';
  const district = (r.District || r.district || r['District'] || '').toString().trim();
  const modal = parseFloat(r.Modal_Price_Kg || r.Modal_Price || r.modal || r.Modal_Price || r['Modal'] || 0) || 0;
  const minp = parseFloat(r.Min_Price_Kg || r.Min_Price || r.Min_Price_Q || r['Min'] || 0) || 0;
  const maxp = parseFloat(r.Max_Price_Kg || r.Max_Price || r.Max_Price_Q || r['Max'] || 0) || 0;
  const category = (r.Category || r.category || r['Category'] || '').toString().trim() || 'Other';
  const date = dateStr ? new Date(dateStr) : null;
  if(!(date instanceof Date) || isNaN(date.getTime())) return null;
  return { date, commodity, variety, market, district, modalPriceKg: modal, minPriceKg: minp, maxPriceKg: maxp, category };
}

/* Process parsed rows */
function processPreloadedData(rows){
  const parsed = rows.map(normalizeRow).filter(Boolean);
  if(!parsed.length){ showDiagnostics('Preloaded file parsed to 0 valid rows.'); alert('No valid rows found in preloaded file.'); return; }
  const foundMarkets = [...new Set(parsed.map(p=>p.market||'Default Market'))];
  if(markets.length === 0) markets = foundMarkets.map(n=>({name:n,lat:null,lon:null}));
  else foundMarkets.forEach(m=>{ if(!markets.find(x=>x.name===m)) markets.push({name:m,lat:null,lon:null}); });
  commodityRows = [...commodityRows, ...parsed];
  commodityRows.sort((a,b)=>new Date(a.date)-new Date(b.date));
  localStorage.setItem(STORAGE_KEY, JSON.stringify({rows:commodityRows, markets}));
  refreshAllUI();
}

/* =============
   DIAGNOSTICS
   ============= */
function showDiagnostics(text){
  const el = document.getElementById('preload-diagnostics');
  if(!el) return;
  el.style.display = text ? 'block' : 'none';
  el.textContent = text || '';
}

/* ===================
   IMPROVED PRELOAD HANDLER
   - tries: original URL -> github raw variant -> allorigins proxy
   - reports step-by-step progress to UI diagnostics (visible on start screen)
   =================== */
async function tryLoadPreloadedUrl(originalUrl){
  showDiagnostics('Starting preload attempts...\n');
  const attempts = [];
  // build candidate URLs
  const candidates = [originalUrl];

  // if URL looks like github blob convert to raw
  if(originalUrl.includes('github.com') && originalUrl.includes('/blob/')) {
    candidates.push(originalUrl.replace('github.com','raw.githubusercontent.com').replace('/blob/','/'));
  }

  // if URL includes '/refs/heads/' try remove it
  if(originalUrl.includes('/refs/heads/')) {
    candidates.push(originalUrl.replace('/refs/heads/','/'));
  }

  // Keep unique
  const uniq = [];
  candidates.forEach(u=>{ if(u && !uniq.includes(u)) uniq.push(u); });
  // Finally add AllOrigins proxy fallback for the original URL (CORS bypass)
  const proxyPrefix = 'https://api.allorigins.win/raw?url=';
  uniq.push(proxyPrefix + encodeURIComponent(originalUrl));

  // run through candidates
  let lastError = null;
  for(const url of uniq){
    showDiagnostics(prev => (typeof prev === 'string' ? prev : '') + `Attempting: ${url}\n`);
    try {
      const resp = await fetch(url, { method:'GET', mode: 'cors' });
      // handle non-2xx
      if(!resp.ok){
        lastError = `HTTP ${resp.status} ${resp.statusText} for ${url}`;
        showDiagnostics(prev => prev + ` -> HTTP ERROR: ${lastError}\n`);
        continue;
      }

      // determine type
      const contentType = (resp.headers.get('content-type') || '').toLowerCase();
      const blob = await resp.blob();
      let rows = [];
      if(contentType.includes('text') || url.toLowerCase().endsWith('.csv') || blob.type.includes('csv') || blob.type.startsWith('text')){
        const text = await blob.text();
        try {
          rows = await parseCSVText(text, {header:true, skipEmptyLines:true});
        } catch(e){
          rows = parseCSVFallback(text, {header:true});
        }
      } else {
        // try xlsx then fallback to text
        try {
          const ab = await blob.arrayBuffer();
          const wb = XLSX.read(ab, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        } catch(e){
          // fallback to text parsing
          const text = await blob.text();
          rows = await parseCSVText(text, {header:true, skipEmptyLines:true});
        }
      }

      if(rows && rows.length){
        showDiagnostics(prev => prev + `Success: parsed ${rows.length} rows from ${url}\n`);
        processPreloadedData(rows);
        // hide diagnostics after small delay
        setTimeout(()=>showDiagnostics(''), 4000);
        return true;
      } else {
        lastError = `Parsed to 0 rows from ${url}`;
        showDiagnostics(prev => prev + ` -> No rows parsed.\n`);
      }
    } catch(err){
      lastError = err && err.message ? err.message : String(err);
      showDiagnostics(prev => prev + ` -> Exception: ${lastError}\n`);
    }
  }

  // all failed
  showDiagnostics(prev => (typeof prev === 'string' ? prev : '') + `All attempts failed.\nLast error: ${lastError}\n\nTips:\n - If the file is hosted on GitHub, ensure you point to the RAW file URL (raw.githubusercontent.com/...).\n - If the host blocks CORS, the AllOrigins proxy was attempted but proxies may be rate-limited.\n - You can also download the CSV/XLSX and use the Import CSV button.\n\nPaste the diagnostics text when asking for help.`);
  alert('Preload failed. See diagnostics on the start screen (below the Load button) for details.');
  return false;
}

/* ===================
   Remaining UI helpers (trimmed/kept minimal)
   =================== */
function refreshAllUI(){
  populateMarketSelect(); populateCategoryFilter(); populateCommodityList(); populateVarietyFilter();
  setDefaultDateRange(); applyFilters(); updateSnapshotTable(); updateSummaryCards(); updatePriceChart(); updateDataTable();
  if(!document.getElementById('prediction-content').classList.contains('hidden')) computeForecastAndRender();
}
function populateMarketSelect(){ const sel=document.getElementById('market-select'); if(!sel) return; sel.innerHTML=''; markets.forEach(m=>{ const o=document.createElement('option'); o.value=m.name; o.textContent=m.name; sel.appendChild(o); }); if(markets.length===0){ markets.push({name:'Mysore (Bandipalya)', lat:12.2958, lon:76.6394}); populateMarketSelect(); } }
function populateCategoryFilter(){ const cats=[...new Set(commodityRows.map(r=>r.category||'Other'))].sort(); const sel=document.getElementById('category-filter'); if(!sel) return; sel.innerHTML='<option value="All">All</option>'; cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); }); }
function populateCommodityList(){ const container=document.getElementById('commodity-list'); if(!container) return; const selCat=(document.getElementById('category-filter')||{}).value || 'All'; const comms = [...new Set(commodityRows.filter(r => selCat==='All' || r.category===selCat).map(r=>r.commodity))].sort(); container.innerHTML=''; comms.forEach(c=>{ const btn=document.createElement('button'); btn.textContent=c; btn.className='commodity-btn'; btn.type='button'; btn.onclick=()=>{ currentCommodity=c; document.querySelectorAll('#commodity-list .commodity-btn').forEach(x=>x.classList.remove('selected')); btn.classList.add('selected'); populateVarietyFilter(); applyFilters(); }; container.appendChild(btn); }); if(!currentCommodity && comms.length){ currentCommodity = comms[0]; const first = container.querySelector('.commodity-btn'); if(first) first.classList.add('selected'); populateVarietyFilter(); } }
function populateVarietyFilter(){ const sel=document.getElementById('variety-filter'); if(!sel) return; const varieties=[...new Set(commodityRows.filter(r=>r.commodity===currentCommodity).map(r=>r.variety||'Default'))].sort(); sel.innerHTML='<option value="All">All</option>'; varieties.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); sel.value='All'; }
function setDefaultDateRange(){ if(!commodityRows.length) return; const dates=commodityRows.map(r=>new Date(r.date)); const maxDate=new Date(Math.max.apply(null, dates)); const minDate=new Date(Math.min.apply(null, dates)); const endEl=document.getElementById('end-date'), startEl=document.getElementById('start-date'); if(endEl) endEl.value = maxDate.toISOString().split('T')[0]; const startCandidate=new Date(maxDate); startCandidate.setFullYear(startCandidate.getFullYear()-1); if(startEl) startEl.value = (startCandidate < minDate ? minDate : startCandidate).toISOString().split('T')[0]; }
function applyFilters(){ const startVal=(document.getElementById('start-date')||{}).value; const endVal=(document.getElementById('end-date')||{}).value; const start=startVal?new Date(startVal):new Date('1970-01-01'); const end=endVal?new Date(endVal):new Date('2100-01-01'); const cat=(document.getElementById('category-filter')||{}).value || 'All'; currentVariety=(document.getElementById('variety-filter')||{}).value || 'All'; filteredRows = commodityRows.filter(r=> (cat==='All' || r.category===cat) && r.commodity===currentCommodity && (currentVariety==='All' || r.variety===currentVariety) && new Date(r.date) >= start && new Date(r.date) <= end).sort((a,b)=>new Date(a.date)-new Date(b.date)); updateDashboardUI(); }
function resetFilters(){ document.getElementById('category-filter').value='All'; currentCommodity=''; populateCommodityList(); setDefaultDateRange(); applyFilters(); }
function updateDashboardUI(){ document.getElementById('main-header')?.textContent = currentCommodity ? `${currentCommodity} Dashboard` : 'Dashboard'; updateSnapshotTable(); updateSummaryCards(); updatePriceChart(); updateDataTable(); renderWeatherForCurrentMarket(); if(!document.getElementById('prediction-content').classList.contains('hidden')) computeForecastAndRender(); }
function updateSnapshotTable(){ const body=document.getElementById('snapshot-table-body'); if(!body) return; if(!commodityRows.length){ body.innerHTML='<tr><td colspan="7" style="text-align:center;padding:12px;color:var(--muted)">No data loaded.</td></tr>'; return; } const dates=commodityRows.map(r=>new Date(r.date)); const latest=new Date(Math.max.apply(null, dates)); const latestStr=latest.toISOString().split('T')[0]; document.getElementById('snapshot-date').textContent=`(${latest.toLocaleDateString('en-GB')})`; const snapshot=commodityRows.filter(r=> (new Date(r.date)).toISOString().split('T')[0]===latestStr); document.getElementById('snapshot-count').textContent = snapshot.length; if(!snapshot.length){ body.innerHTML='<tr><td colspan="7" style="text-align:center;padding:12px;color:var(--muted)">No data for latest date.</td></tr>'; return; } body.innerHTML = snapshot.map(s=>`<tr><td style="padding:8px">${s.market}</td><td style="padding:8px">${s.commodity}</td><td style="padding:8px">${s.variety}</td><td style="padding:8px;text-align:right">â‚¹${s.modalPriceKg.toFixed(2)}</td><td style="padding:8px;text-align:right">â‚¹${s.minPriceKg.toFixed(2)}</td><td style="padding:8px;text-align:right">â‚¹${s.maxPriceKg.toFixed(2)}</td><td style="padding:8px;text-align:center">${trendSymbolForRow(s)}</td></tr>`).join(''); }
function trendSymbolForRow(r){ const rows = commodityRows.filter(x=>x.commodity===r.commodity && x.market===r.market).sort((a,b)=>new Date(a.date)-new Date(b.date)); const idx = rows.findIndex(x=>new Date(x.date).getTime()===new Date(r.date).getTime()); if(idx<=0) return 'â€”'; const prev = rows[idx-1].modalPriceKg; if(r.modalPriceKg > prev) return '<span style="color:#16a34a">â–²</span>'; if(r.modalPriceKg < prev) return '<span style="color:#ef4444">â–¼</span>'; return 'â€”'; }
function updateSummaryCards(){ const container=document.getElementById('summary-cards'); if(!container) return; if(!filteredRows.length){ container.innerHTML='<div class="card" style="text-align:center;color:var(--muted)">No data for selection</div>'; return; } const latest = filteredRows[filteredRows.length-1]; const prices = filteredRows.map(r=>r.modalPriceKg); const avg = prices.reduce((a,b)=>a+b,0)/prices.length; const minP=Math.min(...prices), maxP=Math.max(...prices); const cards = [{title:'Latest Price', value:`â‚¹${latest.modalPriceKg.toFixed(2)}`, sub: currentCommodity||''}, {title:'Average Price', value:`â‚¹${avg.toFixed(2)}`, sub:'Period Avg'}, {title:'Lowest Price', value:`â‚¹${minP.toFixed(2)}`, sub:'In Period'}, {title:'Highest Price', value:`â‚¹${maxP.toFixed(2)}`, sub:'In Period'}]; container.innerHTML = cards.map(c=>`<div class="card"><div style="color:var(--muted);font-size:13px">${c.title}</div><div style="font-weight:700;font-size:20px;margin-top:6px">${c.value}</div><div class="small-muted">${c.sub||''}</div></div>`).join(''); }

/* Charts (simple, respect filteredRows) */
function updatePriceChart(){ const el=document.getElementById('price-chart'); if(!el) return; const ctx=el.getContext('2d'); if(priceChart) priceChart.destroy(); if(!filteredRows.length){ ctx.clearRect(0,0,el.width, el.height); return; } const data = filteredRows.map(r=>({x:new Date(r.date), y:r.modalPriceKg})); priceChart = new Chart(ctx, { type:'line', data:{ datasets:[ { label:'Modal Price', data, borderColor:'rgb(34,197,94)', backgroundColor:'rgba(16,185,129,0.06)', fill:true, tension:0.25, pointRadius:2 } ] }, options:{ parsing:false, maintainAspectRatio:false, responsive:true, scales:{ x:{ type:'time', time:{ unit:'month' } }, y:{ beginAtZero:false } }, plugins:{ legend:{display:true} } } }); }
function computeSimpleForecast(series,days=90){ if(!series.length) return []; const prices = series.map(s=>s.y); const smooth=prices.map((v,i,arr)=>{ const w=5; const start=Math.max(0,i-w+1); const seg=arr.slice(start,i+1); return seg.reduce((a,b)=>a+b,0)/seg.length; }); const N=Math.min(60,smooth.length); const x=[], y=[]; for(let i=0;i<N;i++){ x.push(i); y.push(smooth[smooth.length-N+i]); } const xm=x.reduce((a,b)=>a+b,0)/x.length; const ym=y.reduce((a,b)=>a+b,0)/y.length; let num=0,den=0; for(let i=0;i<x.length;i++){ num+=(x[i]-xm)*(y[i]-ym); den+=(x[i]-xm)*(x[i]-xm); } const slope = den===0?0:num/den; const intercept = ym - slope*xm; const lastDate = new Date(series[series.length-1].date); const forecasts=[]; for(let d=1; d<=days; d++){ const pred = intercept + slope*(x.length-1 + d); forecasts.push({ date: new Date(lastDate.getTime() + 24*3600*1000*d), y: Math.max(0,pred)}); } return forecasts; }
function computeForecastAndRender(){ if(!filteredRows.length){ document.getElementById('strategy-signal').textContent='â€”'; return; } const series=filteredRows.map(r=>({date:new Date(r.date), y:r.modalPriceKg})); const forecast = computeSimpleForecast(series,90); const el=document.getElementById('forecast-chart'); if(!el) return; const ctx=el.getContext('2d'); if(forecastChart) forecastChart.destroy(); const dataHist = series.map(s=>({x:s.date, y:s.y})); const dataFc = forecast.map(f=>({x:f.date, y:f.y})); forecastChart = new Chart(ctx, { type:'line', data:{ datasets:[ { label:'Historical Price', data:dataHist, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.06)', fill:true, tension:0.25, pointRadius:0 }, { label:'Forecasted Price', data:dataFc, borderColor:'#ef4444', borderDash:[6,6], pointRadius:0, fill:false, tension:0.25 } ] }, options:{ parsing:false, maintainAspectRatio:false, responsive:true, scales:{ x:{ type:'time', time:{ unit:'month' } }, y:{ beginAtZero:false } }, plugins:{ legend:{display:true} } } }); /* simplified strategy */ const recent = series.slice(-90).map(s=>s.y); if(recent.length<30){ document.getElementById('strategy-signal').textContent='Not enough data'; document.getElementById('strategy-detail').textContent='Not enough historical data.'; document.getElementById('strategy-signal-card').className='strategy-card card'; document.getElementById('peak-month').textContent='â€”'; document.getElementById('prediction-outlook').innerHTML='<div class="card">Not enough historical data.</div>'; return; } const startAvg = recent.slice(0,7).reduce((a,b)=>a+b,0)/7; const endAvg = recent.slice(-7).reduce((a,b)=>a+b,0)/7; const pctChange = (endAvg - startAvg)/Math.max(1,startAvg); if(pctChange>0.08){ document.getElementById('strategy-signal').textContent='Grow Now'; document.getElementById('strategy-detail').textContent='Prices trending higher.'; document.getElementById('strategy-signal-card').className='strategy-card strategy-buy card'; } else if(pctChange < -0.05){ document.getElementById('strategy-signal').textContent='Wait'; document.getElementById('strategy-detail').textContent='Prices trending lower.'; document.getElementById('strategy-signal-card').className='strategy-card strategy-wait card'; } else { document.getElementById('strategy-signal').textContent='Consider'; document.getElementById('strategy-detail').textContent='Stable market.'; document.getElementById('strategy-signal-card').className='strategy-card card'; } const monthly={}; filteredRows.forEach(r=>{ const m=new Date(r.date).getMonth()+1; monthly[m]=monthly[m]||[]; monthly[m].push(r.modalPriceKg); }); const avgByMonth = Object.keys(monthly).map(k=>({m:parseInt(k), avg:monthly[k].reduce((a,b)=>a+b,0)/monthly[k].length})); if(avgByMonth.length){ const peak = avgByMonth.reduce((a,b)=>a.avg>b.avg?a:b); const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; document.getElementById('peak-month').textContent = months[peak.m-1]; } else document.getElementById('peak-month').textContent='â€”'; document.getElementById('prediction-outlook').innerHTML = `<div class="card"><strong>Forecast summary:</strong> 90-day outlook is ${(pctChange>0.08)?'positive':(pctChange<-0.05?'negative':'neutral')}. Average forecast price (30d): â‚¹${(forecast.slice(0,30).reduce((a,b)=>a+b.y,0)/Math.max(1,forecast.slice(0,30).length)).toFixed(2)}</div>`; }

/* Weather small helper (kept unchanged) */
async function renderWeatherForCurrentMarket(){ const sel=document.getElementById('market-select'); if(!sel) return; const market = markets.find(m=>m.name===sel.value); const container=document.getElementById('weather-container'); if(!container) return; if(!market || !market.lat || !market.lon){ container.innerHTML=`<div class="small-muted">No coordinates for "${sel.value}".</div>`; return; } try{ const url = `https://api.open-meteo.com/v1/forecast?latitude=${market.lat}&longitude=${market.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`; const res = await fetch(url); const json = await res.json(); if(!json.daily){ container.innerHTML='<div class="small-muted">Weather not available</div>'; return; } const days = json.daily.time.map((t,i)=>({date:t, max: json.daily.temperature_2m_max[i], min: json.daily.temperature_2m_min[i], precip: json.daily.precipitation_sum[i]})); container.innerHTML = days.map(d=>`<div style="margin-bottom:6px"><strong>${new Date(d.date).toLocaleDateString()}</strong>: ${d.max}Â°/${d.min}Â° - Rain ${d.precip} mm</div>`).join(''); }catch(e){ container.innerHTML='<div class="small-muted">Weather fetch error</div>'; console.warn(e); } }

/* File import & UI wiring */
async function handleFileImport(file){ if(!file) return; try{ const name=file.name.toLowerCase(); if(name.endsWith('.csv')||file.type.includes('text')){ const text = await file.text(); const rows = await parseCSVText(text,{header:true,skipEmptyLines:true}); processPreloadedData(rows); } else { const ab=await file.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); const sheet=wb.Sheets[wb.SheetNames[0]]; const rows=XLSX.utils.sheet_to_json(sheet,{defval:''}); processPreloadedData(rows); } alert('Imported successfully'); showDashboardAfterLoad(); }catch(e){ console.error(e); alert('Import failed: '+ e.message); } }

function showDashboardAfterLoad(){ document.getElementById('start-screen').style.display='none'; document.getElementById('main-dashboard').style.display='flex'; refreshAllUI(); window.scrollTo(0,0); }

/* DOM ready wiring */
document.addEventListener('DOMContentLoaded', ()=>{

  document.getElementById('start-screen').style.display='block';
  document.getElementById('main-dashboard').style.display='none';

  // start-analysis: use improved loader with fallbacks
  document.getElementById('start-analysis-btn')?.addEventListener('click', async ()=>{
    showDiagnostics(''); // clear
    const ok = await tryLoadPreloadedUrl(PRELOADED_RAW_URL);
    if(ok) showDashboardAfterLoad();
  });

  document.getElementById('load-local-btn')?.addEventListener('click', ()=>{ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw){ const parsed=JSON.parse(raw); commodityRows=parsed.rows||[]; markets=parsed.markets||[]; refreshAllUI(); showDashboardAfterLoad(); } else { alert('No saved data in localStorage'); } }catch(e){ alert('Load saved failed'); } });

  document.getElementById('file-input')?.addEventListener('change', ev=>handleFileImport(ev.target.files[0]));
  document.getElementById('import-csv-btn')?.addEventListener('click', ()=>document.getElementById('file-input').click());
  document.getElementById('apply-filters')?.addEventListener('click', applyFilters);
  document.getElementById('reset-filters')?.addEventListener('click', resetFilters);
  document.getElementById('export-csv')?.addEventListener('click', ()=>{ if(!filteredRows.length){ alert('No visible rows'); return; } const rows = filteredRows.map(r=>[new Date(r.date).toISOString().split('T')[0], r.market, r.commodity, r.variety, r.minPriceKg, r.maxPriceKg, r.modalPriceKg]); const csv = ['Date,Market,Commodity,Variety,Min,Max,Modal', ...rows.map(r=>r.join(','))].join('\n'); const link=document.createElement('a'); link.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); link.download='export_filtered.csv'; document.body.appendChild(link); link.click(); link.remove(); });
  document.getElementById('clear-storage-btn')?.addEventListener('click', ()=>{ if(confirm('Clear saved data?')){ localStorage.removeItem(STORAGE_KEY); commodityRows=[]; markets=[]; refreshAllUI(); alert('Cleared'); } });

  // tabs
  document.getElementById('tab-dashboard')?.addEventListener('click', ()=>{ document.getElementById('dashboard-content').classList.remove('hidden'); document.getElementById('prediction-content').classList.add('hidden'); document.getElementById('top-crops-content').classList.add('hidden'); document.querySelectorAll('.nav-tabs button').forEach(b=>b.classList.remove('active')); document.getElementById('tab-dashboard').classList.add('active'); });
  document.getElementById('tab-prediction')?.addEventListener('click', ()=>{ document.getElementById('dashboard-content').classList.add('hidden'); document.getElementById('prediction-content').classList.remove('hidden'); document.getElementById('top-crops-content').classList.add('hidden'); document.querySelectorAll('.nav-tabs button').forEach(b=>b.classList.remove('active')); document.getElementById('tab-prediction').classList.add('active'); computeForecastAndRender(); });
  document.getElementById('tab-top-crops')?.addEventListener('click', ()=>{ document.getElementById('dashboard-content').classList.add('hidden'); document.getElementById('prediction-content').classList.add('hidden'); document.getElementById('top-crops-content').classList.remove('hidden'); document.querySelectorAll('.nav-tabs button').forEach(b=>b.classList.remove('active')); document.getElementById('tab-top-crops').classList.add('active'); });

  // date change auto-filter
  document.getElementById('start-date')?.addEventListener('change', applyFilters);
  document.getElementById('end-date')?.addEventListener('change', applyFilters);
  document.getElementById('category-filter')?.addEventListener('change', ()=>{ populateCommodityList(); applyFilters(); });
  document.getElementById('variety-filter')?.addEventListener('change', applyFilters);

  // mobile sidebar: clicking outside closes
  document.addEventListener('click', (ev)=>{ if(window.innerWidth>900) return; const sidebar = document.querySelector('.sidebar'); if(!sidebar) return; if(document.body.classList.contains('sidebar-open') && !sidebar.contains(ev.target)){ document.body.classList.remove('sidebar-open'); } });

  // try to load local save quietly (do NOT auto-open dashboard)
  try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ const parsed = JSON.parse(raw); commodityRows = parsed.rows || []; markets = parsed.markets || []; refreshAllUI(); } }catch(e){}
});

/* Small helper: open modal for add record (kept minimal) */
function openAddModal(){ document.getElementById('modal-add-record').style.display='flex'; document.getElementById('delete-record-btn').style.display='none'; document.getElementById('rec-market').innerHTML = markets.map(m=>`<option value="${m.name}">${m.name}</option>`).join(''); document.getElementById('record-form').onsubmit = (e)=>{ e.preventDefault(); const newRow = { date: new Date(document.getElementById('rec-date').value), market: document.getElementById('rec-market').value, commodity: document.getElementById('rec-commodity').value, variety: document.getElementById('rec-variety').value || 'Default', category: document.getElementById('rec-category').value || 'Other', district: document.getElementById('rec-district').value || '', modalPriceKg: parseFloat(document.getElementById('rec-modal').value) || 0, minPriceKg: parseFloat(document.getElementById('rec-min').value) || 0, maxPriceKg: parseFloat(document.getElementById('rec-max').value) || 0 }; commodityRows.push(newRow); commodityRows.sort((a,b)=>new Date(a.date)-new Date(b.date)); localStorage.setItem(STORAGE_KEY, JSON.stringify({rows:commodityRows, markets})); document.getElementById('modal-add-record').style.display='none'; refreshAllUI(); } }
</script>
</body>
</html>
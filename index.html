<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart FarmHer â€” Grow Good Sell Smart</title>

  <!-- UI libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; margin:0; background:#f3f6f8; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(2,6,23,0.06); }
    .brand-icon { width:34px; height:34px; margin-right:10px; vertical-align:middle; }
    .commodity-btn { display:block; padding:8px; border-radius:8px; width:100%; text-align:left; }
    .commodity-btn:hover { background:#f3f4f6; }
    .commodity-btn.selected { background:#10b981; color:#fff; }
    #commodity-list::-webkit-scrollbar { width:12px; }
    #commodity-list::-webkit-scrollbar-thumb { background:rgba(15,23,42,0.2); border-radius:8px; }
    .nav-tabs button.active { color:#10b981; border-bottom:2px solid #10b981; }
    .chart-card { height:320px; }
  </style>
</head>
<body>

<!-- START SCREEN -->
<div id="start-screen" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f0fdfa">
  <div class="card" style="max-width:600px;width:100%;text-align:center">
    <div style="display:flex;align-items:center;justify-content:center;margin-bottom:16px">
      <img src="icons/Smartfarmher.png" alt="Smart FarmHer" class="brand-icon">
      <h1 style="font-size:24px;font-weight:700;color:#10b981;margin:0">Smart FarmHer</h1>
    </div>
    <p style="color:#6b7280;margin-bottom:16px">Grow Good Sell Smart</p>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
      <input id="file-input" type="file" accept=".csv,.xlsx" style="padding:8px;border:1px solid #ccc;border-radius:6px">
      <button id="start-analysis-btn" style="background:#10b981;color:#fff;padding:10px 16px;border-radius:6px;border:none;cursor:pointer">
        <i class="fas fa-cloud-download-alt"></i> Load Preloaded Data
      </button>
      <button id="load-local-btn" style="background:#111827;color:#fff;padding:10px 16px;border-radius:6px;border:none;cursor:pointer">
        <i class="fas fa-save"></i> Load Saved
      </button>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="main-dashboard" style="display:none;min-height:100vh">
  <!-- Sidebar -->
  <aside class="sidebar" style="width:260px;background:#fff;padding:16px;border-right:1px solid #eee">
    <h3 style="margin:0 0 10px 0">Filters</h3>
    <label>Market</label>
    <select id="market-select" style="width:100%;margin-bottom:10px"></select>
    <label>Category</label>
    <select id="category-filter" style="width:100%;margin-bottom:10px"><option>All</option></select>
    <label>Commodity</label>
    <div id="commodity-list" style="max-height:180px;overflow:auto;margin-bottom:10px"></div>
    <label>Variety</label>
    <select id="variety-filter" style="width:100%;margin-bottom:10px"><option>All</option></select>
    <label>Date range</label>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px">
      <input id="start-date" type="date">
      <input id="end-date" type="date">
    </div>
    <button id="apply-filters" style="background:#10b981;color:#fff;width:100%;padding:8px;border:none;border-radius:6px">Apply</button>
  </aside>

  <!-- Main -->
  <main style="flex:1;padding:20px">
    <div class="nav-tabs" style="margin-bottom:20px">
      <button id="tab-dashboard" class="active" style="margin-right:8px">Dashboard</button>
      <button id="tab-prediction" style="margin-right:8px">Predictive Analysis</button>
      <button id="tab-top-crops">Top 10 Crops</button>
    </div>

    <div id="dashboard-content">
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin:0 0 10px 0">Historical Price Trends</h3>
        <canvas id="price-chart"></canvas>
      </div>
    </div>

    <div id="prediction-content" style="display:none">
      <div class="card chart-card" style="margin-bottom:20px">
        <h3>90-Day Price Forecast</h3>
        <canvas id="forecast-chart"></canvas>
      </div>
    </div>

    <div id="top-crops-content" style="display:none">
      <div class="card">
        <h3>Top Crop Recommendations</h3>
        <div id="top-crops-container"></div>
      </div>
    </div>
  </main>
</div>

<script>
const PRELOADED_RAW_URL = 'https://github.com/chetankdrmz-max/Smart_FarmHer/blob/main/data%2FRaw_Concatenated.csv';

let commodityRows = [];
let currentCommodity = '';
let currentVariety = 'All';
let filteredRows = [];
let priceChart=null, forecastChart=null;

function parseCSVFallback(text){
  const lines=text.trim().split(/\r?\n/);
  const headers=lines.shift().split(',');
  return lines.map(l=>{
    const parts=l.split(',');
    const obj={};
    headers.forEach((h,i)=>obj[h]=parts[i]);
    return obj;
  });
}

function normalizeRow(r){
  return {
    date: new Date(r.Date||r.date),
    commodity: r.Commodity||'',
    variety: r.Variety||'Default',
    market: r.Market||'Default',
    modalPriceKg: parseFloat(r.Modal)||0
  };
}

function processPreloadedData(rows){
  commodityRows = rows.map(normalizeRow).filter(r=>r.date && !isNaN(r.date));
  refreshAllUI();
}

function refreshAllUI(){
  applyFilters();
}

function applyFilters(){
  const start=new Date(document.getElementById('start-date').value||'1970-01-01');
  const end=new Date(document.getElementById('end-date').value||'2100-01-01');
  filteredRows = commodityRows.filter(r=>r.date>=start && r.date<=end && (!currentCommodity || r.commodity===currentCommodity));
  updatePriceChart();
}

function updatePriceChart(){
  const ctx=document.getElementById('price-chart').getContext('2d');
  if(priceChart) priceChart.destroy();
  const data=filteredRows.map(r=>({x:r.date,y:r.modalPriceKg}));
  priceChart=new Chart(ctx,{type:'line',data:{datasets:[{label:'Price',data,borderColor:'#10b981'}]},options:{parsing:false,scales:{x:{type:'time',time:{unit:'month'}}}}});
}

function showDashboardAfterLoad(){
  document.getElementById('start-screen').style.display='none';
  document.getElementById('main-dashboard').style.display='flex';
  refreshAllUI();
}

document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('start-analysis-btn').addEventListener('click',async()=>{
    try{
      const resp=await fetch(PRELOADED_RAW_URL);
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const text=await resp.text();
      const rows=parseCSVFallback(text);
      processPreloadedData(rows);
      showDashboardAfterLoad();
    }catch(e){
      console.error(e);
      alert('Preload failed: '+e.message);
    }
  });
});
</script>
</body>
</html>
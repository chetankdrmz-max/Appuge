<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart FarmHer — Grow Good Sell Smart</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10b981">

  <!-- UI libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root{
      --emerald:#10b981;
      --muted:#6b7280;
      --bg:#f3f6f8;
      --card:#ffffff;
      --accent:#059669;
      --danger:#ef4444;
    }
    html,body{height:100%}
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: #0f172a;
      margin:0;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent;
    }

    /* Start screen background images */
    .start-bg {
      background-image: url('icons/bg-desktop.jpg');
      background-size: cover;
      background-position: center;
      min-height: 100vh;
      display:flex;
      align-items:flex-start; /* top placement */
      justify-content:center;
      padding: 36px 20px;
    }
    @media (max-width:768px){
      .start-bg{ background-image: url('icons/bg-mobile.png'); padding-top: 18px; }
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.06);
      border: 1px solid rgba(15,23,42,0.04);
    }

    /* ✅ Icon updated */
    .brand-icon { 
      width:31px; 
      height:31px; 
      display:inline-block; 
      vertical-align:middle; 
      margin-right:8px; 
      object-fit:contain;
    }

    /* Sidebar */
    .sidebar {
      min-width:260px; max-width:320px; background: #fff;
      border-right:1px solid rgba(15,23,42,0.04); padding:16px; display:flex; flex-direction:column; gap:12px;
      height:100vh; overflow:auto;
    }
    .list { max-height:240px; overflow:auto; border-radius:8px; padding:6px; border:1px solid rgba(15,23,42,0.04); }
    .commodity-btn {
      width:100%; text-align:left; padding:10px 8px; border-radius:8px; background:transparent; border:none; display:block;
      transition: background .14s, transform .08s;
    }
    .commodity-btn:hover{ background:#f3f4f6; transform: translateY(-2px); }
    .commodity-btn.selected{ background: linear-gradient(90deg, rgba(16,185,129,0.12), rgba(16,185,129,0.02)); border-left:4px solid var(--emerald); font-weight:700; color:var(--emerald); }

    .nav-tabs button.active { border-bottom:3px solid var(--emerald); color:var(--emerald); font-weight:600; }

    .snapshot-table { max-height:160px; overflow:auto; display:block; }
    .snapshot-table table { width:100%; border-collapse:collapse; }
    .snapshot-table td, .snapshot-table th { padding:8px; border-bottom:1px solid rgba(15,23,42,0.04); font-size:13px; }

    .btn { padding:10px 14px; border-radius:8px; cursor:pointer; border:none; display:inline-flex; align-items:center; gap:8px; }
    .btn-primary { background:var(--emerald); color:white; }
    .btn-dark { background:#111827; color:white; }

    .recommend-card { border-radius:10px; padding:12px; border:1px solid rgba(16,185,129,0.08); background:linear-gradient(180deg, rgba(16,185,129,0.02), transparent); }

    .strategy-card { border-radius:10px; padding:14px; }

    .trend-up { color: #10b981; font-weight:700; }
    .trend-down { color: #ef4444; font-weight:700; }

    @media (max-width:900px) {
      .sidebar { display:none; }
      .main-wrap { padding:14px; }
    }

    .small-muted { color: var(--muted); font-size:13px; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

  <!-- START SCREEN (unchanged UI, icon now bigger) -->
  ... [UNCHANGED HTML CONTENT ABOVE YOUR DASHBOARD] ...

<script>
/* ===================
   Config & memory
   =================== */
const PRELOADED_RAW_URL = 'https://raw.githubusercontent.com/chetankdrmz-max/Smart_FarmHer/refs/heads/main/data/Raw_Concatenated.csv';
const STORAGE_KEY = 'agri_dashboard_store_v2';

/* ✅ Helper to canonicalize GitHub raw URL */
function canonicalizeGithubRawUrl(url){
  return url.includes('/refs/heads/') ? url.replace('/refs/heads/','/') : url;
}

/* ✅ Helper to fetch & parse */
async function fetchAndParseData(url){
  const resp = await fetch(url);
  if(!resp.ok) throw new Error(`Fetch failed: ${resp.status}`);
  const contentType = resp.headers.get('content-type') || '';
  const blob = await resp.blob();

  if(contentType.includes('text') || url.toLowerCase().endsWith('.csv')){
    const text = await blob.text();
    return await parseCSVText(text, {header:true, skipEmptyLines:true});
  } else {
    const ab = await blob.arrayBuffer();
    const wb = XLSX.read(ab, { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(sheet, { defval: '' });
  }
}

/* -------------------------
   Startup wiring (updated preload)
   ------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  loadCropDefaults();

  document.getElementById('start-screen').classList.remove('hidden');
  document.getElementById('main-dashboard').classList.add('hidden');

  document.getElementById('start-analysis-btn')?.addEventListener('click', async ()=> {
    const urls = [PRELOADED_RAW_URL, canonicalizeGithubRawUrl(PRELOADED_RAW_URL)];
    let loaded = false;
    for(const url of urls){
      try{
        console.log('Trying preload URL:', url);
        const rows = await fetchAndParseData(url);
        processPreloadedData(rows);
        setTimeout(()=> showDashboardAfterLoad(), 250);
        loaded = true;
        break;
      }catch(e){
        console.warn('Failed at', url, e);
      }
    }
    if(!loaded) alert('Preload failed. Tried both URLs, see console for details.');
  });

  // ✅ Other handlers unchanged
  document.getElementById('load-local-btn')?.addEventListener('click', ()=>{ if(loadFromLocalSync()) showDashboardAfterLoad(); else alert('No saved data found.'); });
  document.getElementById('file-input')?.addEventListener('change', ev=>handleFileImport(ev.target.files[0]));
  document.getElementById('import-csv-btn')?.addEventListener('click', ()=>document.getElementById('file-input').click());
  document.getElementById('apply-filters')?.addEventListener('click', applyFilters);
  document.getElementById('reset-filters')?.addEventListener('click', resetFilters);
  document.getElementById('add-record-btn')?.addEventListener('click', openAddModal);
  document.getElementById('export-all-btn')?.addEventListener('click', exportAllCSV);
  document.getElementById('clear-storage-btn')?.addEventListener('click', clearLocal);
  document.getElementById('get-recommendations')?.addEventListener('click', ()=>{ generateTopCropsUI(); document.getElementById('tab-top-crops').click(); });
  document.getElementById('tab-dashboard')?.addEventListener('click', ()=> showTab('dashboard'));
  document.getElementById('tab-prediction')?.addEventListener('click', ()=> showTab('prediction'));
  document.getElementById('tab-top-crops')?.addEventListener('click', ()=> showTab('top-crops'));
  document.getElementById('market-select')?.addEventListener('change', renderWeatherForCurrentMarket);
  document.getElementById('export-csv')?.addEventListener('click', exportFilteredCSV);
  document.getElementById('geo-locate')?.addEventListener('click', ()=>{ if(!navigator.geolocation){ alert('Geolocation not supported'); return; } navigator.geolocation.getCurrentPosition(pos=>{ const lat=pos.coords.latitude, lon=pos.coords.longitude; const name=`My Location (${lat.toFixed(3)},${lon.toFixed(3)})`; markets.unshift({name,lat,lon}); saveToLocal(); populateMarketSelect(); document.getElementById('market-select').value=name; renderWeatherForCurrentMarket(); alert('Location saved.'); }); });
});
</script>

<!-- service worker registration unchanged -->
<script>
if ('serviceWorker' in navigator) {
  const base = location.pathname.startsWith('/Smart_FarmHer') ? '/Smart_FarmHer' : '';
  const swPath = base + '/service-worker.js';
  navigator.serviceWorker.register(swPath, { scope: base || '/' }).then(reg=> console.log('Service worker registered', reg)).catch(err=>console.warn('SW registration failed', err));
}
</script>

</body>
</html>

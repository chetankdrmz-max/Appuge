<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart FarmHer — Grow Good Sell Smart</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10b981">

  <!-- UI libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root{
      --emerald:#10b981;
      --muted:#6b7280;
      --bg:#f3f6f8;
      --card:#ffffff;
      --accent:#059669;
      --danger:#ef4444;
    }
    html,body{height:100%}
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: #0f172a;
      margin:0;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent;
    }

    /* Start screen background images */
    .start-bg {
      background-image: url('icons/bg-desktop.jpg');
      background-size: cover;
      background-position: center;
      min-height: 100vh;
      display:flex;
      align-items:flex-start; /* moved top as requested */
      justify-content:center;
      padding: 36px 20px;
    }
    @media (max-width:768px){
      .start-bg{ background-image: url('icons/bg-mobile.png'); padding-top: 18px; }
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.06);
      border: 1px solid rgba(15,23,42,0.04);
    }

    /* Header icon */
    .brand-icon { width:28px;height:28px; display:inline-block; vertical-align:middle; margin-right:8px; }

    /* Sidebar */
    .sidebar {
      min-width:260px; max-width:320px; background: #fff;
      border-right:1px solid rgba(15,23,42,0.04); padding:16px; display:flex; flex-direction:column; gap:12px;
      height:100vh; overflow:auto;
    }
    .list { max-height:240px; overflow:auto; border-radius:8px; padding:6px; border:1px solid rgba(15,23,42,0.04); }
    .commodity-btn {
      width:100%; text-align:left; padding:10px 8px; border-radius:8px; background:transparent; border:none; display:block;
      transition: background .14s, transform .08s;
    }
    .commodity-btn:hover{ background:#f3f4f6; transform: translateY(-2px); }
    .commodity-btn.selected{ background: linear-gradient(90deg, rgba(16,185,129,0.12), rgba(16,185,129,0.02)); border-left:4px solid var(--emerald); font-weight:700; color:var(--emerald); }

    /* Tabs active */
    .nav-tabs button.active { border-bottom:3px solid var(--emerald); color:var(--emerald); font-weight:600; }

    /* Snapshot small scrollable table */
    .snapshot-table { max-height:160px; overflow:auto; display:block; }
    .snapshot-table table { width:100%; border-collapse:collapse; }
    .snapshot-table td, .snapshot-table th { padding:8px; border-bottom:1px solid rgba(15,23,42,0.04); font-size:13px; }

    /* Buttons */
    .btn { padding:10px 14px; border-radius:8px; cursor:pointer; border:none; display:inline-flex; align-items:center; gap:8px; }
    .btn-primary { background:var(--emerald); color:white; }
    .btn-dark { background:#111827; color:white; }

    /* Recommendation card */
    .recommend-card { border-radius:10px; padding:12px; border:1px solid rgba(16,185,129,0.08); background:linear-gradient(180deg, rgba(16,185,129,0.02), transparent); }

    /* Strategy tiles */
    .strategy-card { border-radius:10px; padding:14px; }

    /* Trend arrows */
    .trend-up { color: #10b981; font-weight:700; }
    .trend-down { color: #ef4444; font-weight:700; }

    /* Mobile */
    @media (max-width:900px) {
      .sidebar { display:none; }
      .main-wrap { padding:14px; }
    }

    /* Tiny utility */
    .small-muted { color: var(--muted); font-size:13px; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

  <!-- START SCREEN: moved panel to top via align-items:flex-start -->
  <div id="start-screen" class="start-bg">
    <div style="width:100%;max-width:980px;">
      <div class="card" style="display:flex;align-items:center;gap:16px;">
        <img src="icons/Smartfarmher.png" alt="SmartFarmHer" class="brand-icon" onerror="this.style.display='none'"/>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
            <div>
              <div style="font-size:20px;font-weight:700;color:var(--emerald)">Smart FarmHer</div>
              <div style="font-weight:600;color:#374151">Grow Good — Sell Smart</div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="open-settings" class="small-muted" title="Help & Settings" style="background:none;border:none;color:var(--muted)"><i class="fas fa-ellipsis-v"></i></button>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
            <input id="file-input" type="file" accept=".csv,.xlsx,.xls,text/csv" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/>
            <button id="start-analysis-btn" class="btn btn-primary"><i class="fas fa-cloud-download-alt"></i> Load Preloaded Data</button>
            <button id="load-local-btn" class="btn btn-dark"><i class="fas fa-save"></i> Load Saved</button>
          </div>

          <div style="margin-top:8px" class="small-muted">Tip: import your CSV/XLSX file anytime. "Load Preloaded Data" fetches the dataset hosted in repo. Data stays on your device.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN (hidden until data loaded) -->
  <div id="main-dashboard" class="hidden" style="display:flex;min-height:100vh">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Sidebar">
      <div style="display:flex;align-items:center;gap:8px">
        <img src="icons/Smartfarmher.png" alt="logo" class="brand-icon" onerror="this.style.display='none'"/>
        <div style="font-weight:700;color:var(--emerald)">Smart FarmHer</div>
      </div>

      <div>
        <label class="small-muted">Markets</label>
        <select id="market-select" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"></select>
        <div style="margin-top:6px;display:flex;gap:8px">
          <button id="geo-locate" title="Detect my location" class="small-muted" style="padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#fff"><i class="fas fa-location-arrow"></i></button>
          <button id="manage-markets-btn" title="Manage markets" class="small-muted" style="padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#fff">Manage</button>
        </div>
      </div>

      <div>
        <label class="small-muted">Category</label>
        <select id="category-filter" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"><option>All</option></select>
      </div>

      <div>
        <label class="small-muted">Commodity</label>
        <div id="commodity-list" class="list" aria-live="polite"></div>
      </div>

      <div>
        <label class="small-muted">Variety</label>
        <select id="variety-filter" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"><option>All</option></select>
      </div>

      <div>
        <label class="small-muted">Date range</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="start-date" type="date" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/>
          <input id="end-date" type="date" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="apply-filters" class="btn btn-primary" style="flex:1">Apply</button>
        <button id="reset-filters" class="btn" style="flex:1;background:#fff;border:1px solid rgba(15,23,42,0.06)">Reset</button>
      </div>

      <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px">
        <button id="add-record-btn" class="btn" style="background:#2563eb;color:white;padding:10px;border-radius:8px;border:none"><i class="fas fa-plus"></i> Add Record</button>
        <button id="import-csv-btn" class="btn btn-dark"><i class="fas fa-file-import"></i> Import CSV/XLSX</button>
        <button id="export-all-btn" class="btn" style="background:#eef2ff;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)"><i class="fas fa-file-export"></i> Export CSV</button>
        <button id="clear-storage-btn" class="btn" style="background:#fff1f2;color:#9f1239;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)"><i class="fas fa-trash"></i> Clear Local Save</button>
      </div>
    </aside>

    <!-- Main content -->
    <div class="flex-1 main-wrap" style="padding:24px;">
      <header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
        <div>
          <h2 id="main-header" style="margin:0;font-size:22px;font-weight:700">Dashboard</h2>
          <div class="small-muted">Quick market insights & crop recommendations</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button id="get-recommendations" class="btn" style="background:#f59e0b;color:white"><i class="fas fa-lightbulb"></i> Get Recommendations</button>
          <button id="show-help-btn" class="btn" style="background:#f3f4f6;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)">Help</button>
        </div>
      </header>

      <!-- tabs -->
      <div style="margin-bottom:16px" class="nav-tabs" role="tablist">
        <button id="tab-dashboard" class="active" style="background:none;border:none;padding:12px 10px;margin-right:6px" role="tab" aria-selected="true">Dashboard</button>
        <button id="tab-prediction" style="background:none;border:none;padding:12px 10px;margin-right:6px" role="tab">Predictive Analysis</button>
        <button id="tab-top-crops" style="background:none;border:none;padding:12px 10px" role="tab">Top 10 Crops</button>
      </div>

      <!-- Dashboard content -->
      <div id="dashboard-content">
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 style="margin:0">Latest Market Snapshot <span id="snapshot-date" class="small-muted"></span></h3>
              <div class="small-muted" style="margin-top:4px">Latest day across markets</div>
            </div>
            <div class="small-muted">Rows: <span id="snapshot-count">0</span></div>
          </div>

          <div class="snapshot-table card" style="margin-top:12px; padding:0;">
            <table>
              <thead><tr><th style="text-align:left;padding:8px;background:#fbfdff">Market</th><th style="text-align:left;padding:8px;background:#fbfdff">Commodity</th><th style="text-align:left;padding:8px;background:#fbfdff">Variety</th><th style="text-align:right;padding:8px;background:#fbfdff">Modal</th><th style="text-align:right;padding:8px;background:#fbfdff">Min</th><th style="text-align:right;padding:8px;background:#fbfdff">Max</th></tr></thead>
              <tbody id="snapshot-table-body"><tr><td colspan="6" style="text-align:center;padding:12px;color:var(--muted)">No data loaded.</td></tr></tbody>
            </table>
          </div>
        </div>

        <div id="summary-cards" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px"></div>

        <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-bottom:12px">
          <div class="card" style="height:360px">
            <h4 style="margin:0 0 10px 0">Historical Price Trends</h4>
            <canvas id="price-chart" style="width:100%;height:calc(100% - 38px)"></canvas>
          </div>

          <div class="card">
            <h4 style="margin:0 0 10px 0">7-day Weather (Selected Market)</h4>
            <div id="weather-container" class="small-muted">Add market coordinates or use location detection to view forecast.</div>
            <div style="margin-top:10px" class="small-muted">Weather: Open-Meteo</div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4 style="margin:0">Detailed Price Data (last 20 rows)</h4>
            <button id="export-csv" class="btn" style="background:#0f172a;color:white;padding:8px;border-radius:8px;border:none"><i class="fas fa-download"></i> Export CSV</button>
          </div>
          <div style="margin-top:12px; overflow:auto; max-height:320px">
            <table style="width:100%;border-collapse:collapse">
              <thead style="background:#fbfdff"><tr><th style="padding:10px;text-align:left">Date</th><th style="padding:10px">Market</th><th style="padding:10px">Commodity</th><th style="padding:10px">Variety</th><th style="padding:10px">Modal</th><th style="padding:10px">Min</th><th style="padding:10px">Max</th><th style="padding:10px">Trend</th></tr></thead>
              <tbody id="price-table-body"><tr><td colspan="8" style="padding:12px;color:var(--muted);text-align:center">No data</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Predictive Analysis -->
      <div id="prediction-content" class="hidden">
        <div class="card" style="margin-bottom:12px; display:flex; gap:12px; align-items:center;">
          <div style="flex:1">
            <h3 style="margin:0 0 8px 0">Short-term Price Forecast (90 days)</h3>
            <canvas id="forecast-chart" style="width:100%;height:220px"></canvas>
          </div>
          <div style="width:300px">
            <div class="strategy-card strategy-wait card" id="strategy-tile" style="margin-bottom:12px">
              <h4 style="margin:0">Strategic Outlook</h4>
              <div id="strategy-signal" style="font-size:22px;font-weight:800;margin-top:8px">—</div>
              <div id="strategy-detail" class="small-muted" style="margin-top:8px">—</div>
            </div>

            <div class="card" style="padding:12px">
              <div><strong>Prediction 1:</strong><div id="pred1" class="small-muted" style="margin-top:6px">—</div></div>
              <div style="margin-top:10px"><strong>Prediction 2:</strong><div id="pred2" class="small-muted" style="margin-top:6px">—</div></div>
            </div>
          </div>
        </div>

        <div id="prediction-outlook"></div>
      </div>

      <!-- Top 10 Crops -->
      <div id="top-crops-content" class="hidden">
        <div class="card" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">Top Crop Recommendations (Category-wise)</h3>
          <div id="top-crops-container" class="top-recs" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px"></div>
        </div>

        <!-- Edit crop defaults modal anchor -->
        <div id="grow-sheet" class="card"></div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal-add-record" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:16px;z-index:50">
    <div class="card" style="max-width:720px;margin:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Add / Edit Record</h3>
        <button onclick="document.getElementById('modal-add-record').style.display='none'">✕</button>
      </div>
      <form id="record-form" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px">
        <div><label class="small-muted">Date</label><input id="rec-date" type="date" required style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Market</label><select id="rec-market" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></select></div>
        <div><label class="small-muted">Commodity</label><input id="rec-commodity" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Variety</label><input id="rec-variety" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Category</label><input id="rec-category" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">District</label><input id="rec-district" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Modal (₹/kg)</label><input id="rec-modal" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Min (₹/kg)</label><input id="rec-min" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Max (₹/kg)</label><input id="rec-max" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>

        <div style="grid-column:1 / -1;display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" id="delete-record-btn" class="btn" style="background:#fee2e2;border:1px solid #fca5a5;color:#9f1239">Delete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit crop defaults modal -->
  <div id="modal-edit-crop-defaults" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:16px;z-index:60">
    <div class="card" style="max-width:520px;margin:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Edit Crop Defaults</h3>
        <button onclick="document.getElementById('modal-edit-crop-defaults').style.display='none'">✕</button>
      </div>
      <div style="margin-top:10px">
        <label class="small-muted">Crop</label>
        <select id="edit-crop-select" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"></select>
        <div style="display:flex;gap:8px;margin-top:10px">
          <div style="flex:1"><label class="small-muted">Expected yield per hectare (kg)</label><input id="edit-yield" type="number" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/></div>
          <div style="flex:1"><label class="small-muted">Area (ha)</label><input id="edit-area" type="number" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"/></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="save-crop-defaults" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===================
   Configuration & Data
   =================== */

/* Use the raw CSV URL from your repo (raw.githubusercontent) */
const PRELOADED_RAW_URL = 'https://raw.githubusercontent.com/chetankdrmz-max/Smart_FarmHer/refs/heads/main/data/Raw_Concatenated.csv';

/* Storage keys */
const STORAGE_KEY = 'agri_dashboard_store_v2';

/* In-memory */
let commodityRows = []; // normalized rows
let markets = []; // {name, lat, lon}
let filteredRows = [];
let currentCommodity = '';
let currentVariety = 'All';

let priceChart = null, forecastChart = null;

/* Small embedded crop_meta map (durations in days, default yield kg/ha) */
const CROP_META = {
  "Beans": { durationDays: 60, defaultYieldKgPerHa: 1500, category: "Vegetable" },
  "Water Melon": { durationDays: 90, defaultYieldKgPerHa: 20000, category: "Fruit" },
  "Apple": { durationDays: 365, defaultYieldKgPerHa: 20000, category: "Fruit" },
  "Tomato": { durationDays: 120, defaultYieldKgPerHa: 40000, category: "Vegetable" },
  "Onion": { durationDays: 120, defaultYieldKgPerHa: 25000, category: "Vegetable" },
  "Potato": { durationDays: 120, defaultYieldKgPerHa: 30000, category: "Vegetable" },
  "Carrot": { durationDays: 100, defaultYieldKgPerHa: 25000, category: "Vegetable" },
  // fallback default
  "_default": { durationDays: 120, defaultYieldKgPerHa: 10000, category: "Other" }
};

/* User-editable defaults saved in localStorage */
let cropDefaults = {}; // { cropName: { yieldKgPerHa, areaHa } }
function loadCropDefaults(){ try{ const r = localStorage.getItem('crop_defaults_v1'); if(r){ cropDefaults = JSON.parse(r);} }catch(e){cropDefaults={};} }
function saveCropDefaults(){ try{ localStorage.setItem('crop_defaults_v1', JSON.stringify(cropDefaults)); }catch(e){console.warn(e);} }

/* -------------------------
   Helpers: parse CSV robustly
   ------------------------- */
function parseCSVFallback(text,{delimiter=',',header=true}={}) {
  const rows = [];
  let cur='', row=[], inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], next=text[i+1];
    if(ch==='"'){
      if(inQuotes && next==='"'){ cur+='"'; i++; } else { inQuotes=!inQuotes; }
      continue;
    }
    if(ch===delimiter && !inQuotes){ row.push(cur); cur=''; continue; }
    if((ch==='\n'||ch==='\r') && !inQuotes){
      if(ch==='r' && next==='n') i++;
      row.push(cur); rows.push(row); row=[]; cur=''; continue;
    }
    cur+=ch;
  }
  if(cur!==''||row.length>0){ row.push(cur); rows.push(row); }
  if(!header) return rows;
  const headers = rows.shift().map(h=>h.trim());
  return rows.map(r=>{
    const obj={};
    for(let i=0;i<headers.length;i++) obj[headers[i]] = r[i] !== undefined ? r[i] : '';
    return obj;
  });
}
function parseCSVText(text, options={header:true,skipEmptyLines:true}){
  return new Promise((resolve)=>{
    if(typeof Papa !== 'undefined'){
      try{
        const res = Papa.parse(text, Object.assign({}, options));
        resolve(res.data);
      }catch(e){
        resolve(parseCSVFallback(text,{header:options.header}));
      }
    } else {
      resolve(parseCSVFallback(text,{header:options.header}));
    }
  });
}

/* -------------------------
   Normalize rows to consistent shape
   ------------------------- */
function normalizeRow(r){
  const dateStr = r.Date || r.date || r.DATE || r['Date '] || '';
  const commodity = (r.Commodity || r.commodity || r.Item || '').toString().trim();
  const variety = (r.Variety || r.variety || r.SubVariety || '').toString().trim() || 'Default';
  const market = (r.Market || r.market || r.MarketName || '').toString().trim() || 'Default Market';
  const district = (r.District || r.district || '').toString().trim();
  const modal = parseFloat(r.Modal_Price_Kg || r.Modal_Price || r.modal || r.Modal_Price_Kg || r.Modal_Price_Q || 0) || 0;
  const minp = parseFloat(r.Min_Price_Kg || r.Min_Price || r.Min_Price_Q || 0) || 0;
  const maxp = parseFloat(r.Max_Price_Kg || r.Max_Price || r.Max_Price_Q || 0) || 0;
  const category = (r.Category || r.category || '').toString().trim() || (CROP_META[commodity] ? CROP_META[commodity].category : 'Other');
  const date = dateStr ? new Date(dateStr) : null;
  return { date, commodity, variety, market, district, modalPriceKg: modal, minPriceKg: minp, maxPriceKg: maxp, category };
}

/* -------------------------
   Process uploaded / preloaded data
   ------------------------- */
function processPreloadedData(rows){
  const parsed = rows.map(normalizeRow).filter(item => item && item.date instanceof Date && !isNaN(item.date.getTime()) && item.commodity);
  if(!parsed.length) {
    alert('No valid rows found in file.');
    return;
  }
  // Add markets found
  const foundMarkets = [...new Set(parsed.map(p => p.market || 'Default Market'))];
  foundMarkets.forEach(m => {
    if(!markets.find(x=>x.name===m)) markets.push({ name: m, lat: null, lon: null });
  });
  // merge and dedupe by exact keys (date+commodity+market+variety)
  const key = r => `${new Date(r.date).toISOString()}|${r.commodity}|${r.market}|${r.variety}`;
  const existingMap = {};
  commodityRows.forEach(r => existingMap[key(r)] = r);
  parsed.forEach(r => existingMap[key(r)] = r);
  commodityRows = Object.values(existingMap).sort((a,b)=>new Date(a.date)-new Date(b.date));
  saveToLocal();
  refreshAllUI();
}

/* -------------------------
   Persistence (localStorage)
   ------------------------- */
function saveToLocal(){
  try{
    const store = { rows: commodityRows, markets, cropDefaults };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
  }catch(e){ console.warn('save error', e); }
}
function loadFromLocalSync(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      commodityRows = parsed.rows || [];
      markets = parsed.markets || [];
      cropDefaults = parsed.cropDefaults || {};
      loadCropDefaults();
      refreshAllUI();
      return true;
    }
  }catch(e){ console.warn('load error', e); }
  return false;
}
function clearLocal(){
  if(!confirm('Clear all saved data from this browser?')) return;
  try{ localStorage.removeItem(STORAGE_KEY); localStorage.removeItem('crop_defaults_v1'); }catch(e){}
  commodityRows=[]; markets=[]; cropDefaults={}; refreshAllUI(); alert('Cleared.');
}

/* -------------------------
   UI: populate helpers
   ------------------------- */
function populateMarketSelect(){
  const sel = document.getElementById('market-select'); if(!sel) return;
  sel.innerHTML = '';
  markets.forEach(m=>{ const o=document.createElement('option'); o.value = m.name; o.textContent = m.name; sel.appendChild(o); });
  if(markets.length===0){ markets.push({ name: 'Mysore (Bandipalya)', lat: 12.2958, lon: 76.6394 }); populateMarketSelect(); }
}

function populateCategoryFilter(){
  const cats = [...new Set(commodityRows.map(r=>r.category || 'Other'))].sort();
  const sel = document.getElementById('category-filter'); if(!sel) return;
  sel.innerHTML = '<option value="All">All</option>';
  cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent = c; sel.appendChild(o); });
}

function populateCommodityList(){
  const container = document.getElementById('commodity-list'); if(!container) return;
  const selCat = (document.getElementById('category-filter')||{}).value || 'All';
  const comms = [...new Set(commodityRows.filter(r => selCat==='All' || r.category===selCat).map(r=>r.commodity))].sort();
  container.innerHTML = '';
  comms.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'commodity-btn';
    btn.textContent = c;
    btn.onclick = () => {
      currentCommodity = c;
      // highlight visually
      Array.from(container.querySelectorAll('button')).forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      populateVarietyFilter();
      applyFilters();
    };
    container.appendChild(btn);
  });
  // select first by default if none selected
  if(!currentCommodity && comms.length){
    currentCommodity = comms[0];
    container.querySelector('button')?.classList.add('selected');
    populateVarietyFilter();
  }
}

function populateVarietyFilter(){
  const sel = document.getElementById('variety-filter'); if(!sel) return;
  const varieties = [...new Set(commodityRows.filter(r=>r.commodity===currentCommodity).map(r=>r.variety || 'Default'))].sort();
  sel.innerHTML = '<option value="All">All</option>';
  varieties.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  sel.value = 'All';
}

/* -------------------------
   Date range and filters
   ------------------------- */
function setDefaultDateRange(){
  if(!commodityRows.length) return;
  const dates = commodityRows.map(r=>new Date(r.date));
  const maxDate = new Date(Math.max.apply(null, dates));
  const minDate = new Date(Math.min.apply(null, dates));
  const endEl = document.getElementById('end-date'); const startEl = document.getElementById('start-date');
  if(endEl) endEl.value = maxDate.toISOString().split('T')[0];
  const startCandidate = new Date(maxDate); startCandidate.setFullYear(startCandidate.getFullYear()-1);
  if(startEl) startEl.value = (startCandidate < minDate ? minDate : startCandidate).toISOString().split('T')[0];
}

function applyFilters(){
  const start = new Date((document.getElementById('start-date')||{}).value || '1970-01-01');
  const end = new Date((document.getElementById('end-date')||{}).value || '2100-01-01');
  const cat = (document.getElementById('category-filter')||{}).value || 'All';
  currentVariety = (document.getElementById('variety-filter')||{}).value || 'All';
  filteredRows = commodityRows.filter(r=>{
    return (cat === 'All' || r.category === cat) &&
           (r.commodity === currentCommodity) &&
           (currentVariety === 'All' || r.variety === currentVariety) &&
           (new Date(r.date) >= start && new Date(r.date) <= end);
  }).sort((a,b)=>new Date(a.date)-new Date(b.date));
  updateDashboardUI();
}
function resetFilters(){ document.getElementById('category-filter').value='All'; currentCommodity=''; populateCommodityList(); setDefaultDateRange(); applyFilters(); }

/* -------------------------
   Dashboard UI updates
   ------------------------- */
function updateSnapshotTable(){
  const body = document.getElementById('snapshot-table-body'); if(!body) return;
  if(!commodityRows.length){ body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:12px;color:var(--muted)">No data loaded.</td></tr>'; return; }
  const dates = commodityRows.map(r=>new Date(r.date));
  const latest = new Date(Math.max.apply(null, dates));
  const latestStr = latest.toISOString().split('T')[0];
  document.getElementById('snapshot-date').textContent = `(${latest.toLocaleDateString('en-GB')})`;
  const snapshot = commodityRows.filter(r => (new Date(r.date)).toISOString().split('T')[0] === latestStr);
  document.getElementById('snapshot-count').textContent = snapshot.length;
  if(!snapshot.length){ body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:12px;color:var(--muted)">No data for latest date.</td></tr>'; return; }

  body.innerHTML = snapshot.map(s=>{
    return `<tr>
      <td style="padding:8px">${escapeHtml(s.market)}</td>
      <td style="padding:8px">${escapeHtml(s.commodity)}</td>
      <td style="padding:8px">${escapeHtml(s.variety)}</td>
      <td style="padding:8px;text-align:right">₹${num(s.modalPriceKg)}</td>
      <td style="padding:8px;text-align:right">₹${num(s.minPriceKg)}</td>
      <td style="padding:8px;text-align:right">₹${num(s.maxPriceKg)}</td>
    </tr>`;
  }).join('');
}

function updateSummaryCards(){
  const container = document.getElementById('summary-cards'); if(!container) return;
  if(!filteredRows.length){ container.innerHTML = '<div class="card" style="text-align:center;color:var(--muted)">No data for selection</div>'; return; }
  const latest = filteredRows[filteredRows.length-1];
  const prev = filteredRows[filteredRows.length-2] || latest;
  const prices = filteredRows.map(r=>r.modalPriceKg);
  const avg = (prices.reduce((a,b)=>a+b,0))/prices.length;
  const minP = Math.min(...prices), maxP = Math.max(...prices);
  const change = prev.modalPriceKg ? ((latest.modalPriceKg - prev.modalPriceKg)/Math.max(1, prev.modalPriceKg))*100 : 0;

  const cards = [
    {title:'Latest Price', value:`₹${num(latest.modalPriceKg)}`, sub: currentCommodity || ''},
    {title:'Average Price', value:`₹${num(avg)}`, sub:'Period Avg'},
    {title:'Lowest Price', value:`₹${num(minP)}`, sub:'In Period'},
    {title:'Highest Price', value:`₹${num(maxP)}`, sub:'In Period'},
  ];
  container.innerHTML = cards.map(c=>`<div class="card"><div style="color:var(--muted);font-size:13px">${escapeHtml(c.title)}</div><div style="font-weight:700;font-size:20px;margin-top:6px">${escapeHtml(c.value)}</div><div class="small-muted">${escapeHtml(c.sub||'')}</div></div>`).join('');
}

function updatePriceChart(){
  const ctx = document.getElementById('price-chart')?.getContext('2d'); if(!ctx) return;
  if(priceChart) priceChart.destroy();
  if(!filteredRows.length){ ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height); return; }
  priceChart = new Chart(ctx, {
    type:'line',
    data:{ datasets:[
      { label:'Modal Price', data: filteredRows.map(r=>({x:new Date(r.date), y:r.modalPriceKg})), borderColor:'#059669', backgroundColor:'rgba(5,150,105,0.06)', fill:true, tension:0.25, pointRadius:2 }
    ]},
    options: { parsing:false, scales:{ x:{ type:'time', time:{ unit:'month' } }, y:{ beginAtZero:false } }, plugins:{ legend:{display:false} } }
  });
}

function updateDataTable(){
  const body = document.getElementById('price-table-body'); if(!body) return;
  if(!filteredRows.length){ body.innerHTML = '<tr><td colspan="8" style="padding:12px;text-align:center;color:var(--muted)">No data</td></tr>'; return; }
  const last = filteredRows.slice(-20).reverse();
  // Trend: compare with previous point for the same commodity
  body.innerHTML = last.map((r,i)=>{
    const prev = filteredRows[filteredRows.indexOf(r) - 1];
    let trendHtml = '—';
    if(prev) {
      if(r.modalPriceKg > prev.modalPriceKg) trendHtml = `<span class="trend-up">▲ ${num(((r.modalPriceKg-prev.modalPriceKg)/Math.max(1,prev.modalPriceKg))*100)}%</span>`;
      else if(r.modalPriceKg < prev.modalPriceKg) trendHtml = `<span class="trend-down">▼ ${num(((r.modalPriceKg-prev.modalPriceKg)/Math.max(1,prev.modalPriceKg))*100)}%</span>`;
      else trendHtml = `<span class="small-muted">—</span>`;
    }
    return `<tr style="border-bottom:1px solid rgba(15,23,42,0.04)">
      <td style="padding:10px">${new Date(r.date).toLocaleDateString()}</td>
      <td style="padding:10px">${escapeHtml(r.market)}</td>
      <td style="padding:10px">${escapeHtml(r.commodity)}</td>
      <td style="padding:10px">${escapeHtml(r.variety)}</td>
      <td style="padding:10px;text-align:right">₹${num(r.modalPriceKg)}</td>
      <td style="padding:10px;text-align:right">₹${num(r.minPriceKg)}</td>
      <td style="padding:10px;text-align:right">₹${num(r.maxPriceKg)}</td>
      <td style="padding:10px;text-align:center">${trendHtml}</td>
    </tr>`;
  }).join('');
}

/* -------------------------
   Forecast (improved but lightweight)
   - Uses simple linear regression on log-prices for multiplicative trend
   - Returns forecast array for days
   ------------------------- */
function computeForecastFromSeries(series, days=90){
  if(!series.length) return [];
  // prepare x as index, y as price
  const n = series.length;
  const xs = []; const ys = [];
  for(let i=0;i<n;i++){
    xs.push(i);
    ys.push(series[i].y);
  }
  // simple linear regression on y (or log y to avoid negatives)
  const xm = xs.reduce((a,b)=>a+b,0)/n;
  const ym = ys.reduce((a,b)=>a+b,0)/n;
  let num=0, den=0;
  for(let i=0;i<n;i++){ num += (xs[i]-xm)*(ys[i]-ym); den += (xs[i]-xm)*(xs[i]-xm); }
  const slope = den === 0 ? 0 : num/den;
  const intercept = ym - slope * xm;
  const lastDate = new Date(series[series.length-1].date);
  const forecast = [];
  for(let d=1; d<=days; d++){
    const xi = n - 1 + d;
    const pred = intercept + slope * xi;
    forecast.push({ date: new Date(lastDate.getTime() + d*24*3600*1000), y: Math.max(0, pred) });
  }
  return forecast;
}

function computeForecastAndRender(){
  if(!filteredRows.length){ document.getElementById('strategy-signal').textContent='—'; return; }
  const series = filteredRows.map(r=>({date:new Date(r.date), y:r.modalPriceKg}));
  const forecast = computeForecastFromSeries(series, 90);
  // Chart render
  const ctx = document.getElementById('forecast-chart')?.getContext('2d');
  if(!ctx) return;
  if(forecastChart) forecastChart.destroy();
  const hist = series.map(s=>({x:s.date, y:s.y}));
  const fc = forecast.map(f=>({x:f.date, y:f.y}));
  forecastChart = new Chart(ctx, {
    type:'line',
    data:{
      datasets:[
        { label:'Historical', data:hist, borderColor:'#059669', backgroundColor:'rgba(5,150,105,0.06)', fill:true, tension:0.25, pointRadius:1 },
        { label:'Forecast', data:fc, borderColor:'#ef4444', borderDash:[6,6], pointRadius:0, fill:false, tension:0.25 }
      ]
    },
    options:{ parsing:false, scales:{ x:{ type:'time', time:{ unit:'week' } }, y:{ beginAtZero:false } }, plugins:{ legend:{display:false} }, maintainAspectRatio:false }
  });

  // Strategic metrics
  const recent = series.slice(-30).map(s=>s.y);
  const recentAvg = recent.reduce((a,b)=>a+b,0)/recent.length;
  const fcFirst30 = fc.slice(0,30).map(x=>x.y);
  const fcAvg30 = fcFirst30.length ? fcFirst30.reduce((a,b)=>a+b,0)/fcFirst30.length : 0;
  // slope indicator: percent change over first 30 forecast days relative to last observed
  const slopePct = (fcAvg30 - series[series.length-1].y) / Math.max(1, series[series.length-1].y);

  const vol = Math.sqrt(series.reduce((s,v)=>s+Math.pow(v.y - recentAvg,2),0) / Math.max(1, series.length));
  const confidence = Math.max(0, Math.min(100, 100 - vol*200));

  document.getElementById('forecast-confidence')?.textContent = `${Math.round(confidence)}%`;

  // Determine signal and strategy tile class
  let signal = 'Hold', detail = 'Prices stable in near term.';
  const tile = document.getElementById('strategy-tile');
  if(slopePct > 0.12){ signal = 'Hold / Wait — Price likely higher'; detail = 'Forecast indicates upward momentum.'; tile.className = 'strategy-card strategy-buy card'; }
  else if(slopePct < -0.07){ signal = 'Sell — Consider selling soon'; detail = 'Forecast indicates decreasing prices.'; tile.className = 'strategy-card strategy-sell card'; }
  else { signal = 'Hold / Monitor'; detail = 'No strong upward or downward trend.'; tile.className = 'strategy-card strategy-wait card'; }
  document.getElementById('strategy-signal').textContent = signal;
  document.getElementById('strategy-detail').textContent = detail;

  // Predictions: 2 concise and actionable predictions
  // Prediction 1: Profitability at harvest if planted today
  const cropMeta = CROP_META[currentCommodity] || CROP_META._default;
  const durationDays = cropMeta.durationDays || 120;
  const expectedHarvestDate = new Date();
  expectedHarvestDate.setDate(expectedHarvestDate.getDate() + durationDays);
  const expectedYieldKgPerHa = (cropDefaults[currentCommodity] && cropDefaults[currentCommodity].yieldKgPerHa) || cropMeta.defaultYieldKgPerHa;
  const areaHa = (cropDefaults[currentCommodity] && cropDefaults[currentCommodity].areaHa) || 1;
  const expectedOutputKg = expectedYieldKgPerHa * areaHa;
  // expected price at harvest = average forecast over window around harvest (take forecast value ~ durationDays ahead)
  const fcIndex = Math.min(forecast.length-1, Math.max(0, Math.round(durationDays))); // approx
  const expectedPriceAtHarvest = forecast[fcIndex] ? forecast[fcIndex].y : (fcAvg30 || series[series.length-1].y);
  const expectedRevenue = expectedOutputKg * expectedPriceAtHarvest;

  document.getElementById('pred1').textContent = `If you plant ${currentCommodity} today (harvest ≈ ${durationDays} days), estimated revenue ≈ ₹${num(expectedRevenue)} for ${areaHa} ha (using expected yield ${num(expectedYieldKgPerHa)} kg/ha and forecast price ₹${num(expectedPriceAtHarvest)}/kg).`;

  // Prediction 2: Best action window (sell/hold)
  const recentTrend = (series[series.length-1].y - series[Math.max(0, series.length-8)].y) / Math.max(1, series[Math.max(0, series.length-8)].y);
  let action = 'Hold';
  if(recentTrend > 0.08 && slopePct > 0.05) action = 'Hold (prices rising) — sell later';
  else if(recentTrend < -0.05 && slopePct < -0.05) action = 'Sell (prices falling) — consider immediate sale';
  else action = 'Monitor market; sell when short-term peak occurs';
  document.getElementById('pred2').textContent = action;

  // Fill prediction outlook summary
  const outlook = document.getElementById('prediction-outlook');
  outlook.innerHTML = `<div class="card" style="margin-top:10px"><strong>Summary:</strong> Forecast trend is ${slopePct>0.05?'positive':(slopePct<-0.05?'negative':'neutral')}. Forecast confidence ${Math.round(confidence)}%.</div>`;
}

/* -------------------------
   Recommendations / Top crops (category wise)
   ------------------------- */
function generateRecommendations(count=10){
  const commodities = [...new Set(commodityRows.map(r=>r.commodity))];
  const recs = commodities.map(name=>{
    const rows = commodityRows.filter(r=>r.commodity===name).slice(-60);
    if(rows.length < 6) return null;
    const prices = rows.map(r=>r.modalPriceKg);
    const avg = prices.reduce((a,b)=>a+b,0)/prices.length || 0;
    const momentum = (prices[prices.length-1] - prices[0]) / Math.max(1, prices[0]) || 0;
    const variance = prices.reduce((s,p)=>s+Math.pow(p-avg,2),0)/prices.length || 0;
    const vol = Math.sqrt(variance)/Math.max(1,avg);
    const score = (1 + momentum) / (vol + 0.05);
    const category = CROP_META[name] ? CROP_META[name].category : 'Other';
    return {commodity:name, avgPrice:avg, momentum, vol, score, category};
  }).filter(Boolean).sort((a,b)=>b.score-a.score);
  return recs.slice(0,count);
}

function generateTopCropsUI(){
  const recs = generateRecommendations(50); // get many, we'll group
  const grouped = {};
  recs.forEach(r => {
    const cat = r.category || 'Other';
    grouped[cat] = grouped[cat] || [];
    grouped[cat].push(r);
  });
  const cont = document.getElementById('top-crops-container'); if(!cont) return;
  // build UI grouped
  cont.innerHTML = Object.keys(grouped).map(cat=>{
    const list = grouped[cat].slice(0,10).map((r,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(15,23,42,0.02)">
      <div>
        <div style="font-size:13px;color:var(--muted)">#${i+1} ${escapeHtml(cat)}</div>
        <div style="font-weight:700">${escapeHtml(r.commodity)}</div>
        <div style="font-size:12px;color:var(--muted)">Avg ₹${num(r.avgPrice)}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">${(r.momentum*100).toFixed(1)}%</div>
        <div style="margin-top:6px"><button onclick="selectCropFromRecommendation('${escapeJs(r.commodity)}')" class="btn" style="background:var(--emerald);color:white;padding:6px;border-radius:8px">View</button></div>
      </div>
    </div>`).join('');
    return `<div class="card"><div style="font-weight:700;margin-bottom:8px">${escapeHtml(cat)}</div>${list}</div>`;
  }).join('');
}

function selectCropFromRecommendation(name){
  // set category filter to All, select commodity and show dashboard
  document.getElementById('category-filter').value = 'All';
  currentCommodity = name;
  // highlight in list
  const container = document.getElementById('commodity-list');
  if(container){
    Array.from(container.querySelectorAll('button')).forEach(b=>{ if(b.textContent===name) b.classList.add('selected'); else b.classList.remove('selected'); });
  }
  populateVarietyFilter();
  applyFilters();
  // move to prediction tab for quick view
  document.getElementById('tab-prediction').click();
}

/* -------------------------
   Weather (Open-Meteo)
   ------------------------- */
async function renderWeatherForCurrentMarket(){
  const sel = document.getElementById('market-select'); if(!sel) return;
  const marketName = sel.value;
  const market = markets.find(m=>m.name===marketName);
  const container = document.getElementById('weather-container'); if(!container) return;
  if(!market || !market.lat || !market.lon){
    container.innerHTML = `<div class="small-muted">No coordinates for "${escapeHtml(marketName)}". Use Manage or location detect to add coordinates.</div>`;
    return;
  }
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${market.lat}&longitude=${market.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;
  try{
    const res = await fetch(url); const json = await res.json();
    if(!json.daily){ container.innerHTML = `<div class="small-muted">Weather not available</div>`; return; }
    const days = json.daily.time.map((t,i)=>({date:t, max: json.daily.temperature_2m_max[i], min: json.daily.temperature_2m_min[i], precip: json.daily.precipitation_sum[i]}));
    container.innerHTML = days.map(d=>`<div style="margin-bottom:6px"><strong>${new Date(d.date).toLocaleDateString()}</strong>: ${d.max}°/${d.min}° • Rain ${d.precip} mm</div>`).join('');
  }catch(e){ container.innerHTML = `<div class="small-muted">Weather fetch error</div>`; console.warn(e); }
}

/* -------------------------
   File import handling
   ------------------------- */
async function handleFileImport(file){
  if(!file) return;
  try{
    const name = file.name.toLowerCase();
    if(name.endsWith('.csv') || file.type.includes('text')){
      const text = await file.text();
      const rows = await parseCSVText(text, { header:true, skipEmptyLines:true });
      processPreloadedData(rows);
    } else {
      const ab = await file.arrayBuffer();
      const wb = XLSX.read(ab, { type:'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
      processPreloadedData(rows);
    }
    alert('Imported successfully');
    showDashboardAfterLoad();
  }catch(e){ console.error(e); alert('Import failed: ' + (e.message||e)); }
}

/* -------------------------
   Utility helpers
   ------------------------- */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeJs(s){ return String(s||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }
function num(n){ return (Math.round((n+Number.EPSILON) * 100)/100).toLocaleString('en-IN'); }

/* -------------------------
   Refresh UI safe
   ------------------------- */
function refreshAllUI(){
  try{
    populateMarketSelect();
    populateCategoryFilter();
    populateCommodityList();
    populateVarietyFilter();
    setDefaultDateRange();
    applyFilters();
    updateSnapshotTable();
    updateSummaryCards();
    updatePriceChart();
    updateDataTable();
    populateMarketsTableIfExists();
  }catch(e){ console.warn('refresh error', e); }
}

/* populate markets table if UI exists */
function populateMarketsTableIfExists(){
  const tbody = document.getElementById('markets-table-body');
  if(!tbody) return;
  tbody.innerHTML = markets.map((m, idx)=>`<tr><td class="p-1 text-sm">${escapeHtml(m.name)}</td><td class="p-1 text-sm">${m.lat||''}</td><td class="p-1 text-sm">${m.lon||''}</td><td class="p-1"><button class="text-red-500 text-xs" onclick="removeMarket(${idx})">Remove</button></td></tr>`).join('');
}
function removeMarket(i){ markets.splice(i,1); saveToLocal(); populateMarketSelect(); populateMarketsTableIfExists(); }

/* -------------------------
   Show dashboard after a load
   ------------------------- */
function showDashboardAfterLoad(){
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('main-dashboard').classList.remove('hidden');
  refreshAllUI();
}

/* -------------------------
   Startup wiring
   ------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  loadCropDefaults();
  // show start screen (do not auto open)
  document.getElementById('start-screen').classList.remove('hidden');
  document.getElementById('main-dashboard').classList.add('hidden');

  // Start preloaded - fetch raw CSV URL
  document.getElementById('start-analysis-btn')?.addEventListener('click', async ()=>{
    if(!PRELOADED_RAW_URL){ alert('No preloaded URL set.'); return; }
    try{
      const resp = await fetch(PRELOADED_RAW_URL);
      if(!resp.ok) throw new Error('Fetch failed: '+resp.status);
      const ct = resp.headers.get('content-type') || '';
      const blob = await resp.blob();
      if(ct.includes('text') || PRELOADED_RAW_URL.toLowerCase().endsWith('.csv')){
        const text = await blob.text();
        const rows = await parseCSVText(text, { header:true, skipEmptyLines:true });
        processPreloadedData(rows);
      } else {
        const ab = await blob.arrayBuffer();
        const wb = XLSX.read(ab, { type:'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval:'' });
        processPreloadedData(rows);
      }
      setTimeout(()=> showDashboardAfterLoad(), 250);
    }catch(e){ console.error(e); alert('Preload failed: ' + (e.message||e)); }
  });

  document.getElementById('load-local-btn')?.addEventListener('click', ()=>{
    const ok = loadFromLocalSync();
    if(ok) showDashboardAfterLoad();
    else alert('No saved data found. Import a file or load preloaded data.');
  });

  // file input
  document.getElementById('file-input')?.addEventListener('change', ev => handleFileImport(ev.target.files[0]));

  // buttons in sidebar
  document.getElementById('import-csv-btn')?.addEventListener('click', ()=> document.getElementById('file-input').click());
  document.getElementById('apply-filters')?.addEventListener('click', applyFilters);
  document.getElementById('reset-filters')?.addEventListener('click', resetFilters);
  document.getElementById('add-record-btn')?.addEventListener('click', openAddModal);
  document.getElementById('export-all-btn')?.addEventListener('click', exportAllCSV);
  document.getElementById('clear-storage-btn')?.addEventListener('click', clearLocal);
  document.getElementById('get-recommendations')?.addEventListener('click', ()=>{ generateTopCropsUI(); document.getElementById('tab-top-crops').click(); });

  // tabs
  document.getElementById('tab-dashboard')?.addEventListener('click', ()=>{ showTab('dashboard'); });
  document.getElementById('tab-prediction')?.addEventListener('click', ()=>{ showTab('prediction'); computeForecastAndRender(); });
  document.getElementById('tab-top-crops')?.addEventListener('click', ()=>{ showTab('top-crops'); generateTopCropsUI(); });

  document.getElementById('market-select')?.addEventListener('change', renderWeatherForCurrentMarket);
  document.getElementById('export-csv')?.addEventListener('click', exportFilteredCSV);

  // geolocation
  document.getElementById('geo-locate')?.addEventListener('click', ()=>{
    if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      const name = `My Location (${lat.toFixed(3)},${lon.toFixed(3)})`;
      markets.unshift({ name, lat, lon });
      saveToLocal();
      populateMarketSelect();
      document.getElementById('market-select').value = name;
      renderWeatherForCurrentMarket();
      alert('Location saved to markets list');
    }, err=>{ alert('Failed to get location: ' + err.message); });
  });

  // load saved quietly (do not open)
  loadFromLocalSync();
});

/* Switch tabs (visual)
   'dashboard' | 'prediction' | 'top-crops'
*/
function showTab(tab){
  if(tab==='dashboard'){
    document.getElementById('dashboard-content').classList.remove('hidden');
    document.getElementById('prediction-content').classList.add('hidden');
    document.getElementById('top-crops-content').classList.add('hidden');
    document.getElementById('tab-dashboard').classList.add('active');
    document.getElementById('tab-prediction').classList.remove('active');
    document.getElementById('tab-top-crops').classList.remove('active');
  } else if(tab==='prediction'){
    document.getElementById('dashboard-content').classList.add('hidden');
    document.getElementById('prediction-content').classList.remove('hidden');
    document.getElementById('top-crops-content').classList.add('hidden');
    document.getElementById('tab-dashboard').classList.remove('active');
    document.getElementById('tab-prediction').classList.add('active');
    document.getElementById('tab-top-crops').classList.remove('active');
  } else {
    document.getElementById('dashboard-content').classList.add('hidden');
    document.getElementById('prediction-content').classList.add('hidden');
    document.getElementById('top-crops-content').classList.remove('hidden');
    document.getElementById('tab-dashboard').classList.remove('active');
    document.getElementById('tab-prediction').classList.remove('active');
    document.getElementById('tab-top-crops').classList.add('active');
  }
}

/* -------------------------
   Modal add/edit record
   ------------------------- */
function openAddModal(){
  document.getElementById('modal-add-record').style.display = 'flex';
  document.getElementById('delete-record-btn').style.display = 'none';
  document.getElementById('rec-market').innerHTML = markets.map(m=>`<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join('');
  document.getElementById('record-form').onsubmit = (e)=>{
    e.preventDefault();
    const newRow = {
      date: new Date(document.getElementById('rec-date').value),
      market: document.getElementById('rec-market').value,
      commodity: document.getElementById('rec-commodity').value,
      variety: document.getElementById('rec-variety').value || 'Default',
      category: document.getElementById('rec-category').value || 'Other',
      district: document.getElementById('rec-district').value || '',
      modalPriceKg: parseFloat(document.getElementById('rec-modal').value) || 0,
      minPriceKg: parseFloat(document.getElementById('rec-min').value) || 0,
      maxPriceKg: parseFloat(document.getElementById('rec-max').value) || 0
    };
    commodityRows.push(newRow);
    commodityRows.sort((a,b)=>new Date(a.date)-new Date(b.date));
    saveToLocal();
    document.getElementById('modal-add-record').style.display='none';
    refreshAllUI();
  };
}

/* -------------------------
   Export helpers
   ------------------------- */
function exportAllCSV(){
  if(!commodityRows.length){ alert('No data to export'); return; }
  const headers = ['Date','Market','Commodity','Variety','Category','District','Min_Price_Kg','Max_Price_Kg','Modal_Price_Kg'];
  const rows = commodityRows.map(r => [new Date(r.date).toISOString().split('T')[0], r.market, r.commodity, r.variety, r.category, r.district, r.minPriceKg, r.maxPriceKg, r.modalPriceKg]);
  const csv = [headers.join(','), ...rows.map(r => r.map(cell => typeof cell === 'string' && cell.includes(',') ? `"${cell.replace(/"/g,'""')}"` : cell).join(','))].join('\n');
  const link = document.createElement('a'); link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); link.download = 'agri_export.csv'; document.body.appendChild(link); link.click(); link.remove();
}
function exportFilteredCSV(){
  if(!filteredRows.length){ alert('No visible rows'); return; }
  const rows = filteredRows.map(r => [new Date(r.date).toISOString().split('T')[0], r.market, r.commodity, r.variety, r.minPriceKg, r.maxPriceKg, r.modalPriceKg]);
  const csv = ['Date,Market,Commodity,Variety,Min,Max,Modal', ...rows.map(r=>r.join(','))].join('\n');
  const link = document.createElement('a'); link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); link.download = 'export_filtered.csv'; document.body.appendChild(link); link.click(); link.remove();
}

/* -------------------------
   Markets management helpers
   ------------------------- */
function addMarket(name, lat, lon){
  if(!name) return;
  markets.push({ name, lat, lon });
  saveToLocal();
  populateMarketSelect();
  populateMarketsTableIfExists();
}

/* -------------------------
   Small helpers for UI that may be missing
   ------------------------- */
function populateMarketsTableIfExists(){} // already declared earlier for fallback

/* End of app script */
</script>

<!-- Service worker registration: place before closing body -->
<script>
if ('serviceWorker' in navigator) {
  // If your site is hosted inside /Smart_FarmHer/ on GitHub Pages, SW path should be '/Smart_FarmHer/service-worker.js'
  // If your site is at root, set '/service-worker.js'
  const base = location.pathname.startsWith('/Smart_FarmHer') ? '/Smart_FarmHer' : '';
  const swPath = base + '/service-worker.js';
  navigator.serviceWorker.register(swPath, { scope: base || '/' }).then(reg=>{
    console.log('Service worker registered', reg);
  }).catch(err=>console.warn('SW registration failed', err));
}
</script>

</body>
</html>

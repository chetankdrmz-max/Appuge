<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart FarmHer â€” Grow Good Sell Smart</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10b981">

  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root{--emerald:#10b981;--muted:#6b7280;--card:#ffffff;--bg:#f3f6f8}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);margin:0;color:#0f172a}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.06);border:1px solid rgba(15,23,42,0.04)}
    .small-muted{color:var(--muted);font-size:13px}
    /* Sidebar */
    .sidebar{width:300px;min-width:260px;background:#fff;padding:16px;border-right:1px solid rgba(15,23,42,0.04);display:flex;flex-direction:column;gap:12px}
    /* Commodity list */
    .list { max-height:360px; overflow:auto; border-radius:8px; padding:6px; border:1px solid rgba(15,23,42,0.04); background:#fff}
    .commodity-btn{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:8px;border:none;background:transparent;color:#0f172a;font-weight:500;transition:background-color 160ms,transform 120ms;cursor:pointer}
    .commodity-btn:hover{background:#f3f4f6}
    .commodity-btn.active{background:var(--emerald);color:#fff;font-weight:700;box-shadow:0 6px 16px rgba(16,185,129,0.12);transform:translateY(-1px)}
    /* Date input */
    .date-input-wrapper{position:relative;display:flex;align-items:center}
    .date-input-wrapper input[type="date"]{padding:10px 36px 10px 12px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#fff}
    .date-input-wrapper .date-icon{position:absolute;right:8px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px;cursor:pointer;color:var(--muted)}
    .date-input-wrapper .date-icon:hover{background:#f3f4f6}
    /* Responsive */
    @media (max-width: 900px){
      .sidebar{display:none}
      .mobile-topbar{display:flex}
      .chart-card{height:260px}
    }
    .mobile-topbar{display:none;align-items:center;gap:12px;padding:10px 14px;background:#fff;border-bottom:1px solid rgba(15,23,42,0.04)}
    .drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:50;display:none;align-items:flex-start;justify-content:flex-start}
    .drawer{width:86%;max-width:360px;background:#fff;padding:16px;height:100vh;overflow:auto;box-shadow:0 30px 60px rgba(2,6,23,0.4);transform:translateX(-110%);transition:transform 250ms ease}
    .drawer.open{transform:translateX(0)}
    .drawer-backdrop.open{display:flex}
    /* smaller chart container */
    .chart-sm { height:340px; }
  </style>
</head>
<body>

  <!-- MOBILE TOPBAR (hamburger opens drawer) -->
  <div class="mobile-topbar" id="mobile-topbar">
    <button id="open-drawer-btn" style="background:none;border:none;font-size:20px;padding:6px"><i class="fas fa-bars" style="color:#0f172a"></i></button>
    <div style="display:flex;align-items:center;gap:8px">
      <img src="icons/Smartfarmher.png" alt="icon" style="width:34px;height:34px;border-radius:6px;object-fit:cover">
      <div>
        <div style="font-weight:700;color:var(--emerald)">Smart FarmHer</div>
        <div class="small-muted" style="font-size:12px">Grow Good Sell Smart</div>
      </div>
    </div>
    <div style="margin-left:auto">
      <button id="get-recommendations-mobile" style="background:var(--emerald);color:white;padding:8px 10px;border-radius:8px;border:none"><i class="fas fa-lightbulb"></i></button>
    </div>
  </div>

  <!-- START SCREEN (unchanged) -->
  <div id="start-screen" class="min-h-screen flex items-center justify-center" style="background-image:url('icons/bg-desktop.jpg'); background-size:cover; background-position:center;">
    <div class="card" style="max-width:880px; width:100%; margin:32px">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:12px">
          <img src="icons/Smartfarmher.png" id="brand-icon" style="width:44px;height:44px;object-fit:cover;border-radius:6px" alt="">
          <div>
            <h1 style="margin:0;font-size:26px;color:var(--emerald);font-weight:700">Smart FarmHer</h1>
            <div style="color:#374151;font-weight:600;margin-top:4px">Grow Good Sell Smart</div>
          </div>
        </div>
        <div>
          <button id="open-help" style="background:none;border:none;color:var(--muted)"><i class="fas fa-question-circle"></i></button>
        </div>
      </div>

      <div style="margin-top:18px">
        <input id="file-input" type="file" accept=".csv,.xlsx,.xls,text/csv" class="w-full p-3 rounded border" />
      </div>

      <div style="margin-top:18px;display:flex;gap:12px;justify-content:center">
        <button id="start-analysis-btn" class="bg-emerald-500 text-white py-2 px-4 rounded flex items-center gap-2"><i class="fas fa-cloud-download-alt"></i> Load Preloaded Data</button>
        <button id="load-local-btn" class="bg-slate-900 text-white py-2 px-4 rounded flex items-center gap-2"><i class="fas fa-save"></i> Load Saved</button>
      </div>

      <div class="small-muted mt-3">Tip: import your CSV/XLSX file with market rows. Use saved data to keep it on your phone. Use "Load Preloaded Data" to fetch dataset hosted in repo.</div>
    </div>
  </div>

  <!-- Drawer for mobile sidebar -->
  <div id="drawer-backdrop" class="drawer-backdrop" aria-hidden="true">
    <div id="drawer" class="drawer" role="dialog" aria-modal="true">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:8px">
          <img src="icons/Smartfarmher.png" alt="" style="width:34px;height:34px;border-radius:6px;object-fit:cover">
          <div style="font-weight:700;color:var(--emerald)">Smart FarmHer</div>
        </div>
        <button id="close-drawer" style="background:none;border:none;font-size:18px"><i class="fas fa-times"></i></button>
      </div>

      <!-- Drawer content: same controls as sidebar -->
      <div style="margin-top:12px">
        <label class="small-muted">Markets</label>
        <select id="market-select-drawer" class="w-full p-2 rounded border mt-2"></select>
        <div class="flex gap-2 mt-2">
          <button id="geo-drawer" class="p-2 rounded border w-1/3"><i class="fas fa-location-arrow"></i></button>
          <button id="manage-markets-drawer" class="p-2 rounded border flex-1">Manage</button>
        </div>
      </div>

      <div class="mt-4">
        <label class="small-muted">Category</label>
        <select id="category-filter-drawer" class="w-full p-2 rounded border mt-2">
          <option>All</option>
        </select>
      </div>

      <div class="mt-4">
        <label class="small-muted">Commodity</label>
        <div id="commodity-list-drawer" class="list mt-2"></div>
      </div>

      <div class="mt-4">
        <label class="small-muted">Variety</label>
        <select id="variety-filter-drawer" class="w-full p-2 rounded border mt-2"><option>All</option></select>
      </div>

      <div class="mt-4">
        <label class="small-muted">Date range</label>
        <div class="flex gap-2 mt-2">
          <div class="date-input-wrapper flex-1">
            <input id="start-date-drawer" type="date" class="w-full p-2 rounded border">
            <div class="date-icon">ðŸ“…</div>
          </div>
          <div class="date-input-wrapper flex-1">
            <input id="end-date-drawer" type="date" class="w-full p-2 rounded border">
            <div class="date-icon">ðŸ“…</div>
          </div>
        </div>
      </div>

      <div class="flex gap-2 mt-4">
        <button id="apply-filters-drawer" class="bg-emerald-500 text-white p-2 rounded flex-1">Apply</button>
        <button id="reset-filters-drawer" class="p-2 rounded border flex-1">Reset</button>
      </div>

      <div class="flex gap-2 mt-4">
        <button id="import-csv-drawer" class="flex-1 p-2 bg-slate-900 text-white rounded">Import</button>
        <button id="export-csv-drawer" class="flex-1 p-2 bg-slate-200 rounded">Export</button>
      </div>
    </div>
  </div>

  <!-- MAIN (desktop layout) -->
  <div id="main-dashboard" class="hidden flex min-h-screen">
    <aside class="sidebar" id="sidebar-desktop">
      <div style="display:flex;align-items:center;gap:8px">
        <img src="icons/Smartfarmher.png" style="width:28px;height:28px;border-radius:6px;object-fit:cover">
        <div style="font-weight:700;color:var(--emerald)">Smart FarmHer</div>
      </div>

      <div>
        <label class="small-muted">Markets</label>
        <select id="market-select" class="w-full p-2 rounded border mt-2"></select>
        <div class="flex gap-2 mt-2">
          <button id="geo-locate" class="p-2 rounded border w-1/3"><i class="fas fa-location-arrow"></i></button>
          <button id="manage-markets-btn" class="p-2 rounded border flex-1">Manage</button>
        </div>
      </div>

      <div>
        <label class="small-muted">Category</label>
        <select id="category-filter" class="w-full p-2 rounded border mt-2"><option>All</option></select>
      </div>

      <div>
        <label class="small-muted">Commodity</label>
        <div id="commodity-list" class="list mt-2"></div>
      </div>

      <div>
        <label class="small-muted">Variety</label>
        <select id="variety-filter" class="w-full p-2 rounded border mt-2"><option>All</option></select>
      </div>

      <div>
        <label class="small-muted">Date range</label>
        <div class="flex gap-2 mt-2">
          <div class="date-input-wrapper flex-1">
            <input id="start-date" type="date" class="w-full p-2 rounded border">
            <div class="date-icon">ðŸ“…</div>
          </div>
          <div class="date-input-wrapper flex-1">
            <input id="end-date" type="date" class="w-full p-2 rounded border">
            <div class="date-icon">ðŸ“…</div>
          </div>
        </div>
      </div>

      <div class="flex gap-2 mt-4">
        <button id="apply-filters" class="bg-emerald-500 text-white p-2 rounded flex-1">Apply</button>
        <button id="reset-filters" class="p-2 rounded border flex-1">Reset</button>
      </div>

      <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px">
        <button id="add-record-btn" class="bg-blue-600 text-white p-2 rounded"><i class="fas fa-plus"></i> Add Record</button>
        <button id="import-csv-btn" class="bg-slate-900 text-white p-2 rounded"><i class="fas fa-file-import"></i> Import CSV/XLSX</button>
        <button id="export-all-btn" class="bg-slate-100 p-2 rounded"><i class="fas fa-file-export"></i> Export CSV</button>
        <button id="clear-storage-btn" class="bg-red-50 text-red-700 p-2 rounded"><i class="fas fa-trash"></i> Clear Local Save</button>
      </div>
    </aside>

    <div class="flex-1 p-6">
      <header class="flex items-center justify-between mb-6">
        <div>
          <h2 id="main-header" class="text-2xl font-bold">Dashboard</h2>
          <div class="small-muted">Quick market insights & crop recommendations</div>
        </div>
        <div class="flex items-center gap-3">
          <button id="get-recommendations" class="bg-emerald-500 text-white px-3 py-2 rounded"><i class="fas fa-lightbulb"></i> Get Recommendations</button>
          <button id="show-help-btn" class="p-2 rounded border">Help</button>
        </div>
      </header>

      <!-- Tabs -->
      <div class="mb-4">
        <nav class="flex gap-6">
          <button id="tab-dashboard" class="border-b-4 border-emerald-500 pb-2">Dashboard</button>
          <button id="tab-prediction" class="pb-2">Predictive Analysis</button>
          <button id="tab-top-crops" class="pb-2">Top 10 Crops</button>
        </nav>
      </div>

      <!-- Dashboard content -->
      <div id="dashboard-content">
        <div class="card mb-4">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-lg font-semibold">Latest Market Snapshot <span id="snapshot-date" class="small-muted"></span></h3>
              <div class="small-muted mt-1">Latest day across markets</div>
            </div>
            <div class="small-muted">Rows: <span id="snapshot-count">0</span></div>
          </div>

          <div class="mt-4 snapshot-table card p-0">
            <table class="w-full text-sm">
              <thead class="bg-slate-50"><tr><th class="p-3 text-left">Market</th><th class="p-3 text-left">Commodity</th><th class="p-3 text-left">Variety</th><th class="p-3 text-right">Modal</th><th class="p-3 text-right">Min</th><th class="p-3 text-right">Max</th><th class="p-3 text-center">Trend</th></tr></thead>
              <tbody id="snapshot-table-body"><tr><td colspan="7" class="text-center p-4 small-muted">No data loaded.</td></tr></tbody>
            </table>
          </div>
        </div>

        <div id="summary-cards" class="grid gap-4 mb-4" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))"></div>

        <div class="grid gap-4" style="grid-template-columns:1fr 320px">
          <div class="card chart-sm">
            <h4 class="font-semibold mb-2">Historical Price Trends</h4>
            <canvas id="price-chart" class="w-full h-64"></canvas>
          </div>

          <div class="card">
            <h4 class="font-semibold">7-day Weather (Selected Market)</h4>
            <div id="weather-container" class="small-muted mt-2">Add market coordinates or use location detection to view forecast.</div>
          </div>
        </div>

        <div class="card mt-4">
          <div class="flex justify-between items-center">
            <h4 class="font-semibold">Detailed Price Data (last 20 rows)</h4>
            <button id="export-csv" class="bg-slate-900 text-white px-3 py-2 rounded"><i class="fas fa-download"></i> Export CSV</button>
          </div>

          <div class="mt-4 overflow-auto" style="max-height:320px">
            <table class="w-full text-sm">
              <thead class="bg-slate-50"><tr><th class="p-3 text-left">Date</th><th class="p-3">Market</th><th class="p-3">Commodity</th><th class="p-3">Variety</th><th class="p-3 text-right">Modal</th><th class="p-3 text-right">Min</th><th class="p-3 text-right">Max</th><th class="p-3 text-center">Trend</th></tr></thead>
              <tbody id="price-table-body"><tr><td colspan="8" class="text-center p-4 small-muted">No data</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Predictive analysis -->
      <div id="prediction-content" class="hidden">
        <div class="card mb-4" id="forecast-card">
          <h3 class="font-semibold">90-Day Price Forecast</h3>
          <div style="height:260px"><canvas id="forecast-chart" class="w-full h-64"></canvas></div>
        </div>

        <div class="grid gap-4" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
          <div id="strategy-signal-card" class="card">
            <h4 class="font-semibold">Strategic Signal</h4>
            <div id="strategy-signal" style="font-size:24px;font-weight:800;margin-top:8px">â€”</div>
            <div id="strategy-detail" class="small-muted mt-2">â€”</div>
          </div>

          <div class="card">
            <h4 class="font-semibold">Peak Profitability</h4>
            <div id="peak-month" style="font-size:22px;font-weight:700;margin-top:8px">â€”</div>
            <div class="small-muted mt-2">Historically best month</div>
          </div>
        </div>

        <div id="prediction-outlook" class="mt-4"></div>
      </div>

      <div id="top-crops-content" class="hidden">
        <div class="card mb-4">
          <h3 class="font-semibold">Top Crop Recommendations</h3>
          <div id="top-crops-container" class="grid gap-4" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal-add-record" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:16px;z-index:50">
    <div class="card" style="max-width:720px;margin:auto">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-semibold">Add / Edit Record</h3>
        <button onclick="document.getElementById('modal-add-record').style.display='none'">âœ•</button>
      </div>
      <form id="record-form" class="grid grid-cols-2 gap-3 mt-3">
        <div><label class="small-muted">Date</label><input id="rec-date" type="date" class="w-full p-2 rounded border" required></div>
        <div><label class="small-muted">Market</label><select id="rec-market" class="w-full p-2 rounded border"></select></div>
        <div><label class="small-muted">Commodity</label><input id="rec-commodity" class="w-full p-2 rounded border"></div>
        <div><label class="small-muted">Variety</label><input id="rec-variety" class="w-full p-2 rounded border"></div>
        <div><label class="small-muted">Category</label><input id="rec-category" class="w-full p-2 rounded border"></div>
        <div><label class="small-muted">District</label><input id="rec-district" class="w-full p-2 rounded border"></div>
        <div><label class="small-muted">Modal (â‚¹/kg)</label><input id="rec-modal" type="number" step="0.01" class="w-full p-2 rounded border"></div>
        <div><label class="small-muted">Min (â‚¹/kg)</label><input id="rec-min" type="number" step="0.01" class="w-full p-2 rounded border"></div>
        <div><label class="small-muted">Max (â‚¹/kg)</label><input id="rec-max" type="number" step="0.01" class="w-full p-2 rounded border"></div>
        <div class="col-span-2 flex justify-end gap-2 mt-3">
          <button type="submit" class="bg-emerald-500 text-white px-4 py-2 rounded">Save</button>
          <button type="button" id="delete-record-btn" class="bg-red-50 text-red-700 px-4 py-2 rounded">Delete</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* ------------------------
   Config & state (same as previous working version)
   ------------------------ */
const PRELOADED_RAW_URL = 'https://raw.githubusercontent.com/chetankdrmz-max/Smart_FarmHer/refs/heads/main/data/Raw_Concatenated.csv';
const STORAGE_KEY = 'agri_dashboard_store_v1';
let commodityRows = [], markets = [], filteredRows = [], currentCommodity = '', currentVariety='All';
let priceChart=null, forecastChart=null;

/* Simple IDB helpers (same as previous) */
function openIDB(){ return new Promise((res,rej)=>{ const req=indexedDB.open('agri_analyst_db_v1',1); req.onupgradeneeded=e=>{ const db=e.target.result; if(!db.objectStoreNames.contains('store_v1')) db.createObjectStore('store_v1'); }; req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); });}
async function idbPut(k,v){ const db=await openIDB(); return new Promise((res,rej)=>{ const tx=db.transaction('store_v1','readwrite'); tx.objectStore('store_v1').put(v,k); tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error); });}
async function idbGet(k){ const db=await openIDB(); return new Promise((res,rej)=>{ const tx=db.transaction('store_v1','readonly'); const req=tx.objectStore('store_v1').get(k); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); });}

/* Save/load */
async function saveToLocal(){ try{ const store={rows:commodityRows,markets}; localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); if(JSON.stringify(store).length>500000){ await idbPut(STORAGE_KEY, store); localStorage.removeItem(STORAGE_KEY); } }catch(e){ try{ await idbPut(STORAGE_KEY, {rows:commodityRows,markets}); }catch{} } }
function loadFromLocalSync(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ const parsed=JSON.parse(raw); commodityRows=parsed.rows||[]; markets=parsed.markets||[]; refreshAllUI(); return true; } }catch(e){} idbGet(STORAGE_KEY).then(obj=>{ if(obj){ commodityRows=obj.rows||[]; markets=obj.markets||[]; refreshAllUI(); } }).catch(()=>{}); return !!localStorage.getItem(STORAGE_KEY); }

/* CSV parsing */
function parseCSVFallback(text){ const rows=[]; let cur='',row=[],inQuotes=false; for(let i=0;i<text.length;i++){ const ch=text[i], next=text[i+1]; if(ch==='"'){ if(inQuotes && next==='"'){ cur+='"'; i++; } else { inQuotes=!inQuotes; } continue; } if(ch===',' && !inQuotes){ row.push(cur); cur=''; continue; } if((ch=='\n' || ch=='\r') && !inQuotes){ if(ch=='\r' && next=='\n') i++; row.push(cur); rows.push(row); row=[]; cur=''; continue; } cur+=ch; } if(cur!=='' || row.length>0){ row.push(cur); rows.push(row);} const header = rows.shift().map(h=>h.trim()); return rows.map(r=>{ const obj={}; for(let i=0;i<header.length;i++) obj[header[i]]=r[i]!==undefined?r[i]:''; return obj; });}
function parseCSVText(text){ return new Promise((res)=>{ if(typeof Papa !== 'undefined'){ try{ const out=Papa.parse(text,{header:true,skipEmptyLines:true}); res(out.data); }catch(e){ res(parseCSVFallback(text)); } } else { res(parseCSVFallback(text)); } });}

/* Normalize row */
function normalizeRow(r){
  const dateStr = r.Date || r.date || r.DATE || '';
  const commodity = (r.Commodity || r.commodity || r.Item || '').toString().trim();
  const variety = (r.Variety || r.variety || r.SubVariety || '').toString().trim() || 'Default';
  const market = (r.Market || r.market || r.MarketName || '').toString().trim() || 'Default Market';
  const district = (r.District || r.district || '').toString().trim();
  const modal = parseFloat(r.Modal_Price_Kg || r.Modal_Price || r.modal || r.modalPrice || 0) || 0;
  const minp = parseFloat(r.Min_Price_Kg || r.Min_Price || r.min || 0) || 0;
  const maxp = parseFloat(r.Max_Price_Kg || r.Max_Price || r.max || 0) || 0;
  const category = (r.Category || r.category || '').toString().trim() || 'Other';
  const date = dateStr ? new Date(dateStr) : null;
  return { date, commodity, variety, market, district, modalPriceKg: modal, minPriceKg: minp, maxPriceKg: maxp, category };
}

/* Process preloaded or imported rows */
function processPreloadedData(rows){
  let parsed=[];
  if(!rows || !rows.length) return;
  if(Array.isArray(rows) && rows.length && typeof rows[0] === 'object' && !Array.isArray(rows[0])) parsed = rows;
  else if(Array.isArray(rows) && rows.length && Array.isArray(rows[0])){
    const header = rows[0].map(h => h.toString().trim());
    parsed = rows.slice(1).map(r => { const obj = {}; for(let i=0;i<header.length;i++) obj[header[i]] = r[i]!==undefined?r[i]:''; return obj;});
  } else parsed=[];
  const normalized = parsed.map(normalizeRow).filter(item => item && item.date instanceof Date && !isNaN(item.date.getTime()) && item.commodity);
  if(!normalized.length){ alert('No valid rows found in dataset'); return; }
  const foundMarkets = [...new Set(normalized.map(p=>p.market||'Default Market'))];
  if(!markets.length) markets = foundMarkets.map(n=>({name:n,lat:null,lon:null}));
  else foundMarkets.forEach(m=>{ if(!markets.find(x=>x.name===m)) markets.push({name:m,lat:null,lon:null}); });
  commodityRows = [...commodityRows, ...normalized];
  commodityRows.sort((a,b)=>new Date(a.date)-new Date(b.date));
  saveToLocal();
  refreshAllUI();
}

/* UI building and refresh (desktop + drawer sync) */
function refreshAllUI(){
  populateMarketSelect();
  populateMarketSelectDrawer();
  populateCategoryFilter();
  populateCategoryFilterDrawer();
  populateCommodityList();
  populateCommodityListDrawer();
  populateVarietyFilter();
  populateVarietyFilterDrawer();
  setDefaultDateRange();
  setDefaultDateRangeDrawer();
  applyFilters();
  updateSnapshotTable();
  updateSummaryCards();
  updatePriceChart();
  updateDataTable();
  if(document.getElementById('prediction-content') && !document.getElementById('prediction-content').classList.contains('hidden')) computeForecastAndRender();
}

/* Market select populate */
function populateMarketSelect(){
  const sel = document.getElementById('market-select'); if(!sel) return;
  sel.innerHTML=''; markets.forEach(m=>{ const o=document.createElement('option'); o.value=m.name; o.textContent=m.name; sel.appendChild(o); });
  if(!markets.length){ markets.push({name:'Mysore (Bandipalya)',lat:null,lon:null}); populateMarketSelect(); }
}
function populateMarketSelectDrawer(){ const sel=document.getElementById('market-select-drawer'); if(!sel) return; sel.innerHTML=''; markets.forEach(m=>{ const o=document.createElement('option'); o.value=m.name; o.textContent=m.name; sel.appendChild(o); }); }

/* Category populate (desktop & drawer) */
function populateCategoryFilter(){ const sel=document.getElementById('category-filter'); if(!sel) return; const cats=[...new Set(commodityRows.map(r=>r.category||'Other'))].sort(); sel.innerHTML='<option>All</option>'; cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); }); }
function populateCategoryFilterDrawer(){ const sel=document.getElementById('category-filter-drawer'); if(!sel) return; const cats=[...new Set(commodityRows.map(r=>r.category||'Other'))].sort(); sel.innerHTML='<option>All</option>'; cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); }); }

/* Commodity list: desktop */
function populateCommodityList(){
  const container = document.getElementById('commodity-list'); if(!container) return;
  const selCat = (document.getElementById('category-filter')||{}).value || 'All';
  const comms = [...new Set(commodityRows.filter(r=> selCat==='All' || r.category===selCat).map(r=>r.commodity))].sort();
  container.innerHTML='';
  comms.forEach(c=>{
    const btn = document.createElement('button'); btn.className='commodity-btn'; btn.textContent = c; btn.setAttribute('data-commodity', c);
    if(currentCommodity && currentCommodity === c) btn.classList.add('active');
    btn.addEventListener('click', ()=>{ document.querySelectorAll('.commodity-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); currentCommodity = c; populateVarietyFilter(); populateVarietyFilterDrawer(); applyFilters(); });
    container.appendChild(btn);
  });
  if(!currentCommodity && comms.length){ currentCommodity = comms[0]; const first = container.querySelector('.commodity-btn'); if(first) first.classList.add('active'); populateVarietyFilter(); populateVarietyFilterDrawer(); }
}

/* Commodity list: drawer */
function populateCommodityListDrawer(){
  const container = document.getElementById('commodity-list-drawer'); if(!container) return;
  const selCat = (document.getElementById('category-filter-drawer')||{}).value || 'All';
  const comms = [...new Set(commodityRows.filter(r=> selCat==='All' || r.category===selCat).map(r=>r.commodity))].sort();
  container.innerHTML='';
  comms.forEach(c=>{
    const btn = document.createElement('button'); btn.className='commodity-btn'; btn.textContent=c; btn.setAttribute('data-commodity',c);
    if(currentCommodity && currentCommodity===c) btn.classList.add('active');
    btn.addEventListener('click', ()=>{ document.querySelectorAll('#commodity-list-drawer .commodity-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); currentCommodity = c; populateVarietyFilter(); populateVarietyFilterDrawer(); applyFilters(); });
    container.appendChild(btn);
  });
  if(!currentCommodity && comms.length){ currentCommodity = comms[0]; const first = container.querySelector('.commodity-btn'); if(first) first.classList.add('active'); populateVarietyFilter(); populateVarietyFilterDrawer(); }
}

/* Variety filters (desktop & drawer) */
function populateVarietyFilter(){
  const sel = document.getElementById('variety-filter'); if(!sel) return;
  const varieties = [...new Set(commodityRows.filter(r=>r.commodity===currentCommodity).map(r=>r.variety||'Default'))].sort();
  sel.innerHTML = '<option>All</option>'; varieties.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  sel.value='All';
}
function populateVarietyFilterDrawer(){
  const sel = document.getElementById('variety-filter-drawer'); if(!sel) return;
  const varieties = [...new Set(commodityRows.filter(r=>r.commodity===currentCommodity).map(r=>r.variety||'Default'))].sort();
  sel.innerHTML = '<option>All</option>'; varieties.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  sel.value='All';
}

/* Default date range */
function setDefaultDateRange(){
  if(!commodityRows.length) return;
  const dates = commodityRows.map(r=>new Date(r.date));
  const maxDate = new Date(Math.max.apply(null, dates));
  const minDate = new Date(Math.min.apply(null, dates));
  const endEl = document.getElementById('end-date'); const startEl = document.getElementById('start-date');
  if(endEl) endEl.value = maxDate.toISOString().split('T')[0];
  const startCandidate = new Date(maxDate); startCandidate.setFullYear(startCandidate.getFullYear()-1);
  if(startEl) startEl.value = (startCandidate < minDate ? minDate : startCandidate).toISOString().split('T')[0];
}
function setDefaultDateRangeDrawer(){
  if(!commodityRows.length) return;
  const dates = commodityRows.map(r=>new Date(r.date));
  const maxDate = new Date(Math.max.apply(null, dates));
  const minDate = new Date(Math.min.apply(null, dates));
  const endEl = document.getElementById('end-date-drawer'); const startEl = document.getElementById('start-date-drawer');
  if(endEl) endEl.value = maxDate.toISOString().split('T')[0];
  const startCandidate = new Date(maxDate); startCandidate.setFullYear(startCandidate.getFullYear()-1);
  if(startEl) startEl.value = (startCandidate < minDate ? minDate : startCandidate).toISOString().split('T')[0];
}

/* Apply filters (syncs desktop & drawer) */
function applyFilters(){
  // sync drawer values into main if drawer used
  const startValDrawer = document.getElementById('start-date-drawer')?.value;
  const endValDrawer = document.getElementById('end-date-drawer')?.value;
  if(startValDrawer) document.getElementById('start-date').value = startValDrawer;
  if(endValDrawer) document.getElementById('end-date').value = endValDrawer;
  const catDrawer = document.getElementById('category-filter-drawer')?.value;
  if(catDrawer) document.getElementById('category-filter').value = catDrawer;

  // ensure current commodity exists
  if(!currentCommodity){
    const first = document.querySelector('.commodity-btn');
    if(first) currentCommodity = first.getAttribute('data-commodity');
  }
  currentVariety = document.getElementById('variety-filter')?.value || 'All';
  const start = new Date((document.getElementById('start-date')||{}).value || '1970-01-01');
  const end = new Date((document.getElementById('end-date')||{}).value || '2100-01-01');
  const cat = (document.getElementById('category-filter')||{}).value || 'All';
  filteredRows = commodityRows.filter(r=>{
    return (cat==='All' || r.category===cat) &&
           (r.commodity===currentCommodity) &&
           (currentVariety==='All' || r.variety===currentVariety) &&
           (new Date(r.date) >= start && new Date(r.date) <= end);
  }).sort((a,b)=>new Date(a.date)-new Date(b.date));
  updateDashboardUI();
  // close drawer if open (mobile)
  closeDrawer();
}

function resetFilters(){
  document.getElementById('category-filter').value='All';
  document.getElementById('category-filter-drawer').value='All';
  currentCommodity=''; populateCommodityList(); populateCommodityListDrawer();
  setDefaultDateRange(); setDefaultDateRangeDrawer();
  applyFilters();
}

/* Update dashboard UI pieces */
function updateDashboardUI(){
  document.getElementById('main-header').textContent = currentCommodity ? `${currentCommodity} Dashboard` : 'Dashboard';
  updateSnapshotTable();
  updateSummaryCards();
  updatePriceChart();
  updateDataTable();
  renderWeatherForCurrentMarket();
  if(!document.getElementById('prediction-content').classList.contains('hidden')) computeForecastAndRender();
}

function updateSnapshotTable(){
  const body = document.getElementById('snapshot-table-body'); if(!body) return;
  if(!commodityRows.length){ body.innerHTML='<tr><td colspan="7" class="text-center p-4 small-muted">No data loaded.</td></tr>'; return; }
  const dates = commodityRows.map(r=>new Date(r.date));
  const latest = new Date(Math.max.apply(null, dates));
  const latestStr = latest.toISOString().split('T')[0];
  document.getElementById('snapshot-date').textContent = `(${latest.toLocaleDateString('en-GB')})`;
  const snapshot = commodityRows.filter(r => (new Date(r.date)).toISOString().split('T')[0] === latestStr);
  document.getElementById('snapshot-count').textContent = snapshot.length;
  if(!snapshot.length){ body.innerHTML='<tr><td colspan="7" class="text-center p-4 small-muted">No data for latest date.</td></tr>'; return; }
  body.innerHTML = snapshot.map(s=>{
    const related = commodityRows.filter(rr=>rr.commodity===s.commodity && rr.variety===s.variety && rr.market===s.market).sort((a,b)=>new Date(a.date)-new Date(b.date));
    let trendHtml='â€”';
    if(related.length>=2){ const last=related[related.length-1].modalPriceKg, prev=related[related.length-2].modalPriceKg; if(last>prev) trendHtml='<span style="color:#059669">â–²</span>'; else if(last<prev) trendHtml='<span style="color:#ef4444">â–¼</span>'; else trendHtml='â€”'; }
    return `<tr><td class="p-3">${s.market}</td><td class="p-3">${s.commodity}</td><td class="p-3">${s.variety}</td><td class="p-3 text-right">â‚¹${s.modalPriceKg.toFixed(2)}</td><td class="p-3 text-right">â‚¹${s.minPriceKg.toFixed(2)}</td><td class="p-3 text-right">â‚¹${s.maxPriceKg.toFixed(2)}</td><td class="p-3 text-center">${trendHtml}</td></tr>`;
  }).join('');
}

function updateSummaryCards(){
  const container = document.getElementById('summary-cards'); if(!container) return;
  if(!filteredRows.length){ container.innerHTML='<div class="card small-muted text-center">No data for selection</div>'; return; }
  const latest = filteredRows[filteredRows.length-1];
  const prev = filteredRows[filteredRows.length-2] || latest;
  const prices = filteredRows.map(r=>r.modalPriceKg);
  const avg = prices.reduce((a,b)=>a+b,0)/prices.length;
  const minP = Math.min(...prices), maxP=Math.max(...prices);
  const cards = [
    {title:'Latest Price', value:`â‚¹${latest.modalPriceKg.toFixed(2)}`, sub:currentCommodity||''},
    {title:'Average Price', value:`â‚¹${avg.toFixed(2)}`, sub:'Period Avg'},
    {title:'Lowest Price', value:`â‚¹${minP.toFixed(2)}`, sub:'In Period'},
    {title:'Highest Price', value:`â‚¹${maxP.toFixed(2)}`, sub:'In Period'}
  ];
  container.innerHTML = cards.map(c=>`<div class="card"><div class="small-muted">${c.title}</div><div style="font-weight:700;font-size:18px;margin-top:6px">${c.value}</div><div class="small-muted mt-1">${c.sub||''}</div></div>`).join('');
}

/* Charts */
function updatePriceChart(){
  const ctx = document.getElementById('price-chart')?.getContext('2d'); if(!ctx) return;
  if(priceChart) priceChart.destroy();
  if(!filteredRows.length){ ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height); return; }
  const data = filteredRows.map(r=>({x:new Date(r.date), y:r.modalPriceKg}));
  priceChart = new Chart(ctx, {
    type:'line',
    data:{ datasets:[ { label:'Price Trend', data, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.06)', fill:true, tension:0.25, pointRadius:2 } ] },
    options:{ parsing:false, maintainAspectRatio:false, responsive:true, scales:{ x:{ type:'time', time:{unit:'month'}, grid:{color:'rgba(15,23,42,0.04)'} }, y:{ grid:{color:'rgba(15,23,42,0.04)'} } }, plugins:{ legend:{display:true, position:'top'} } }
  });
}

/* Data table */
function updateDataTable(){
  const body = document.getElementById('price-table-body'); if(!body) return;
  if(!filteredRows.length){ body.innerHTML = '<tr><td colspan="8" class="text-center p-4 small-muted">No data</td></tr>'; return; }
  const last = filteredRows.slice(-20).reverse();
  body.innerHTML = last.map(r=>`<tr class="border-b"><td class="p-3">${new Date(r.date).toLocaleDateString()}</td><td class="p-3">${r.market}</td><td class="p-3">${r.commodity}</td><td class="p-3">${r.variety}</td><td class="p-3 text-right">â‚¹${r.modalPriceKg.toFixed(2)}</td><td class="p-3 text-right">â‚¹${r.minPriceKg.toFixed(2)}</td><td class="p-3 text-right">â‚¹${r.maxPriceKg.toFixed(2)}</td><td class="p-3 text-center">â€”</td></tr>`).join('');
}

/* Forecasting (simple deterministic) */
function computeSimpleForecast(series, days=90){
  if(!series.length) return [];
  const prices = series.map(s=>s.y);
  const smooth = prices.map((v,i,arr)=>{ const w=7; const start=Math.max(0,i-w+1); const seg=arr.slice(start,i+1); return seg.reduce((a,b)=>a+b,0)/seg.length; });
  const N = Math.min(90, smooth.length);
  const x=[]; const y=[];
  for(let i=0;i<N;i++){ x.push(i); y.push(smooth[smooth.length-N+i]); }
  const xm = x.reduce((a,b)=>a+b,0)/x.length;
  const ym = y.reduce((a,b)=>a+b,0)/y.length;
  let num=0, den=0;
  for(let i=0;i<x.length;i++){ num+=(x[i]-xm)*(y[i]-ym); den+=(x[i]-xm)*(x[i]-xm); }
  const slope = den===0?0:num/den;
  const intercept = ym - slope*xm;
  const lastDate = new Date(series[series.length-1].date);
  const forecasts = [];
  for(let d=1; d<=days; d++){
    const pred = intercept + slope*(N + d);
    forecasts.push({date: new Date(lastDate.getTime() + 24*3600*1000*d), y: Math.max(0, pred)});
  }
  return forecasts;
}

function computeForecastAndRender(){
  if(!filteredRows.length){ document.getElementById('strategy-signal').textContent='â€”'; return; }
  const series = filteredRows.map(r=>({date:new Date(r.date), y:r.modalPriceKg}));
  if(series.length < 30){
    document.getElementById('strategy-signal').textContent = 'Not enough data';
    document.getElementById('strategy-detail').textContent = 'Not enough historical data for reliable forecast (need >= 30 days).';
    document.getElementById('peak-month').textContent = 'â€”';
    const ctx = document.getElementById('forecast-chart')?.getContext('2d'); if(ctx && forecastChart) forecastChart.destroy();
    document.getElementById('prediction-outlook').innerHTML = '<div class="card small-muted">Not enough historical data for a reliable forecast (~30 points required).</div>';
    return;
  }
  const forecast = computeSimpleForecast(series,90);
  const ctx = document.getElementById('forecast-chart')?.getContext('2d'); if(!ctx) return;
  if(forecastChart) forecastChart.destroy();
  const dataHist = series.map(s=>({x:s.date,y:s.y}));
  const dataFc = forecast.map(f=>({x:f.date,y:f.y}));
  forecastChart = new Chart(ctx, {
    type:'line',
    data:{ datasets:[
      { label:'Historical Price', data: dataHist, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.06)', fill:true, tension:0.25, pointRadius:0 },
      { label:'Forecasted Price', data: dataFc, borderColor:'#ef4444', borderDash:[6,6], pointRadius:0, fill:false, tension:0.25 }
    ] },
    options:{ parsing:false, maintainAspectRatio:false, responsive:true, scales:{ x:{ type:'time', time:{unit:'month'} }, y:{ beginAtZero:false } }, plugins:{ legend:{display:true,position:'top'} } }
  });

  // Strategic signal: only two outcomes
  const fvals = forecast.slice(0,30).map(f=>f.y);
  const sl = (fvals[fvals.length-1] - fvals[0]) / Math.max(1, fvals[0]);
  const avgHist = series.reduce((a,b)=>a+b.y,0)/series.length;
  const variance = series.reduce((s,p)=>s+Math.pow(p.y-avgHist,2),0)/series.length;
  const vol = Math.sqrt(variance)/Math.max(1,avgHist);
  const confidence = Math.max(0,Math.min(100,100 - vol*200));
  let signal='Wait', detail='Prices are forecast to be stable or decrease.';
  const card = document.getElementById('strategy-signal-card');
  if(sl > 0.08 && confidence > 30){ signal='Grow Now'; detail='Prices are currently above average and trend shows growth â€” consider planting now.'; card.className='card'; card.style.background='linear-gradient(180deg,#ecfdf5,transparent)'; }
  else if(sl > 0.02){ signal='Consider Growing'; detail='The 90-day forecast shows a gentle positive trend.'; card.className='card'; card.style.background='linear-gradient(180deg,#ecfdf5,transparent)'; }
  else { signal='Wait'; detail='Prices are forecast to be stable or decrease.'; card.className='card'; card.style.background='linear-gradient(180deg,#fff7ed,transparent)'; }
  document.getElementById('strategy-signal').textContent = signal;
  document.getElementById('strategy-detail').textContent = detail;
  const monthly = {}; filteredRows.forEach(r=>{ const m=new Date(r.date).getMonth()+1; monthly[m]=monthly[m]||[]; monthly[m].push(r.modalPriceKg); });
  const avgByMonth = Object.keys(monthly).map(k=>({m:parseInt(k), avg: monthly[k].reduce((a,b)=>a+b,0)/monthly[k].length}));
  if(avgByMonth.length){ const peak = avgByMonth.reduce((a,b)=>a.avg>b.avg?a:b); const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; document.getElementById('peak-month').textContent = months[peak.m-1]; } else document.getElementById('peak-month').textContent='â€”';
  const avg30 = (forecast.slice(0,30).reduce((a,b)=>a+b.y,0)/Math.max(1,forecast.slice(0,30).length));
  document.getElementById('prediction-outlook').innerHTML = `<div class="card"><strong>Forecast summary:</strong> Next 90 days: ${(sl>0.05)?'positive':(sl<-0.05?'negative':'neutral')}. Forecast avg (30d): â‚¹${avg30.toFixed(2)}</div>`;
}

/* Recommendations (same logic) */
function generateRecommendations(count=10){
  const commodities = [...new Set(commodityRows.map(r=>r.commodity))];
  const recs = commodities.map(name=>{
    const rows = commodityRows.filter(r=>r.commodity===name).slice(-90);
    if(rows.length < 6) return null;
    const prices = rows.map(r=>r.modalPriceKg);
    const avg = prices.reduce((a,b)=>a+b,0)/prices.length;
    const change = (prices[prices.length-1]-prices[0]) / Math.max(1, prices[0]);
    const variance = prices.reduce((s,p)=>s+Math.pow(p-avg,2),0)/prices.length;
    const vol = Math.sqrt(variance)/Math.max(1,avg);
    const score = (1 + change) / (vol + 0.05);
    const risk = vol < 0.1 ? 'Low' : vol < 0.2 ? 'Medium' : 'High';
    return {commodity:name, avgPrice:avg, priceChangePct: change*100, volatility: vol, score, risk};
  }).filter(Boolean).sort((a,b)=>b.score-a.score);
  return recs.slice(0,count);
}
function generateTopCropsUI(){
  const recs = generateRecommendations(10);
  const cont = document.getElementById('top-crops-container'); if(!cont) return;
  if(!recs.length){ cont.innerHTML = '<div class="small-muted">No recommendations available - load more data.</div>'; return; }
  cont.innerHTML = recs.map((r,i)=>`<div class="card"><div class="flex justify-between"><div><div class="text-sm text-slate-500">#${i+1}</div><div class="font-bold">${r.commodity}</div><div class="small-muted mt-1">Avg â‚¹${r.avgPrice.toFixed(2)}/kg</div></div><div><span class="${r.risk==='Low'?'bg-green-50 text-green-700':'bg-yellow-50 text-yellow-700'} px-2 py-1 rounded">${r.risk} RISK</span></div></div></div>`).join('');
}

/* Weather helper */
async function renderWeatherForCurrentMarket(){
  const sel = document.getElementById('market-select'); if(!sel) return;
  const marketName = sel.value;
  const market = markets.find(m=>m.name===marketName);
  const container = document.getElementById('weather-container'); if(!container) return;
  if(!market || !market.lat || !market.lon){ container.innerHTML = `<div class="small-muted">No coordinates for "${marketName}". Use Manage or location detect to add coordinates.</div>`; return; }
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${market.lat}&longitude=${market.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;
  try { const res = await fetch(url); const json = await res.json(); if(!json.daily){ container.innerHTML = `<div class="small-muted">Weather not available</div>`; return; } const days = json.daily.time.map((t,i)=>({date:t,max:json.daily.temperature_2m_max[i],min:json.daily.temperature_2m_min[i],precip:json.daily.precipitation_sum[i]})); container.innerHTML = days.map(d=>`<div class="mb-2"><strong>${new Date(d.date).toLocaleDateString()}</strong>: ${d.max}Â°/${d.min}Â° - Rain ${d.precip} mm</div>`).join(''); } catch(e){ container.innerHTML = `<div class="small-muted">Weather fetch error</div>`; }
}

/* File import */
async function handleFileImport(file){
  if(!file) return;
  try {
    const name = file.name.toLowerCase();
    if(name.endsWith('.csv') || file.type.includes('text')){
      const text = await file.text();
      const rows = await parseCSVText(text);
      processPreloadedData(rows);
    } else {
      const ab = await file.arrayBuffer();
      const wb = XLSX.read(ab,{type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet,{defval:''});
      processPreloadedData(rows);
    }
    alert('Imported successfully');
    showDashboardAfterLoad();
  } catch(e){ console.error(e); alert('Import failed: ' + (e.message||e)); }
}

/* Show dashboard after load (keeps start screen until user loads) */
function showDashboardAfterLoad(){ document.getElementById('start-screen').style.display='none'; document.getElementById('main-dashboard').classList.remove('hidden'); refreshAllUI(); }

/* Drawer open/close */
function openDrawer(){ document.getElementById('drawer-backdrop').classList.add('open'); document.getElementById('drawer').classList.add('open'); document.getElementById('drawer-backdrop').style.display='flex'; document.getElementById('drawer-backdrop').setAttribute('aria-hidden','false'); }
function closeDrawer(){ document.getElementById('drawer-backdrop').classList.remove('open'); document.getElementById('drawer').classList.remove('open'); document.getElementById('drawer-backdrop').style.display='none'; document.getElementById('drawer-backdrop').setAttribute('aria-hidden','true'); }

/* Wiring after DOM ready */
document.addEventListener('DOMContentLoaded', ()=>{
  // start visible, main hidden
  document.getElementById('start-screen').style.display='';
  document.getElementById('main-dashboard').classList.add('hidden');

  // file input
  document.getElementById('file-input')?.addEventListener('change', e=>handleFileImport(e.target.files[0]));
  document.getElementById('import-csv-btn')?.addEventListener('click', ()=>document.getElementById('file-input').click());
  document.getElementById('import-csv-drawer')?.addEventListener('click', ()=>document.getElementById('file-input').click());

  // load preloaded
  document.getElementById('start-analysis-btn')?.addEventListener('click', async ()=>{
    if(!PRELOADED_RAW_URL){ alert('No PRELOADED_RAW_URL'); return; }
    try {
      alert('Preloaded dataset loading...');
      const resp = await fetch(PRELOADED_RAW_URL);
      if(!resp.ok) throw new Error('Fetch failed: ' + resp.status);
      const ct = resp.headers.get('content-type')||'';
      const blob = await resp.blob();
      if(ct.includes('text') || PRELOADED_RAW_URL.toLowerCase().endsWith('.csv')) {
        const text = await blob.text(); const rows = await parseCSVText(text); processPreloadedData(rows);
      } else {
        const ab = await blob.arrayBuffer(); const wb = XLSX.read(ab,{type:'array'}); const sheet = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(sheet,{defval:''}); processPreloadedData(rows);
      }
      setTimeout(()=>showDashboardAfterLoad(), 250);
    } catch(e){ console.error(e); alert('Preload failed: ' + (e.message||e)); }
  });

  // load saved local
  document.getElementById('load-local-btn')?.addEventListener('click', ()=>{ loadFromLocalSync(); showDashboardAfterLoad(); });

  // drawer open/close bindings
  document.getElementById('open-drawer-btn')?.addEventListener('click', openDrawer);
  document.getElementById('close-drawer')?.addEventListener('click', closeDrawer);
  document.getElementById('drawer-backdrop')?.addEventListener('click', function(e){ if(e.target === this) closeDrawer(); });

  // apply/reset filters (desktop and drawer)
  document.getElementById('apply-filters')?.addEventListener('click', applyFilters);
  document.getElementById('apply-filters-drawer')?.addEventListener('click', applyFilters);
  document.getElementById('reset-filters')?.addEventListener('click', resetFilters);
  document.getElementById('reset-filters-drawer')?.addEventListener('click', resetFilters);

  // basic buttons
  document.getElementById('export-csv')?.addEventListener('click', ()=>{
    const rows = filteredRows.map(r=>[new Date(r.date).toISOString().split('T')[0], r.market, r.commodity, r.variety, r.minPriceKg, r.maxPriceKg, r.modalPriceKg]);
    if(!rows.length){ alert('No visible rows'); return; }
    const csv = ['Date,Market,Commodity,Variety,Min,Max,Modal', ...rows.map(r=>r.join(','))].join('\n');
    const link = document.createElement('a'); link.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); link.download='export_filtered.csv'; document.body.appendChild(link); link.click(); link.remove();
  });
  document.getElementById('export-all-btn')?.addEventListener('click', ()=>{ if(!commodityRows.length){ alert('No data'); return; } const headers=['Date','Market','Commodity','Variety','Category','District','Min','Max','Modal']; const rows=commodityRows.map(r=>[new Date(r.date).toISOString().split('T')[0],r.market,r.commodity,r.variety,r.category,r.district,r.minPriceKg,r.maxPriceKg,r.modalPriceKg]); const csv=[headers.join(','), ...rows.map(rr=>rr.map(cell=>typeof cell==='string' && cell.includes(',')?`"${cell.replace(/"/g,'""')}"`:cell).join(',')).join('\n')]; const link=document.createElement('a'); link.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv.join('\n')); link.download='agri_export.csv'; document.body.appendChild(link); link.click(); link.remove(); });
  document.getElementById('clear-storage-btn')?.addEventListener('click', async ()=>{ if(!confirm('Clear all saved data?')) return; localStorage.removeItem(STORAGE_KEY); try{ const db = await openIDB(); const tx=db.transaction('store_v1','readwrite'); tx.objectStore('store_v1').delete(STORAGE_KEY); }catch{} commodityRows=[]; markets=[]; refreshAllUI(); alert('Cleared'); });

  // tabs
  document.getElementById('tab-dashboard')?.addEventListener('click', ()=>{ document.getElementById('dashboard-content').classList.remove('hidden'); document.getElementById('prediction-content').classList.add('hidden'); document.getElementById('top-crops-content').classList.add('hidden'); });
  document.getElementById('tab-prediction')?.addEventListener('click', ()=>{ document.getElementById('dashboard-content').classList.add('hidden'); document.getElementById('prediction-content').classList.remove('hidden'); document.getElementById('top-crops-content').classList.add('hidden'); computeForecastAndRender(); });
  document.getElementById('tab-top-crops')?.addEventListener('click', ()=>{ document.getElementById('dashboard-content').classList.add('hidden'); document.getElementById('prediction-content').classList.add('hidden'); document.getElementById('top-crops-content').classList.remove('hidden'); generateTopCropsUI(); });

  // Add record modal
  document.getElementById('add-record-btn')?.addEventListener('click', ()=>{ document.getElementById('modal-add-record').style.display='flex'; document.getElementById('rec-market').innerHTML = markets.map(m=>`<option>${m.name}</option>`).join(''); });
  document.getElementById('record-form')?.addEventListener('submit', (e)=>{ e.preventDefault(); const newRow = { date: new Date(document.getElementById('rec-date').value), market: document.getElementById('rec-market').value, commodity: document.getElementById('rec-commodity').value, variety: document.getElementById('rec-variety').value||'Default', category: document.getElementById('rec-category').value||'Other', district: document.getElementById('rec-district').value||'', modalPriceKg: parseFloat(document.getElementById('rec-modal').value)||0, minPriceKg: parseFloat(document.getElementById('rec-min').value)||0, maxPriceKg: parseFloat(document.getElementById('rec-max').value)||0 }; commodityRows.push(newRow); commodityRows.sort((a,b)=>new Date(a.date)-new Date(b.date)); saveToLocal(); document.getElementById('modal-add-record').style.display='none'; refreshAllUI(); });

  // geo locate
  document.getElementById('geo-locate')?.addEventListener('click', ()=>{ if(!navigator.geolocation){ alert('Geolocation not supported'); return; } navigator.geolocation.getCurrentPosition(pos=>{ const lat=pos.coords.latitude, lon=pos.coords.longitude; const name=`My Location (${lat.toFixed(3)},${lon.toFixed(3)})`; markets.unshift({name,lat,lon}); saveToLocal(); populateMarketSelect(); document.getElementById('market-select').value=name; renderWeatherForCurrentMarket(); alert('Location saved'); }, err=>{ alert('Failed to get location: ' + err.message); }); });
  document.getElementById('geo-drawer')?.addEventListener('click', ()=>document.getElementById('geo-locate').click());

  // file input for drawer import
  document.getElementById('import-csv-drawer')?.addEventListener('click', ()=>document.getElementById('file-input').click());

  // make date icons focus input
  document.querySelectorAll('.date-input-wrapper').forEach(wrapper=>{ const icon = wrapper.querySelector('.date-icon'); const input = wrapper.querySelector('input[type="date"]'); if(icon && input){ icon.addEventListener('click', ()=>input.focus()); } });

  // initial load saved (but don't auto-open dashboard)
  loadFromLocalSync();
});

/* Helper to close drawer if open (used after filters applied) */
function closeDrawerIfOpen(){ try{ closeDrawer(); }catch{} }

/* expose showDashboardAfterLoad for file import */
window.showDashboardAfterLoad = showDashboardAfterLoad;

</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart FarmHer — Grow Good — Sell Smart</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10b981">

  <!-- UI libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root{--emerald:#10b981;--slate-50:#f8fafc}
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f0f2f5; color:#0f172a; margin:0; }
    .sidebar { -ms-overflow-style: none; scrollbar-width: none; }
    .sidebar::-webkit-scrollbar { display: none; }
    .sidebar-item.active { background-color: var(--emerald); color: white; }
    .chart-container { position: relative; height: 360px; width: 100%; }
    .tab-active { border-bottom-color: var(--emerald); color: #059669; font-weight:600; }
    /* Start screen backgrounds */
    .start-bg {
      background-image: url('icons/bg-desktop.jpg'); /* desktop default */
      background-size: cover;
      background-position: center;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    @media (max-width: 768px) {
      .start-bg {
        background-image: url('icons/bg-mobile.png'); /* mobile image */
      }
    }
    /* translucent card */
    .card-blur { background: rgba(255,255,255,0.85); backdrop-filter: blur(6px); border-radius: 14px; padding: 22px; box-shadow: 0 10px 30px rgba(2,6,23,0.08); border: 1px solid rgba(15,23,42,0.05); }
    /* small utility */
    .hidden { display:none !important; }
  </style>
</head>
<body>

  <!-- START SCREEN -->
  <div id="start-screen" class="start-bg">
    <div class="w-full max-w-2xl p-4">
      <div class="card-blur">
        <div class="text-center">
          <h1 class="text-3xl font-bold text-emerald-600 mb-1"><i class="fas fa-seedling mr-2"></i>Smart FarmHer</h1>
          <div class="text-slate-600 mb-4 font-medium">Grow Good — Sell Smart</div>

          <div class="space-y-3 max-w-xl mx-auto">
            <input id="file-input" type="file" accept=".csv,.xlsx,.xls,text/csv" class="w-full p-2 border rounded" />
            <div class="flex gap-3">
              <button id="start-analysis-btn" class="flex-1 bg-emerald-600 text-white font-bold py-3 rounded-lg"><i class="fas fa-cloud-download-alt mr-2"></i>Load Preloaded Data</button>
              <button id="load-local-btn" class="bg-slate-700 text-white font-bold py-3 px-4 rounded-lg"><i class="fas fa-save mr-2"></i>Load Saved</button>
            </div>
            <p class="text-xs text-slate-500">Tip: Use import to add new rows anytime. Use "Load Saved" to restore previous data from your device.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN DASHBOARD -->
  <div id="main-dashboard" class="hidden h-screen bg-slate-100">
    <div class="flex h-full min-h-screen">
      <!-- Sidebar -->
      <aside class="w-72 bg-white border-r p-3 flex flex-col sidebar overflow-y-auto">
        <div class="h-14 flex items-center justify-between border-b mb-3">
          <div class="flex items-center gap-2">
            <i class="fas fa-seedling text-emerald-600 text-xl"></i>
            <span class="font-bold text-emerald-600">Smart FarmHer</span>
          </div>
        </div>

        <div class="mb-3">
          <label class="text-xs font-semibold text-slate-500 uppercase">Markets</label>
          <select id="market-select" class="w-full rounded-md p-2 border text-sm mt-1"></select>
          <div class="mt-2 text-xs text-slate-400">Select market to show weather & specific prices</div>
        </div>

        <div class="mb-3">
          <label class="text-xs font-semibold text-slate-500 uppercase">Filters</label>
          <select id="category-filter" class="w-full rounded-md p-2 border text-sm mt-1"><option value="All">All</option></select>
          <div id="commodity-list" class="h-28 overflow-y-auto border rounded p-1 mt-2"></div>
          <select id="variety-filter" class="w-full rounded-md p-2 border text-sm mt-2"></select>

          <label class="text-xs mt-3">Date range</label>
          <div class="flex gap-2 mt-1">
            <input id="start-date" type="date" class="rounded-md p-2 border text-sm w-1/2"/>
            <input id="end-date" type="date" class="rounded-md p-2 border text-sm w-1/2"/>
          </div>

          <div class="flex gap-2 mt-3">
            <button id="apply-filters" class="flex-1 bg-emerald-600 text-white py-2 rounded-md">Apply</button>
            <button id="reset-filters" class="flex-1 bg-slate-200 py-2 rounded-md">Reset</button>
          </div>
        </div>

        <div class="mt-auto space-y-2">
          <button id="add-record-btn" class="w-full bg-blue-500 text-white py-2 rounded-md"><i class="fas fa-plus mr-2"></i>Add Record</button>
          <button id="import-csv-btn" class="w-full bg-slate-800 text-white py-2 rounded-md"><i class="fas fa-file-import mr-2"></i>Import CSV/XLSX</button>
          <button id="export-all-btn" class="w-full bg-slate-200 text-slate-800 py-2 rounded-md"><i class="fas fa-file-export mr-2"></i>Export CSV (All)</button>
          <button id="clear-storage-btn" class="w-full bg-red-50 text-red-600 py-2 rounded-md"><i class="fas fa-trash mr-2"></i>Clear Local Save</button>
          <div class="text-xs text-slate-400 mt-2">All edits save locally to your device. Export before clearing.</div>
        </div>
      </aside>

      <!-- Main content -->
      <main class="flex-1 overflow-y-auto p-6">
        <header class="flex items-center justify-between mb-6">
          <h2 id="main-header" class="text-2xl font-bold">Dashboard</h2>
          <div class="flex items-center gap-3">
            <button id="get-recommendations" class="bg-yellow-500 text-white py-2 px-4 rounded-md"><i class="fas fa-star mr-2"></i>Quick Recommendations</button>
            <button id="show-help-btn" class="bg-slate-200 py-2 px-4 rounded-md">Help</button>
          </div>
        </header>

        <div class="border-b mb-4">
          <nav class="flex gap-6">
            <button id="tab-dashboard" class="tab-active py-3 px-1 border-b-2 font-medium">Dashboard</button>
            <button id="tab-prediction" class="py-3 px-1 text-gray-500">Prediction & Weather</button>
            <button id="tab-top-crops" class="py-3 px-1 text-gray-500">Top 10 Crops</button>
          </nav>
        </div>

        <!-- Dashboard content -->
        <div id="dashboard-content">
          <div class="bg-white p-4 rounded-lg shadow mb-4">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-semibold text-lg">Latest Market Snapshot <span id="snapshot-date" class="text-emerald-600"></span></h3>
                <p class="text-xs text-slate-500">Shows last available day across markets</p>
              </div>
              <div class="text-xs text-slate-500">Rows: <span id="snapshot-count">0</span></div>
            </div>

            <div class="overflow-x-auto mt-3">
              <table class="w-full text-sm text-left">
                <thead class="text-xs text-slate-600 bg-slate-50">
                  <tr><th class="p-2">Market</th><th class="p-2">Commodity</th><th class="p-2">Variety</th><th class="p-2">Modal (₹/kg)</th><th class="p-2">Min</th><th class="p-2">Max</th></tr>
                </thead>
                <tbody id="snapshot-table-body"></tbody>
              </table>
            </div>
          </div>

          <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"></div>

          <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-4">
            <div class="lg:col-span-3 bg-white p-4 rounded shadow">
              <h4 class="font-semibold mb-2">Historical Price Trends</h4>
              <div class="chart-container"><canvas id="price-chart"></canvas></div>
            </div>
            <div class="lg:col-span-2 bg-white p-4 rounded shadow">
              <h4 class="font-semibold mb-2">Price Distribution</h4>
              <div class="chart-container"><canvas id="distribution-chart"></canvas></div>
            </div>
          </div>

          <div class="bg-white p-4 rounded shadow">
            <div class="flex justify-between items-center mb-2">
              <h4 class="font-semibold">Detailed Price Data (last 20 rows)</h4>
              <div class="text-xs text-slate-500">Click a row to edit</div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="text-xs text-slate-600 bg-slate-50">
                  <tr><th class="p-2">Date</th><th class="p-2">Market</th><th class="p-2">Commodity</th><th class="p-2">Variety</th><th class="p-2">Modal</th><th class="p-2">Min</th><th class="p-2">Max</th></tr>
                </thead>
                <tbody id="price-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Prediction & Weather -->
        <div id="prediction-content" class="hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2 bg-white p-4 rounded shadow">
              <h4 class="font-semibold mb-2">90-Day Forecast (Selected Commodity / Market)</h4>
              <div class="chart-container"><canvas id="forecast-chart"></canvas></div>
            </div>
            <div class="bg-white p-4 rounded shadow">
              <h4 class="font-semibold mb-2">7-day Weather (Selected Market)</h4>
              <div id="weather-container" class="space-y-2 text-sm text-slate-700"></div>
              <div class="mt-4 text-xs text-slate-500">Weather provided by Open-Meteo (free, no key)</div>
            </div>
          </div>
          <div id="prediction-outlook" class="mt-4"></div>
        </div>

        <!-- Top 10 Crops -->
        <div id="top-crops-content" class="hidden">
          <div class="bg-white p-4 rounded shadow mb-4">
            <h4 class="font-semibold">Top 10 Crops to Grow Next</h4>
            <p class="text-xs text-slate-500">Ranked by profitability: average price, short-term trend, and stability (low volatility)</p>
          </div>
          <div id="top-crops-container" class="space-y-2"></div>
          <div id="grow-sheet" class="mt-4"></div>
          <div id="video-recommendations" class="mt-4"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add / Edit Record modal (simplified version) -->
  <div id="modal-add-record" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
    <div class="bg-white w-full max-w-2xl rounded p-4">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-bold text-lg">Add / Edit Record</h3>
        <button id="close-add-record" class="text-slate-500">&times;</button>
      </div>
      <form id="record-form" class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div><label class="text-xs">Date</label><input id="rec-date" type="date" class="w-full p-2 border rounded" required></div>
        <div><label class="text-xs">Market</label><select id="rec-market" class="w-full p-2 border rounded"></select></div>
        <div><label class="text-xs">Commodity</label><input id="rec-commodity" type="text" class="w-full p-2 border rounded" required></div>
        <div><label class="text-xs">Variety</label><input id="rec-variety" type="text" class="w-full p-2 border rounded"></div>
        <div><label class="text-xs">Category</label><input id="rec-category" type="text" class="w-full p-2 border rounded"></div>
        <div><label class="text-xs">District</label><input id="rec-district" type="text" class="w-full p-2 border rounded"></div>
        <div><label class="text-xs">Modal Price (₹/kg)</label><input id="rec-modal" type="number" step="0.01" class="w-full p-2 border rounded"></div>
        <div><label class="text-xs">Min Price (₹/kg)</label><input id="rec-min" type="number" step="0.01" class="w-full p-2 border rounded"></div>
        <div><label class="text-xs">Max Price (₹/kg)</label><input id="rec-max" type="number" step="0.01" class="w-full p-2 border rounded"></div>

        <div class="md:col-span-2 flex gap-2 mt-2">
          <button type="submit" class="flex-1 bg-emerald-600 text-white py-2 rounded">Save</button>
          <button id="delete-record-btn" type="button" class="flex-1 bg-red-50 text-red-600 py-2 rounded hidden">Delete</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* -------------------------
   Configuration & Constants
   ------------------------- */

/*
 Replace PRELOADED_RAW_URL with your raw.githubusercontent link if you change branch/filename.
 Example format:
 https://raw.githubusercontent.com/<username>/<repo>/<branch-or-commit>/data/Raw_Concatenated.xlsx
*/
const PRELOADED_RAW_URL = 'https://raw.githubusercontent.com/chetankdrmz-max/Appuge/0d8156a2def60e731e41efb36b95b785a4e6d92b/data/Raw_Concatenated.xlsx';

/* Storage keys */
const STORAGE_KEY = 'agri_dashboard_store_v1';
const IDB_DBNAME = 'agri_analyst_db_v1';
const IDB_STORE = 'store_v1';

/* In-memory data */
let commodityRows = []; // each row: { date: Date, commodity, variety, market, district, modalPriceKg, minPriceKg, maxPriceKg, category }
let markets = []; // market objects: {name, lat, lon}
let filteredRows = [];
let currentCommodity = '';
let currentVariety = 'All';

/* Charts */
let priceChart = null, distributionChart = null, forecastChart = null;

/* -------------------------
   Small helpers: IndexedDB
   ------------------------- */
function openIDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(IDB_DBNAME, 1);
    req.onupgradeneeded = evt => {
      const db = evt.target.result;
      if (!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE);
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function idbPut(key, value) {
  const db = await openIDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, 'readwrite');
    tx.objectStore(IDB_STORE).put(value, key);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}
async function idbGet(key) {
  const db = await openIDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, 'readonly');
    const req = tx.objectStore(IDB_STORE).get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function idbDelete(key) {
  const db = await openIDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, 'readwrite');
    const req = tx.objectStore(IDB_STORE).delete(key);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

/* -------------------------
   Save / Load local data
   ------------------------- */
async function saveToLocal() {
  const storeObj = { rows: commodityRows, markets };
  try {
    const json = JSON.stringify(storeObj);
    // try localStorage
    localStorage.setItem(STORAGE_KEY, json);
    // if very large, move to IDB (optional)
    if (json.length > 500000) {
      try { await idbPut(STORAGE_KEY, storeObj); localStorage.removeItem(STORAGE_KEY); console.log('Migrated to IndexedDB'); }
      catch(e){ console.warn('IDB migrate failed', e); }
    }
    return { method: 'localStorage' };
  } catch (err) {
    // fallback to IDB
    try {
      await idbPut(STORAGE_KEY, storeObj);
      return { method: 'indexedDB' };
    } catch (idbErr) {
      console.error('Failed to save', idbErr);
      throw idbErr;
    }
  }
}

function loadFromLocalSync() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      commodityRows = parsed.rows || [];
      markets = parsed.markets || [];
      refreshAllUI();
      return true;
    }
  } catch(e) { console.warn('localStorage read error', e); }
  // async fallback for IDB
  idbGet(STORAGE_KEY).then(obj => {
    if (obj) { commodityRows = obj.rows || []; markets = obj.markets || []; refreshAllUI(); }
  }).catch(e => console.warn('IDB read failed', e));
  return !!localStorage.getItem(STORAGE_KEY);
}
async function clearLocal() {
  if (!confirm('Clear all saved data from this browser? This cannot be undone.')) return;
  try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
  try { await idbDelete(STORAGE_KEY); } catch(e){}
  commodityRows = []; markets = []; refreshAllUI();
  alert('Local save cleared.');
}

/* -------------------------
   CSV fallback parser (simple)
   ------------------------- */
function parseCSVFallback(text, { delimiter = ',', header = true } = {}) {
  const rows = [];
  let cur = '', row = [], inQuotes = false;
  for (let i=0;i<text.length;i++){
    const ch = text[i], next = text[i+1];
    if (ch === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; } else { inQuotes = !inQuotes; }
      continue;
    }
    if (ch === delimiter && !inQuotes) { row.push(cur); cur=''; continue; }
    if ((ch === '\n' || ch === '\r') && !inQuotes) {
      if (ch === '\r' && next === '\n') i++;
      row.push(cur); rows.push(row); row=[]; cur=''; continue;
    }
    cur += ch;
  }
  if (cur !== '' || row.length>0) { row.push(cur); rows.push(row); }
  if (!header) return rows;
  const headers = rows.shift().map(h => h.trim());
  return rows.map(r => {
    const obj = {};
    for (let i=0;i<headers.length;i++) obj[headers[i]] = r[i] !== undefined ? r[i] : '';
    return obj;
  });
}

/* wrapper that tries PapaParse else fallback */
function parseCSVText(text, options={ header:true, skipEmptyLines:true }) {
  return new Promise((resolve) => {
    if (typeof Papa !== 'undefined') {
      try {
        const res = Papa.parse(text, Object.assign({}, options));
        resolve(res.data);
      } catch(e) {
        resolve(parseCSVFallback(text, { header: options.header }));
      }
    } else {
      resolve(parseCSVFallback(text, { header: options.header }));
    }
  });
}

/* -------------------------
   Core: process rows -> normalized shape
   ------------------------- */
function normalizeRow(r) {
  // Accept many header names: Date, Commodity, Variety, Market, District, Modal_Price_Kg, Min_Price_Kg, Max_Price_Kg, Category
  const dateStr = r.Date || r.date || r.DATE || '';
  const commodity = (r.Commodity || r.commodity || r.Item || '').toString().trim();
  const variety = (r.Variety || r.variety || r.SubVariety || '').toString().trim();
  const market = (r.Market || r.market || r.MarketName || '').toString().trim() || 'Default Market';
  const district = (r.District || r.district || '').toString().trim();
  const modal = parseFloat(r.Modal_Price_Kg || r.Modal_Price || r.modal || r.Modal_Price_Kg || r.Modal_Price_Q || 0) || 0;
  const minp = parseFloat(r.Min_Price_Kg || r.Min_Price || r.Min_Price_Q || 0) || 0;
  const maxp = parseFloat(r.Max_Price_Kg || r.Max_Price || r.Max_Price_Q || 0) || 0;
  const category = (r.Category || r.category || '').toString().trim() || 'Other';

  const date = dateStr ? new Date(dateStr) : null;
  return { date, commodity, variety, market, district, modalPriceKg: modal, minPriceKg: minp, maxPriceKg: maxp, category };
}

function processPreloadedData(rows) {
  // rows: array of objects (header -> value)
  const parsed = rows.map(normalizeRow).filter(item => item && item.date instanceof Date && !isNaN(item.date.getTime()) && item.commodity);
  // If no markets exist, auto-add markets found in data
  const foundMarkets = [...new Set(parsed.map(p => p.market || 'Default Market'))];
  if (markets.length === 0) {
    markets = foundMarkets.map(name => ({ name, lat: null, lon: null }));
  } else {
    // add missing markets
    foundMarkets.forEach(m => { if (!markets.find(x=>x.name===m)) markets.push({ name: m, lat:null, lon:null }); });
  }

  // merge parsed rows into commodityRows
  commodityRows = [...commodityRows, ...parsed];
  // sort by date
  commodityRows.sort((a,b) => new Date(a.date) - new Date(b.date));
  // persist
  saveToLocal().catch(()=>{});
  // refresh UI
  refreshAllUI();
}

/* -------------------------
   UI: populate dropdowns, lists, charts
   ------------------------- */
function refreshAllUI() {
  populateMarketSelect();
  populateCategoryFilter();
  populateCommodityList();
  setDefaultDateRange();
  applyFilters();
  updateSnapshotTable();
  updateSummaryCards();
  updatePriceChart();
  updateDistributionChart();
  updateDataTable();
  populateMarketsTable();
}

/* Markets select */
function populateMarketSelect() {
  const sel = document.getElementById('market-select');
  if (!sel) return;
  sel.innerHTML = '';
  markets.forEach(m => {
    const opt = document.createElement('option'); opt.value = m.name; opt.textContent = m.name;
    sel.appendChild(opt);
  });
  if (markets.length === 0) {
    // add default
    markets.push({ name: 'Mysore (Bandipalya)', lat: 12.2958, lon: 76.6394 });
    populateMarketSelect();
  }
}

/* category filter */
function populateCategoryFilter() {
  const categories = [...new Set(commodityRows.map(r => r.category || 'Other'))].sort();
  const sel = document.getElementById('category-filter');
  if (!sel) return;
  sel.innerHTML = '<option value="All">All</option>';
  categories.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
}

/* commodity list (clickable) */
function populateCommodityList() {
  const container = document.getElementById('commodity-list');
  if (!container) return;
  const selectedCategory = (document.getElementById('category-filter') || {}).value || 'All';
  const commodities = [...new Set(commodityRows.filter(r => selectedCategory==='All' || r.category===selectedCategory).map(r => r.commodity))].sort();
  container.innerHTML = '';
  commodities.forEach((c) => {
    const btn = document.createElement('button');
    btn.className = 'w-full text-left text-sm p-2 rounded hover:bg-slate-50 sidebar-item';
    btn.textContent = c;
    btn.addEventListener('click', () => {
      currentCommodity = c;
      document.querySelectorAll('.sidebar-item').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      populateVarietyFilter();
      applyFilters();
    });
    container.appendChild(btn);
  });
  if (commodities.length>0 && !currentCommodity) {
    currentCommodity = commodities[0];
    container.firstChild.classList.add('active');
    populateVarietyFilter();
  }
}

/* variety filter */
function populateVarietyFilter(){
  const sel = document.getElementById('variety-filter');
  if (!sel) return;
  const varieties = [...new Set(commodityRows.filter(r => r.commodity === currentCommodity).map(r => r.variety || 'Default'))].sort();
  sel.innerHTML = '<option value="All">All</option>';
  varieties.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  sel.value = 'All'; currentVariety = 'All';
}

/* date range default */
function setDefaultDateRange() {
  if (!commodityRows.length) return;
  const dates = commodityRows.map(r => new Date(r.date));
  const maxDate = new Date(Math.max.apply(null, dates));
  const minDate = new Date(Math.min.apply(null, dates));
  const endEl = document.getElementById('end-date');
  const startEl = document.getElementById('start-date');
  if (endEl) endEl.value = maxDate.toISOString().split('T')[0];
  const startCandidate = new Date(maxDate); startCandidate.setFullYear(startCandidate.getFullYear() - 1);
  if (startEl) startEl.value = (startCandidate < minDate ? minDate : startCandidate).toISOString().split('T')[0];
}

/* apply filters */
function applyFilters() {
  const startDate = new Date((document.getElementById('start-date')||{}).value || '1970-01-01');
  const endDate = new Date((document.getElementById('end-date')||{}).value || '2100-01-01');
  const category = (document.getElementById('category-filter')||{}).value || 'All';
  currentVariety = (document.getElementById('variety-filter')||{}).value || 'All';
  filteredRows = commodityRows.filter(r => {
    return (category === 'All' || r.category === category) &&
           (r.commodity === currentCommodity) &&
           (currentVariety === 'All' || r.variety === currentVariety) &&
           (new Date(r.date) >= startDate && new Date(r.date) <= endDate);
  }).sort((a,b)=>new Date(a.date)-new Date(b.date));
  updateDashboardUI();
}

/* reset filters */
function resetFilters() {
  document.getElementById('category-filter').value = 'All';
  currentCommodity = '';
  populateCommodityList();
  setDefaultDateRange();
  applyFilters();
}

/* update UI elements */
function updateDashboardUI() {
  document.getElementById('main-header').textContent = currentCommodity ? `${currentCommodity} Dashboard` : 'Dashboard';
  updateSnapshotTable();
  updateSummaryCards();
  updatePriceChart();
  updateDistributionChart();
  updateDataTable();
  // update weather for selected market
  renderWeatherForCurrentMarket();
}

/* snapshot table */
function updateSnapshotTable() {
  const body = document.getElementById('snapshot-table-body');
  if (!body) return;
  if (!commodityRows.length) { body.innerHTML = `<tr><td colspan="6" class="p-3 text-center text-slate-500">No data loaded.</td></tr>`; return; }
  const dates = commodityRows.map(r=>new Date(r.date));
  const latest = new Date(Math.max.apply(null, dates));
  const latestStr = latest.toISOString().split('T')[0];
  document.getElementById('snapshot-date').textContent = `(${latest.toLocaleDateString('en-GB')})`;
  const snapshot = commodityRows.filter(r => (new Date(r.date)).toISOString().split('T')[0] === latestStr);
  document.getElementById('snapshot-count').textContent = snapshot.length;
  if (!snapshot.length) { body.innerHTML = `<tr><td colspan="6" class="p-3 text-center text-slate-500">No data for latest date.</td></tr>`; return; }
  body.innerHTML = snapshot.map(s => `<tr><td class="p-2">${s.market}</td><td class="p-2">${s.commodity}</td><td class="p-2">${s.variety}</td><td class="p-2 font-bold">₹${s.modalPriceKg.toFixed(2)}</td><td class="p-2">₹${s.minPriceKg.toFixed(2)}</td><td class="p-2">₹${s.maxPriceKg.toFixed(2)}</td></tr>`).join('');
}

/* summary cards */
function updateSummaryCards() {
  const container = document.getElementById('summary-cards');
  if (!container) return;
  if (!filteredRows.length) { container.innerHTML = `<div class="col-span-full bg-white p-6 rounded shadow text-center text-slate-500">No data for selection.</div>`; return; }
  const latest = filteredRows[filteredRows.length-1];
  const prev = filteredRows[filteredRows.length-2] || latest;
  const prices = filteredRows.map(r=>r.modalPriceKg);
  const avg = prices.reduce((a,b)=>a+b,0)/prices.length;
  const minP = Math.min(...prices), maxP = Math.max(...prices);
  const change = prev.modalPriceKg ? ((latest.modalPriceKg - prev.modalPriceKg)/prev.modalPriceKg)*100 : 0;
  const cards = [
    {title:'Latest Price', value:`₹${latest.modalPriceKg.toFixed(2)}`, trend: change, color:'blue'},
    {title:'Average Price', value:`₹${avg.toFixed(2)}`, sub:'Period Avg', color:'indigo'},
    {title:'Lowest Price', value:`₹${minP.toFixed(2)}`, sub:'In Period', color:'red'},
    {title:'Highest Price', value:`₹${maxP.toFixed(2)}`, sub:'In Period', color:'green'},
  ];
  container.innerHTML = cards.map(c => `
    <div class="bg-white p-4 rounded-lg shadow">
      <h4 class="text-sm text-slate-500">${c.title}</h4>
      <div class="text-2xl font-bold text-slate-800">${c.value}</div>
      ${c.trend !== undefined ? `<div class="text-sm ${c.trend>=0?'text-green-500':'text-red-500'}">${c.trend>=0?'+':''}${c.trend.toFixed(2)}%</div>` : `<div class="text-xs text-slate-400">${c.sub || ''}</div>`}
    </div>
  `).join('');
}

/* price chart */
function updatePriceChart() {
  const ctx = document.getElementById('price-chart')?.getContext('2d');
  if (!ctx) return;
  if (priceChart) priceChart.destroy();
  if (!filteredRows.length) return;
  priceChart = new Chart(ctx, {
    type:'line',
    data: {
      datasets: [
        { label:'Modal Price', data: filteredRows.map(r=>({x:new Date(r.date), y:r.modalPriceKg})), borderColor:'rgb(34,197,94)', tension:0.2 }
      ]
    },
    options: { parsing:false, scales:{ x:{ type:'time', time:{ unit:'month' } }, y:{ beginAtZero:false } } }
  });
}

/* distribution chart */
function updateDistributionChart() {
  const ctx = document.getElementById('distribution-chart')?.getContext('2d');
  if (!ctx) return;
  if (distributionChart) distributionChart.destroy();
  if (!filteredRows.length) return;
  const prices = filteredRows.map(r => r.modalPriceKg);
  const min = Math.min(...prices), max = Math.max(...prices);
  if (min === max) return;
  const numBins = Math.min(10, Math.max(3, Math.floor(Math.sqrt(prices.length))));
  const size = (max-min)/numBins || 1;
  const bins = Array(numBins).fill(0);
  const labels = bins.map((_,i)=>`₹${(min+i*size).toFixed(0)}-${(min+(i+1)*size).toFixed(0)}`);
  prices.forEach(p => { const idx = Math.min(numBins-1, Math.floor((p-min)/size)); bins[idx]++; });
  distributionChart = new Chart(ctx, {
    type:'bar',
    data: { labels, datasets:[{ label:'Frequency', data:bins, backgroundColor:'rgba(16,185,129,0.6)' }] },
    options: { maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
}

/* data table */
function updateDataTable() {
  const body = document.getElementById('price-table-body');
  if (!body) return;
  if (!filteredRows.length) { body.innerHTML = `<tr><td colspan="7" class="p-3 text-center text-slate-500">No data</td></tr>`; return; }
  const last = filteredRows.slice(-20).reverse();
  body.innerHTML = last.map(r => `<tr class="hover:bg-slate-50 cursor-pointer" data-date="${r.date}"><td class="p-2">${new Date(r.date).toLocaleDateString()}</td><td class="p-2">${r.market}</td><td class="p-2">${r.commodity}</td><td class="p-2">${r.variety}</td><td class="p-2">₹${r.modalPriceKg.toFixed(2)}</td><td class="p-2">₹${r.minPriceKg.toFixed(2)}</td><td class="p-2">₹${r.maxPriceKg.toFixed(2)}</td></tr>`).join('');

  // Attach click to open edit modal
  Array.from(body.querySelectorAll('tr[data-date]')).forEach(tr=>{
    tr.onclick = () => {
      const date = tr.getAttribute('data-date');
      const row = filteredRows.find(rr => new Date(rr.date).toISOString() === new Date(date).toISOString());
      if (!row) return;
      openEditModal(row);
    };
  });
}

/* open edit modal */
function openEditModal(row) {
  document.getElementById('modal-add-record').classList.remove('hidden');
  document.getElementById('rec-date').value = new Date(row.date).toISOString().split('T')[0];
  document.getElementById('rec-market').innerHTML = markets.map(m=>`<option value="${m.name}">${m.name}</option>`).join('');
  document.getElementById('rec-market').value = row.market;
  document.getElementById('rec-commodity').value = row.commodity;
  document.getElementById('rec-variety').value = row.variety;
  document.getElementById('rec-category').value = row.category;
  document.getElementById('rec-district').value = row.district || '';
  document.getElementById('rec-modal').value = row.modalPriceKg || '';
  document.getElementById('rec-min').value = row.minPriceKg || '';
  document.getElementById('rec-max').value = row.maxPriceKg || '';
  document.getElementById('delete-record-btn').classList.remove('hidden');

  // form submit will update or add
  const form = document.getElementById('record-form');
  form.onsubmit = (e) => {
    e.preventDefault();
    // update row in commodityRows
    const idx = commodityRows.findIndex(r => new Date(r.date).toISOString() === new Date(row.date).toISOString() && r.commodity===row.commodity && r.market===row.market);
    const updated = {
      date: new Date(document.getElementById('rec-date').value),
      commodity: document.getElementById('rec-commodity').value,
      variety: document.getElementById('rec-variety').value,
      market: document.getElementById('rec-market').value,
      district: document.getElementById('rec-district').value,
      category: document.getElementById('rec-category').value,
      modalPriceKg: parseFloat(document.getElementById('rec-modal').value) || 0,
      minPriceKg: parseFloat(document.getElementById('rec-min').value) || 0,
      maxPriceKg: parseFloat(document.getElementById('rec-max').value) || 0
    };
    if (idx >= 0) commodityRows[idx] = updated;
    else commodityRows.push(updated);
    commodityRows.sort((a,b)=>new Date(a.date)-new Date(b.date));
    saveToLocal().catch(()=>{});
    document.getElementById('modal-add-record').classList.add('hidden');
    refreshAllUI();
  };

  document.getElementById('delete-record-btn').onclick = () => {
    if (!confirm('Delete this record?')) return;
    commodityRows = commodityRows.filter(r => !(new Date(r.date).toISOString() === new Date(row.date).toISOString() && r.commodity===row.commodity && r.market===row.market));
    saveToLocal().catch(()=>{});
    document.getElementById('modal-add-record').classList.add('hidden');
    refreshAllUI();
  };

  document.getElementById('close-add-record').onclick = () => {
    document.getElementById('modal-add-record').classList.add('hidden');
  };
}

/* open blank add modal */
function openAddModal() {
  document.getElementById('modal-add-record').classList.remove('hidden');
  document.getElementById('record-form').reset();
  document.getElementById('rec-market').innerHTML = markets.map(m=>`<option value="${m.name}">${m.name}</option>`).join('');
  document.getElementById('delete-record-btn').classList.add('hidden');
  document.getElementById('record-form').onsubmit = (e) => {
    e.preventDefault();
    const newRow = {
      date: new Date(document.getElementById('rec-date').value),
      commodity: document.getElementById('rec-commodity').value,
      variety: document.getElementById('rec-variety').value,
      market: document.getElementById('rec-market').value,
      district: document.getElementById('rec-district').value,
      category: document.getElementById('rec-category').value || 'Other',
      modalPriceKg: parseFloat(document.getElementById('rec-modal').value) || 0,
      minPriceKg: parseFloat(document.getElementById('rec-min').value) || 0,
      maxPriceKg: parseFloat(document.getElementById('rec-max').value) || 0
    };
    commodityRows.push(newRow);
    commodityRows.sort((a,b)=>new Date(a.date)-new Date(b.date));
    saveToLocal().catch(()=>{});
    document.getElementById('modal-add-record').classList.add('hidden');
    refreshAllUI();
  };
}

/* -------------------------
   Top crops & recommendations
   ------------------------- */
function generateRecommendations(count = 10) {
  // compute score for each commodity across all markets: require at least 15 rows
  const commodities = [...new Set(commodityRows.map(r=>r.commodity))];
  const recs = commodities.map(name => {
    const rows = commodityRows.filter(r=>r.commodity===name).slice(-30);
    if (rows.length < 8) return null;
    const prices = rows.map(r=>r.modalPriceKg);
    const avg = prices.reduce((a,b)=>a+b,0)/prices.length;
    const change = (prices[prices.length-1]-prices[0]) / Math.max(1, prices[0]);
    const variance = prices.reduce((s,p)=>s+Math.pow(p-avg,2),0)/prices.length;
    const vol = Math.sqrt(variance)/Math.max(1,avg);
    const score = (1 + change) / (vol + 0.05);
    const risk = vol < 0.1 ? 'Low' : vol < 0.2 ? 'Medium' : 'High';
    return { commodity: name, avgPrice: avg, priceChangePct: change*100, volatility: vol, score, risk };
  }).filter(Boolean).sort((a,b)=>b.score - a.score);
  return recs.slice(0,count);
}
function showRecommendationsModal() {
  const recs = generateRecommendations(3);
  const cont = document.getElementById('recommendations-list');
  if (!cont) {
    // fallback: fill main recommendations container if no modal exists
    alert('Top recommendations:\n' + recs.map((r,i)=>`${i+1}. ${r.commodity} — ₹${r.avgPrice.toFixed(2)} (30d)`).join('\n'));
    return;
  }
  cont.innerHTML = recs.map((r,i)=>`
    <div class="p-3 border rounded">
      <div class="flex justify-between items-start">
        <div>
          <h4 class="font-bold">${i+1}. ${r.commodity}</h4>
          <div class="text-xs text-slate-500 mt-1">Avg: ₹${r.avgPrice.toFixed(2)}/kg</div>
        </div>
        <div class="text-right">
          <div class="${r.priceChangePct>=0?'text-green-500':'text-red-500'} font-semibold">${r.priceChangePct.toFixed(1)}%</div>
          <div class="text-xs text-slate-400">${r.risk} risk</div>
        </div>
      </div>
      <div class="mt-2 text-xs">
        <button onclick="showGrowSheet('${r.commodity.replace(/'/g,'\\\'')}')" class="bg-emerald-600 text-white py-1 px-2 rounded text-xs">Grow Sheet</button>
        <a class="ml-2 text-xs text-slate-600" href="#" onclick="showYouTubeRecommendations('${r.commodity.replace(/'/g,'\\\'')}');return false;">YouTube</a>
      </div>
    </div>
  `).join('');
  // show modal if exists
  document.getElementById('modal-recommendations')?.classList.remove('hidden');
}

/* Top crops page content */
function generateTopCropsUI() {
  const recs = generateRecommendations(10);
  const cont = document.getElementById('top-crops-container');
  if (!cont) return;
  cont.innerHTML = recs.map((r,i)=>`
    <div class="bg-white p-3 rounded shadow flex items-center justify-between">
      <div>
        <div class="text-sm text-slate-500">#${i+1}</div>
        <h4 class="font-bold">${r.commodity}</h4>
        <div class="text-xs text-slate-500">Avg ₹${r.avgPrice.toFixed(2)} • ${r.risk} risk</div>
      </div>
      <div class="text-right space-y-1">
        <div class="${r.priceChangePct>=0?'text-green-500':'text-red-500'} font-semibold">${r.priceChangePct.toFixed(1)}%</div>
        <div><button onclick="showGrowSheet('${r.commodity.replace(/'/g,'\\\'')}')" class="bg-emerald-600 text-white py-1 px-2 rounded text-xs">Grow Sheet</button></div>
      </div>
    </div>
  `).join('');
}

/* Grow sheet: printable short sheet for a commodity (basic template) */
function showGrowSheet(commodity) {
  const container = document.getElementById('grow-sheet');
  if (!container) return;
  const content = `
    <div class="bg-white p-4 rounded shadow">
      <h3 class="font-bold text-lg mb-2">Grow Sheet — ${commodity}</h3>
      <ul class="text-sm space-y-2">
        <li><strong>Soil:</strong> Well-drained, loamy soil; pH 6.0–7.5</li>
        <li><strong>Sowing:</strong> Best in season-specific months; ensure seedbed preparation</li>
        <li><strong>Spacing:</strong> Follow recommended spacing for the crop variety</li>
        <li><strong>Irrigation:</strong> Regular irrigation, avoid waterlogging</li>
        <li><strong>Fertilizer:</strong> Apply NPK as per soil test — basal + top dressing</li>
        <li><strong>Pest Management:</strong> Monitor for common pests; use IPM (biocontrol, spot sprays)</li>
        <li><strong>Harvest:</strong> Harvest at recommended maturity window for best price</li>
      </ul>
      <div class="mt-3">
        <button onclick="printGrowSheet('${commodity.replace(/'/g,'\\\'')}')" class="bg-slate-800 text-white py-1 px-3 rounded text-sm">Print</button>
        <button onclick="renderYouTubeEmbed('${commodity.replace(/'/g,'\\\'')}')" class="ml-2 bg-slate-200 py-1 px-3 rounded text-sm">Show videos</button>
      </div>
    </div>
  `;
  container.innerHTML = content;
  // scroll into view
  container.scrollIntoView({ behavior:'smooth' });
}

function printGrowSheet(commodity) {
  // open small window with printable content
  const html = `
    <html><head><title>Grow Sheet - ${commodity}</title></head>
    <body><h2>Grow Sheet — ${commodity}</h2>
      <p>Soil: Well-drained, loamy soil; pH 6.0–7.5</p>
      <p>Sowing: Best in season-specific months; ensure seedbed preparation</p>
      <p>Spacing: Follow recommended spacing for the crop variety</p>
      <p>Irrigation: Regular irrigation, avoid waterlogging</p>
      <p>Fertilizer: Apply NPK as per soil test — basal + top dressing</p>
      <p>Pest Management: Monitor for common pests; use IPM</p>
    </body></html>
  `;
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.print();
}

/* YouTube recommendations: lightweight search links (do not embed automatically to save weight) */
function showYouTubeRecommendations(commodity) {
  const cont = document.getElementById('video-recommendations');
  if (!cont) return;
  const query = encodeURIComponent(`${commodity} cultivation tutorial`);
  const links = [
    { title: `YouTube search: ${commodity}`, url: `https://www.youtube.com/results?search_query=${query}` },
    { title: `${commodity} growing basics (YouTube)`, url: `https://www.youtube.com/results?search_query=${query}+basics` }
  ];
  cont.innerHTML = `
    <div class="bg-white p-4 rounded shadow">
      <h4 class="font-semibold">Video recommendations for "${commodity}"</h4>
      <ul class="mt-2 space-y-2 text-sm">
        ${links.map(l=>`<li><a class="text-emerald-600" href="${l.url}" target="_blank" rel="noopener">${l.title}</a></li>`).join('')}
      </ul>
      <div class="mt-3 text-xs text-slate-500">Tip: Tap a link to open YouTube (lightweight links are used to keep app small).</div>
    </div>
  `;
}

/* lightweight embed if user wants to embed one video (optional) */
function renderYouTubeEmbed(commodity) {
  const cont = document.getElementById('video-recommendations');
  if (!cont) return;
  if (!confirm('Embedding a YouTube video will increase page size and may use more data. Continue?')) return;
  const vid = prompt('Paste YouTube video ID (e.g. "dQw4w9WgXcQ") to embed a specific tutorial for ' + commodity);
  if (!vid) return;
  cont.innerHTML = `<div class="bg-white p-4 rounded shadow"><h4 class="font-semibold">Video</h4><iframe width="100%" height="360" src="https://www.youtube.com/embed/${vid}" title="YouTube video" frameborder="0" allowfullscreen></iframe></div>`;
}

/* -------------------------
   Weather (Open-Meteo) — free, no key
   ------------------------- */
async function renderWeatherForCurrentMarket() {
  const sel = document.getElementById('market-select');
  if (!sel) return;
  const marketName = sel.value;
  const market = markets.find(m => m.name === marketName);
  const container = document.getElementById('weather-container');
  if (!container) return;
  if (!market || !market.lat || !market.lon) {
    container.innerHTML = `<div class="text-xs text-slate-500">No coordinates for "${marketName}". Add coordinates in "Manage markets" to see 7-day forecast.</div>`;
    return;
  }
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${market.lat}&longitude=${market.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;
  try {
    const res = await fetch(url);
    const json = await res.json();
    if (!json.daily) { container.innerHTML = `<div class="text-xs text-slate-500">Weather not available.</div>`; return; }
    const days = json.daily.time.map((t,i)=>({ date:t, max: json.daily.temperature_2m_max[i], min: json.daily.temperature_2m_min[i], precip: json.daily.precipitation_sum[i] }));
    container.innerHTML = days.map(d=>`<div><strong>${new Date(d.date).toLocaleDateString()}</strong>: ${d.max}°/${d.min}° - Rain ${d.precip} mm</div>`).join('');
  } catch (err) {
    container.innerHTML = `<div class="text-xs text-slate-500">Weather fetch error.</div>`;
    console.warn('Weather error', err);
  }
}

/* Manage markets UI (simplified table) */
function populateMarketsTable() {
  const tbody = document.getElementById('markets-table-body');
  if (!tbody) return;
  tbody.innerHTML = markets.map((m, idx)=>`<tr><td class="p-1 text-sm">${m.name}</td><td class="p-1 text-sm">${m.lat||''}</td><td class="p-1 text-sm">${m.lon||''}</td><td class="p-1"><button class="text-red-500 text-xs" onclick="removeMarket(${idx})">Remove</button></td></tr>`).join('');
}
function removeMarket(i) { markets.splice(i,1); saveToLocal().catch(() => {}); populateMarketsTable(); populateMarketSelect(); }

/* -------------------------
   File import (CSV / XLSX)
   ------------------------- */
async function handleFileImport(file) {
  if (!file) return;
  try {
    const name = file.name.toLowerCase();
    if (name.endsWith('.csv') || file.type.includes('text')) {
      const text = await file.text();
      const rows = await parseCSVText(text, { header: true, skipEmptyLines: true });
      processPreloadedData(rows);
    } else {
      const ab = await file.arrayBuffer();
      const wb = XLSX.read(ab, { type: 'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
      processPreloadedData(rows);
    }
    alert('File imported successfully. Dashboard ready.');
    // After import show dashboard
    showDashboardAfterLoad();
  } catch (err) {
    console.error(err);
    alert('Failed to import file. See console for details.');
  }
}

/* -------------------------
   PWA / startup control
   ------------------------- */
function showDashboardAfterLoad() {
  document.getElementById('start-screen')?.classList.add('hidden');
  document.getElementById('main-dashboard')?.classList.remove('hidden');
  // refresh content
  refreshAllUI();
}

/* Prevent auto-initialize on load; only open dashboard after user clicks */
document.addEventListener('DOMContentLoaded', () => {
  // show start screen by default
  document.getElementById('start-screen')?.classList.remove('hidden');
  document.getElementById('main-dashboard')?.classList.add('hidden');

  // Wire buttons
  document.getElementById('start-analysis-btn')?.addEventListener('click', async () => {
    // Try to fetch PRELOADED_RAW_URL if present
    if (PRELOADED_RAW_URL) {
      try {
        const resp = await fetch(PRELOADED_RAW_URL);
        if (!resp.ok) throw new Error('Fetch failed: '+resp.status);
        const contentType = resp.headers.get('content-type') || '';
        const blob = await resp.blob();
        if (contentType.includes('text') || PRELOADED_RAW_URL.toLowerCase().endsWith('.csv')) {
          const text = await blob.text();
          const rows = await parseCSVText(text, { header:true, skipEmptyLines:true });
          processPreloadedData(rows);
        } else {
          const ab = await blob.arrayBuffer();
          const wb = XLSX.read(ab, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
          processPreloadedData(rows);
        }
        // show UI
        setTimeout(() => showDashboardAfterLoad(), 300);
      } catch (e) {
        console.error('Preload failed', e);
        alert('Preload failed: ' + e.message + '\nYou can import the file manually using the file input.');
      }
    } else {
      alert('No PRELOADED_RAW_URL set. Please import file.');
    }
  });

  document.getElementById('load-local-btn')?.addEventListener('click', () => {
    const ok = loadFromLocalSync();
    setTimeout(() => showDashboardAfterLoad(), 300);
  });

  // file input import
  document.getElementById('file-input')?.addEventListener('change', (ev) => {
    const file = ev.target.files[0];
    handleFileImport(file);
  });

  // quick buttons
  document.getElementById('import-csv-btn')?.addEventListener('click', () => {
    document.getElementById('file-input').click();
  });
  document.getElementById('add-record-btn')?.addEventListener('click', openAddModal);
  document.getElementById('export-all-btn')?.addEventListener('click', () => {
    if (!commodityRows.length) { alert('No data to export'); return; }
    const headers = ['Date','Market','Commodity','Variety','Category','District','Min_Price_Kg','Max_Price_Kg','Modal_Price_Kg'];
    const rows = commodityRows.map(r => [new Date(r.date).toISOString().split('T')[0], r.market, r.commodity, r.variety, r.category, r.district, r.minPriceKg, r.maxPriceKg, r.modalPriceKg]);
    const csv = [headers.join(','), ...rows.map(r => r.map(cell => typeof cell === 'string' && cell.includes(',')?`"${cell.replace(/"/g,'""')}"`:cell).join(','))].join('\n');
    const link = document.createElement('a'); link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); link.download = 'agri_export.csv'; document.body.appendChild(link); link.click(); link.remove();
  });
  document.getElementById('clear-storage-btn')?.addEventListener('click', clearLocal);
  document.getElementById('get-recommendations')?.addEventListener('click', () => {
    generateTopCropsUI();
    showRecommendationsModal();
  });

  // tabs
  document.getElementById('tab-dashboard')?.addEventListener('click', () => { document.getElementById('dashboard-content').classList.remove('hidden'); document.getElementById('prediction-content').classList.add('hidden'); document.getElementById('top-crops-content').classList.add('hidden'); });
  document.getElementById('tab-prediction')?.addEventListener('click', () => { document.getElementById('dashboard-content').classList.add('hidden'); document.getElementById('prediction-content').classList.remove('hidden'); document.getElementById('top-crops-content').classList.add('hidden'); renderWeatherForCurrentMarket(); });
  document.getElementById('tab-top-crops')?.addEventListener('click', () => { document.getElementById('dashboard-content').classList.add('hidden'); document.getElementById('prediction-content').classList.add('hidden'); document.getElementById('top-crops-content').classList.remove('hidden'); generateTopCropsUI(); });

  // market change -> weather
  document.getElementById('market-select')?.addEventListener('change', renderWeatherForCurrentMarket);

  // close recommendations modal
  document.getElementById('close-recommendations-modal')?.addEventListener('click', () => document.getElementById('modal-recommendations')?.classList.add('hidden'));

  // load possible saved data in background (but do not auto-open dashboard)
  loadFromLocalSync();
});

/* Helper: Manage markets modal (not fully implemented UI in markup but hooks exist if you add modal) */
/* For this initial release we keep markets list editable via developer tools or future UI */

/* End of script */
</script>

<!-- SERVICE WORKER REGISTRATION (place just before closing body) -->
<script>
  // Register service worker using a relative path — works for root or subpath hosting.
  (function registerSW(){
    if (!('serviceWorker' in navigator)) return console.log('Service worker not supported in this browser.');
    // try relative path first
    const pathsToTry = ['./service-worker.js', '/service-worker.js', './Smart_FarmHer/service-worker.js', '/Smart_FarmHer/service-worker.js'];
    // attempt in sequence until one registers or exhaust list
    (async () => {
      for (const p of pathsToTry) {
        try {
          const reg = await navigator.serviceWorker.register(p);
          console.log('Service worker registered at', p, reg);
          // optional: listen for updates
          reg.addEventListener('updatefound', () => {
            const newW = reg.installing;
            newW.addEventListener('statechange', () => {
              if (newW.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('New content available; please refresh to update.');
              }
            });
          });
          return;
        } catch (err) {
          // ignore and try next
          console.info('SW register failed for', p, err && err.message ? err.message : err);
        }
      }
      console.warn('Service worker registration failed for all tried paths. Ensure service-worker.js is deployed alongside index.html.');
    })();
  })();
</script>

</body>
</html>

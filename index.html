<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgriAnalyst Pro — Farmer (PWA)</title>

  <!-- PWA manifest & theme -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10b981">

  <!-- UI libs (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f0f2f5; }
    .sidebar { -ms-overflow-style: none; scrollbar-width: none; }
    .sidebar::-webkit-scrollbar { display: none; }
    .sidebar-item.active { background-color: #10b981; color: white; }
    .chart-container { position: relative; height: 360px; width: 100%; }
    .tab-active { border-bottom-color: #10b981; color: #059669; font-weight:600; }
  </style>
</head>
<body class="text-slate-800">

<!-- START SCREEN -->
<div id="start-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-2xl text-center">
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
      <h1 class="text-3xl font-bold text-emerald-600 mb-2"><i class="fas fa-seedling mr-2"></i>AgriAnalyst Pro — Farmer</h1>
      <p class="text-slate-500 mb-4">Open this file daily to check prices, add new commodity rows, and get crop recommendations. All data remains on your device.</p>

      <div class="space-y-3">
        <input id="file-input" type="file" accept=".csv,.xlsx,.xls,text/csv" class="w-full" />
        <div class="flex gap-3">
          <button id="start-analysis-btn" class="flex-1 bg-emerald-600 text-white font-bold py-3 rounded-lg"><i class="fas fa-chart-line mr-2"></i> Start (preloaded)</button>
          <button id="load-local-btn" class="bg-slate-700 text-white font-bold py-3 px-4 rounded-lg"><i class="fas fa-save mr-2"></i> Load Saved</button>
        </div>
        <p class="text-xs text-slate-400">Tip: use "Load Saved" to restore your previous data from the browser storage. Use the file input to import your CSV or Excel file.</p>
      </div>
    </div>
  </div>
</div>

<!-- MAIN DASHBOARD -->
<div id="main-dashboard" class="hidden h-screen">
  <div class="flex h-full">

    <!-- SIDEBAR -->
    <aside class="w-72 bg-white border-r p-3 flex flex-col sidebar overflow-y-auto">
      <div class="h-14 flex items-center justify-center border-b mb-3">
        <h1 class="text-xl font-bold text-emerald-600"><i class="fas fa-seedling mr-2"></i>AgriAnalyst</h1>
      </div>

      <!-- Market selector / Manage markets -->
      <div class="mb-3">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-xs font-semibold text-slate-500 uppercase">Markets</h2>
          <button id="manage-markets-btn" title="Add / edit markets" class="text-xs text-slate-500 hover:text-slate-800"><i class="fas fa-map-marker-alt"></i></button>
        </div>
        <select id="market-select" class="w-full rounded-md p-2 border text-sm"></select>
        <div class="mt-2 text-xs text-slate-400">Select market to show weather & specific market prices</div>
      </div>

      <!-- Controls -->
      <div class="mb-3">
        <h2 class="text-xs font-semibold text-slate-500 uppercase mb-2">Filters</h2>
        <label class="text-xs">Category</label>
        <select id="category-filter" class="w-full rounded-md p-2 border text-sm mb-2"><option value="All">All</option></select>

        <label class="text-xs">Commodity</label>
        <div id="commodity-list" class="h-28 overflow-y-auto border rounded p-1 mb-2"></div>

        <label class="text-xs">Variety</label>
        <select id="variety-filter" class="w-full rounded-md p-2 border text-sm mb-2"></select>

        <label class="text-xs">Date range</label>
        <div class="flex gap-2">
          <input id="start-date" type="date" class="rounded-md p-2 border text-sm w-1/2" />
          <input id="end-date" type="date" class="rounded-md p-2 border text-sm w-1/2" />
        </div>

        <div class="flex gap-2 mt-3">
          <button id="apply-filters" class="flex-1 bg-emerald-600 text-white py-2 rounded-md">Apply</button>
          <button id="reset-filters" class="flex-1 bg-slate-200 py-2 rounded-md">Reset</button>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="mt-auto space-y-2">
        <button id="add-record-btn" class="w-full bg-blue-500 text-white py-2 rounded-md"><i class="fas fa-plus mr-2"></i>Add Record</button>
        <button id="import-csv-btn" class="w-full bg-slate-700 text-white py-2 rounded-md"><i class="fas fa-file-import mr-2"></i>Import CSV/XLSX</button>
        <button id="export-all-btn" class="w-full bg-slate-200 text-slate-800 py-2 rounded-md"><i class="fas fa-file-export mr-2"></i>Export CSV (All)</button>
        <button id="clear-storage-btn" class="w-full bg-red-50 text-red-600 py-2 rounded-md"><i class="fas fa-trash mr-2"></i>Clear Local Save</button>
        <div class="text-xs text-slate-400 mt-2">All edits save to your browser. Export before clearing storage.</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 overflow-y-auto bg-slate-100 p-6">
      <header class="flex items-center justify-between mb-6">
        <h2 id="main-header" class="text-2xl font-bold">Dashboard</h2>
        <div class="flex items-center gap-3">
          <button id="get-recommendations" class="bg-yellow-500 text-white py-2 px-4 rounded-md"><i class="fas fa-star mr-2"></i>Quick Recommendations</button>
          <button id="show-help-btn" class="bg-slate-200 py-2 px-4 rounded-md">Help</button>
        </div>
      </header>

      <!-- Tabs -->
      <div class="border-b mb-4">
        <nav class="flex gap-6">
          <button id="tab-dashboard" class="tab-active py-3 px-1 border-b-2 font-medium">Dashboard</button>
          <button id="tab-prediction" class="py-3 px-1 text-gray-500">Prediction & Weather</button>
          <button id="tab-top-crops" class="py-3 px-1 text-gray-500">Top 10 Crops</button>
        </nav>
      </div>

      <!-- CONTENT: Dashboard -->
      <div id="dashboard-content">
        <!-- Snapshot -->
        <div class="bg-white p-4 rounded-lg shadow mb-4">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-semibold text-lg">Latest Market Snapshot <span id="snapshot-date" class="text-emerald-600"></span></h3>
              <p class="text-xs text-slate-500">Shows last available day across markets</p>
            </div>
            <div class="text-xs text-slate-500">Rows: <span id="snapshot-count">0</span></div>
          </div>

          <div class="overflow-x-auto mt-3">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-slate-600 bg-slate-50">
                <tr><th class="p-2">Market</th><th class="p-2">Commodity</th><th class="p-2">Variety</th><th class="p-2">Modal (₹/kg)</th><th class="p-2">Min</th><th class="p-2">Max</th></tr>
              </thead>
              <tbody id="snapshot-table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Cards -->
        <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"></div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-4">
          <div class="lg:col-span-3 bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">Historical Price Trends</h4>
            <div class="chart-container"><canvas id="price-chart"></canvas></div>
          </div>
          <div class="lg:col-span-2 bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">Price Distribution</h4>
            <div class="chart-container"><canvas id="distribution-chart"></canvas></div>
          </div>
        </div>

        <!-- Table -->
        <div class="bg-white p-4 rounded shadow">
          <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold">Detailed Price Data (last 20 rows)</h4>
            <div class="text-xs text-slate-500">Click a row to edit</div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-slate-600 bg-slate-50">
                <tr><th class="p-2">Date</th><th class="p-2">Market</th><th class="p-2">Commodity</th><th class="p-2">Variety</th><th class="p-2">Modal</th><th class="p-2">Min</th><th class="p-2">Max</th></tr>
              </thead>
              <tbody id="price-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CONTENT: Prediction & Weather -->
      <div id="prediction-content" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2 bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">90-Day Forecast (Selected Commodity / Market)</h4>
            <div class="chart-container"><canvas id="forecast-chart"></canvas></div>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <h4 class="font-semibold mb-2">7-day Weather (Selected Market)</h4>
            <div id="weather-container" class="space-y-2 text-sm text-slate-700"></div>
            <div class="mt-4 text-xs text-slate-500">Weather powered by Open-Meteo (free, no key)</div>
          </div>
        </div>

        <div id="prediction-outlook" class="mt-4"></div>
      </div>

      <!-- CONTENT: Top crops -->
      <div id="top-crops-content" class="hidden">
        <div class="bg-white p-4 rounded shadow mb-4">
          <h4 class="font-semibold">Top 10 Crops to Grow Next</h4>
          <p class="text-xs text-slate-500">Ranked by profitability score (avg price, trend, volatility)</p>
        </div>
        <div id="top-crops-container" class="space-y-2"></div>
      </div>
    </main>
  </div>
</div>

<!-- MODALS: Add Record, Manage Markets, Help -->
<!-- Add Record Modal -->
<div id="modal-add-record" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
  <div class="bg-white w-full max-w-2xl rounded p-4">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold text-lg">Add / Edit Record</h3>
      <button id="close-add-record" class="text-slate-500">&times;</button>
    </div>
    <form id="record-form" class="grid grid-cols-1 md:grid-cols-2 gap-2">
      <div><label class="text-xs">Date</label><input id="rec-date" type="date" class="w-full p-2 border rounded" required></div>
      <div><label class="text-xs">Market</label><select id="rec-market" class="w-full p-2 border rounded"></select></div>
      <div><label class="text-xs">Commodity</label><input id="rec-commodity" type="text" class="w-full p-2 border rounded" placeholder="e.g. Beans" required></div>
      <div><label class="text-xs">Variety</label><input id="rec-variety" type="text" class="w-full p-2 border rounded" placeholder="e.g. Beans (Whole)"></div>
      <div><label class="text-xs">Category</label><input id="rec-category" type="text" class="w-full p-2 border rounded" placeholder="e.g. Vegetable"></div>
      <div><label class="text-xs">District</label><input id="rec-district" type="text" class="w-full p-2 border rounded" placeholder="optional"></div>
      <div><label class="text-xs">Modal Price (₹/kg)</label><input id="rec-modal" type="number" step="0.01" class="w-full p-2 border rounded"></div>
      <div><label class="text-xs">Min Price (₹/kg)</label><input id="rec-min" type="number" step="0.01" class="w-full p-2 border rounded"></div>
      <div><label class="text-xs">Max Price (₹/kg)</label><input id="rec-max" type="number" step="0.01" class="w-full p-2 border rounded"></div>

      <div class="md:col-span-2 flex gap-2 mt-2">
        <button type="submit" class="flex-1 bg-emerald-600 text-white py-2 rounded">Save</button>
        <button id="delete-record-btn" type="button" class="flex-1 bg-red-50 text-red-600 py-2 rounded hidden">Delete</button>
      </div>
    </form>
  </div>
</div>

<!-- Manage Markets Modal -->
<div id="modal-manage-markets" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
  <div class="bg-white w-full max-w-xl rounded p-4">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold text-lg">Manage Markets (add lat/lon for weather)</h3>
      <button id="close-manage-markets" class="text-slate-500">&times;</button>
    </div>
    <div class="grid grid-cols-1 gap-2">
      <div class="flex gap-2">
        <input id="market-name" type="text" placeholder="Market name" class="flex-1 p-2 border rounded">
        <input id="market-lat" type="number" placeholder="Latitude" class="w-32 p-2 border rounded">
        <input id="market-lon" type="number" placeholder="Longitude" class="w-32 p-2 border rounded">
        <button id="add-market-btn" class="bg-blue-500 text-white px-3 rounded">Add</button>
      </div>
      <div class="overflow-y-auto max-h-60 border rounded p-2">
        <table class="w-full text-sm">
          <thead class="text-xs text-slate-500"><tr><th>Name</th><th>Lat</th><th>Lon</th><th></th></tr></thead>
          <tbody id="markets-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Recommendations Modal -->
<div id="modal-recommendations" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
  <div class="bg-white w-full max-w-4xl rounded p-4">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold text-lg">Quick Recommendations (Top 3)</h3>
      <button id="close-recommendations-modal" class="text-slate-500">&times;</button>
    </div>
    <div id="recommendations-list" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
  </div>
</div>

<script>
/* ========== Persistence with localStorage fallback to IndexedDB ========== */

const STORAGE_KEY = 'agri_dashboard_store_v1';
const IDB_DBNAME = 'agri_analyst_db_v1';
const IDB_STORE = 'store';

/* --- IndexedDB helper --- */
function openIDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(IDB_DBNAME, 1);
    req.onupgradeneeded = evt => {
      const db = evt.target.result;
      if (!db.objectStoreNames.contains(IDB_STORE)) {
        db.createObjectStore(IDB_STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbPut(key, value) {
  const db = await openIDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, 'readwrite');
    tx.objectStore(IDB_STORE).put(value, key);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

async function idbGet(key) {
  const db = await openIDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, 'readonly');
    const req = tx.objectStore(IDB_STORE).get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbDelete(key) {
  const db = await openIDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(IDB_STORE, 'readwrite');
    const req = tx.objectStore(IDB_STORE).delete(key);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

/* --- saveToLocal: tries localStorage, falls back to IndexedDB --- */
async function saveToLocal() {
  const storeObj = { rows: commodityRows || [], markets: markets || [] };
  try {
    // try localStorage first (fast)
    const json = JSON.stringify(storeObj);
    localStorage.setItem(STORAGE_KEY, json);
    // clear any legacy IDB entry (optional)
    try { await idbDelete(STORAGE_KEY); } catch(e){/* ignore */ }
    console.log('Saved to localStorage (small).');
    return { method: 'localStorage' };
  } catch (err) {
    console.warn('localStorage save failed, falling back to IndexedDB:', err);
    try {
      await idbPut(STORAGE_KEY, storeObj);
      console.log('Saved to IndexedDB.');
      // Inform user (friendly alert)
      alert('Note: Data is large and was saved to your browser storage (IndexedDB) instead of localStorage. This supports larger datasets.');
      return { method: 'indexedDB' };
    } catch (idbErr) {
      console.error('Failed to save to IndexedDB:', idbErr);
      alert('Failed to save data to browser storage. Try exporting smaller CSV or clear space in browser storage.');
      throw idbErr;
    }
  }
}

/* --- loadFromLocal: tries localStorage then IndexedDB --- */
function loadFromLocal() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      commodityRows = parsed.rows || [];
      markets = parsed.markets || [];
      console.log('Loaded data from localStorage.');
      return true;
    }
  } catch (e) {
    console.warn('Error reading localStorage, will try IndexedDB:', e);
  }

  // fallback to IndexedDB (async) — return boolean but start async load
  // We'll return true if IDB has data synchronously? can't; use a blocking async approach:
  // Implement synchronous wrapper by using async/await above call sites OR make a blocking Promise here.
  // Simpler: perform synchronous false and initialize async load (then refresh UI when done).
  idbGet(STORAGE_KEY).then(storeObj => {
    if (storeObj) {
      commodityRows = storeObj.rows || [];
      markets = storeObj.markets || [];
      console.log('Loaded data from IndexedDB.');
      refreshAllUI();
    } else {
      console.log('No data in IndexedDB.');
    }
  }).catch(err => {
    console.warn('Error reading IndexedDB:', err);
  });

  // indicate whether localStorage had data (we already tried above)
  return !!localStorage.getItem(STORAGE_KEY);
}

/* --- clearLocal: clears both storage places --- */
function clearLocal() {
  if (!confirm('Clear all saved data from this browser? This cannot be undone.')) return;
  try {
    localStorage.removeItem(STORAGE_KEY);
  } catch (e) { console.warn(e); }
  idbDelete(STORAGE_KEY).then(() => {
    commodityRows = [];
    markets = [];
    refreshAllUI();
    alert('Local save cleared from browser storage.');
  }).catch(err => {
    console.warn('Clear IndexedDB failed:', err);
    commodityRows = [];
    markets = [];
    refreshAllUI();
    alert('Local save cleared (localStorage). IndexedDB clear may have failed; check console.');
  });
}

/* --- helper: attempt to migrate large localStorage to IndexedDB (optional) --- */
async function migrateLocalStorageToIDBIfLarge() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    // if the localStorage string length is large (> 1MB), move to IDB
    if (raw.length > 500000) {
      const parsed = JSON.parse(raw);
      await idbPut(STORAGE_KEY, parsed);
      // optionally remove from localStorage to free quota
      localStorage.removeItem(STORAGE_KEY);
      console.log('Migrated large localStorage data to IndexedDB and cleared localStorage.');
    }
  } catch (e) { console.warn('Migration check failed:', e); }
}

/* Call migration on startup (non-blocking) */
migrateLocalStorageToIDBIfLarge().catch(()=>{/*ignore*/});
</script>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart FarmHer â€” Grow Good Sell Smart</title>

  <!-- Tailwind CDN (for quick UI) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root{
      --emerald:#10b981;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f3f6f8;
      --accent:#0f172a;
      --soft:#f8fafc;
      --success:#ecfdf5;
      --danger:#fff1f2;
    }
    html,body { height:100%; }
    body { font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; background:var(--bg); color:var(--accent); margin:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    /* basic card */
    .card { background:var(--card); border-radius:12px; padding:16px; box-shadow: 0 6px 18px rgba(2,6,23,0.06); border:1px solid rgba(15,23,42,0.04); }

    /* header */
    header.appbar { display:flex; gap:18px; align-items:center; padding:12px 18px; background:linear-gradient(180deg, #fff, rgba(255,255,255,0.9)); border-bottom:1px solid rgba(15,23,42,0.03); }
    .brand { display:flex; gap:12px; align-items:center; }
    .brand img { width:44px; height:44px; border-radius:6px; object-fit:cover; }
    .brand h1{ margin:0; font-size:20px; color:var(--emerald); font-weight:700; line-height:1; }
    .brand p{ margin:0; font-size:13px; color:var(--muted); }

    /* layout */
    .layout { display:flex; min-height:calc(100vh - 68px); }
    aside.sidebar { width:300px; padding:18px; background:transparent; }
    main.content { flex:1; padding:22px; }

    /* commodity list */
    .list { max-height:360px; overflow:auto; border-radius:8px; border:1px solid rgba(15,23,42,0.04); background:white; }
    .list button { display:block; width:100%; text-align:left; padding:12px 14px; border:none; background:transparent; cursor:pointer; color:var(--accent); font-weight:500; transition: background 160ms, transform 80ms; }
    .list button:hover { background:#f8fafc; transform:translateX(2px); color:var(--accent); }
    .list button.selected { background:var(--emerald); color:white; font-weight:700; box-shadow: 0 6px 14px rgba(16,185,129,0.08); border-radius:6px; }

    /* filters / date inputs UI */
    .filter-row { display:flex; gap:8px; align-items:center; }
    .date-input { display:flex; gap:8px; align-items:center; background:white; border-radius:8px; padding:6px; border:1px solid rgba(15,23,42,0.06); }
    .date-input input[type="date"] { border:none; padding:8px; outline:none; font-size:14px; background:transparent; }

    /* tabs */
    .nav-tabs button { background:none; border:none; padding:10px 12px; margin-right:6px; cursor:pointer; color:var(--muted); font-weight:600; }
    .nav-tabs button.active { color:var(--emerald); border-bottom:3px solid var(--emerald); padding-bottom:8px; }

    /* snapshot table scroll small */
    .snapshot-table { overflow:auto; max-height:220px; border-radius:8px; }

    /* recommendation grid */
    .top-recs { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }

    /* prediction chart card smaller */
    .chart-card { height:340px; }

    /* strategy */
    .strategy-card { padding:18px; border-radius:10px; }
    .strategy-buy { background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; }
    .strategy-wait { background:#fff7ed; border:1px solid #fde68a; color:#92400e; }
    .strategy-sell { background:#fff1f2; border:1px solid #fecaca; color:#7f1d1d; }

    /* small helper */
    .small-muted{ color:var(--muted); font-size:13px; }

    /* mobile */
    @media (max-width:1000px){
      aside.sidebar { display:none; }
      .chart-card { height:260px; }
      .brand h1 { font-size:18px; }
      header.appbar { padding:10px; }
      .layout { flex-direction:column; }
    }

    /* keyboard focus improvements */
    .list button:focus { outline: 3px solid rgba(16,185,129,0.12); }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="appbar" role="banner">
    <div class="brand" aria-hidden="false">
      <!-- uses icons/smartfarmher.png in your icons folder (as requested) -->
      <img src="icons/Smartfarmher.png" alt="Smart FarmHer logo" id="brand-icon" onerror="this.style.display='none'">
      <div>
        <h1>Smart FarmHer</h1>
        <p>Grow Good Sell Smart</p>
      </div>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button id="get-recommendations" class="card" style="background:var(--emerald); color:white; padding:10px 14px; border-radius:10px; border:none; cursor:pointer;"><i class="fas fa-lightbulb"></i> Get Recommendations</button>
    </div>
  </header>

  <!-- MAIN LAYOUT -->
  <div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Controls">
      <div style="margin-bottom:12px">
        <label class="small-muted">Markets</label>
        <select id="market-select" class="card" style="width:100%; padding:10px; border-radius:8px; margin-top:6px;"></select>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="geo-locate" title="Detect my location" class="card" style="padding:8px; border-radius:8px; background:#fff; border:1px solid rgba(15,23,42,0.06);"><i class="fas fa-location-arrow"></i></button>
          <button id="manage-markets-btn" title="Manage markets" class="card" style="padding:8px; border-radius:8px; border:1px solid rgba(15,23,42,0.06);">Manage</button>
        </div>
      </div>

      <div style="margin-bottom:12px">
        <label class="small-muted">Category</label>
        <select id="category-filter" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"><option>All</option></select>
      </div>

      <div style="margin-bottom:12px">
        <label class="small-muted">Commodity</label>
        <div id="commodity-list" class="list" tabindex="0" aria-label="Commodity list"></div>
      </div>

      <div style="margin-bottom:12px">
        <label class="small-muted">Variety</label>
        <select id="variety-filter" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);margin-top:6px"><option>All</option></select>
      </div>

      <div style="margin-bottom:8px">
        <label class="small-muted">Date range</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <div class="date-input" title="Start date"><input id="start-date" type="date" aria-label="Start date"></div>
          <div class="date-input" title="End date"><input id="end-date" type="date" aria-label="End date"></div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="apply-filters" style="flex:1;background:var(--emerald); color:white; padding:10px; border-radius:8px; border:none">Apply</button>
        <button id="reset-filters" style="flex:1;border-radius:8px;border:1px solid rgba(15,23,42,0.06)">Reset</button>
      </div>

      <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
        <button id="add-record-btn" style="background:#2563eb;color:white;padding:10px;border-radius:8px;border:none"><i class="fas fa-plus"></i> Add Record</button>
        <button id="import-csv-btn" style="background:#111827;color:white;padding:10px;border-radius:8px;border:none"><i class="fas fa-file-import"></i> Import CSV/XLSX</button>
        <button id="export-all-btn" style="background:#eef2ff;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)"><i class="fas fa-file-export"></i> Export CSV</button>
        <button id="clear-storage-btn" style="background:#fff1f2;color:#9f1239;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.04)"><i class="fas fa-trash"></i> Clear Local Save</button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="content" role="main">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:12px">
        <div>
          <h2 id="main-header" style="margin:0;font-size:24px;font-weight:700">Dashboard</h2>
          <div class="small-muted">Quick market insights & crop recommendations</div>
        </div>
      </div>

      <!-- tabs -->
      <div style="margin-bottom:16px" class="nav-tabs" role="tablist">
        <button id="tab-dashboard" class="active" role="tab" aria-selected="true">Dashboard</button>
        <button id="tab-prediction" role="tab">Predictive Analysis</button>
        <button id="tab-top-crops" role="tab">Top 10 Crops</button>
      </div>

      <!-- DASHBOARD -->
      <div id="dashboard-content" aria-live="polite">
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 style="margin:0">Latest Market Snapshot <small id="snapshot-date" class="small-muted"></small></h3>
              <div class="small-muted" style="margin-top:4px">Latest day across markets</div>
            </div>
            <div class="small-muted">Rows: <span id="snapshot-count">0</span></div>
          </div>

          <div class="snapshot-table card" style="margin-top:12px; padding:0;">
            <table style="width:100%;border-collapse:collapse">
              <thead><tr><th style="text-align:left;padding:8px;background:#fbfdff">Market</th><th style="text-align:left;padding:8px;background:#fbfdff">Commodity</th><th style="text-align:left;padding:8px;background:#fbfdff">Variety</th><th style="text-align:right;padding:8px;background:#fbfdff">Modal</th><th style="text-align:right;padding:8px;background:#fbfdff">Min</th><th style="text-align:right;padding:8px;background:#fbfdff">Max</th><th style="text-align:center;padding:8px;background:#fbfdff">Trend</th></tr></thead>
              <tbody id="snapshot-table-body"><tr><td colspan="7" style="text-align:center;padding:12px;color:var(--muted)">No data loaded.</td></tr></tbody>
            </table>
          </div>
        </div>

        <div id="summary-cards" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px"></div>

        <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-bottom:12px">
          <div class="card chart-card">
            <h4 style="margin:0 0 10px 0">Historical Price Trends</h4>
            <canvas id="price-chart" style="width:100%;height:calc(100% - 38px)"></canvas>
          </div>

          <div class="card">
            <h4 style="margin:0 0 10px 0">7-day Weather (Selected Market)</h4>
            <div id="weather-container" class="small-muted">Add market coordinates or use location detection to view forecast.</div>
            <div style="margin-top:10px" class="small-muted">Weather provided by Open-Meteo (free)</div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4 style="margin:0">Detailed Price Data (last 20 rows)</h4>
            <button id="export-csv" style="background:#0f172a;color:white;padding:8px;border-radius:8px;border:none"><i class="fas fa-download"></i> Export CSV</button>
          </div>
          <div style="margin-top:12px; overflow:auto; max-height:320px">
            <table style="width:100%;border-collapse:collapse">
              <thead style="background:#fbfdff"><tr><th style="padding:10px;text-align:left">Date</th><th style="padding:10px">Market</th><th style="padding:10px">Commodity</th><th style="padding:10px">Variety</th><th style="padding:10px">Modal</th><th style="padding:10px">Min</th><th style="padding:10px">Max</th><th style="padding:10px">Trend</th></tr></thead>
              <tbody id="price-table-body"><tr><td colspan="8" style="padding:12px;color:var(--muted);text-align:center">No data</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- PREDICTION -->
      <div id="prediction-content" class="hidden" aria-live="polite">
        <div class="card" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">90-Day Price Forecast</h3>
          <div style="max-width:900px;">
            <canvas id="forecast-chart" style="width:100%;height:260px"></canvas>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
          <div id="strategy-box" class="strategy-card strategy-wait card">
            <h4 style="margin:0">Strategic Signal</h4>
            <div id="strategy-signal" style="font-size:28px;font-weight:800;margin-top:8px">â€”</div>
            <div id="strategy-detail" class="small-muted" style="margin-top:8px">â€”</div>
          </div>

          <div class="strategy-card card">
            <h4 style="margin:0">Peak Profitability</h4>
            <div id="peak-month" style="font-size:28px;font-weight:700;margin-top:8px">â€”</div>
            <div class="small-muted" style="margin-top:8px">Historically best month</div>
          </div>
        </div>

        <div style="margin-top:12px" id="prediction-outlook"></div>
      </div>

      <!-- TOP CROPS -->
      <div id="top-crops-content" class="hidden">
        <div class="card" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">Top Crop Recommendations</h3>
          <div id="top-crops-container" class="top-recs"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal-add-record" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:16px;z-index:2000">
    <div class="card" style="max-width:720px;margin:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Add / Edit Record</h3>
        <button onclick="document.getElementById('modal-add-record').style.display='none'">âœ•</button>
      </div>
      <form id="record-form" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px">
        <div><label class="small-muted">Date</label><input id="rec-date" type="date" required style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Market</label><select id="rec-market" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></select></div>
        <div><label class="small-muted">Commodity</label><input id="rec-commodity" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Variety</label><input id="rec-variety" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Category</label><input id="rec-category" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">District</label><input id="rec-district" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Modal (â‚¹/kg)</label><input id="rec-modal" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Min (â‚¹/kg)</label><input id="rec-min" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div><label class="small-muted">Max (â‚¹/kg)</label><input id="rec-max" type="number" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>

        <div style="grid-column:1 / -1;display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button type="submit" style="background:var(--emerald);border:none;color:white;padding:8px 12px;border-radius:8px">Save</button>
          <button type="button" id="delete-record-btn" style="background:#fee2e2;border:1px solid #fca5a5;color:#9f1239;padding:8px;border-radius:8px">Delete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Crop Defaults modal -->
  <div id="modal-crop-defaults" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:16px;z-index:2000">
    <div class="card" style="max-width:560px;margin:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Edit Crop Defaults</h3>
        <button onclick="document.getElementById('modal-crop-defaults').style.display='none'">âœ•</button>
      </div>
      <div style="margin-top:12px">
        <label class="small-muted">Commodity</label>
        <select id="crop-meta-commodity" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></select>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <div style="flex:1"><label class="small-muted">Expected yield (kg/ha)</label><input id="crop-yield" type="number" min="0" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
        <div style="flex:1"><label class="small-muted">Area (ha)</label><input id="crop-area" type="number" min="0" step="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="save-crop-defaults" class="card" style="background:var(--emerald);color:white;padding:10px;border-radius:8px;border:none">Save</button>
        <button onclick="document.getElementById('modal-crop-defaults').style.display='none'" class="card" style="padding:10px;border-radius:8px">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* ===================
   Config & in-memory
   =================== */
const PRELOADED_RAW_URL = 'https://raw.githubusercontent.com/chetankdrmz-max/Smart_FarmHer/refs/heads/main/data/Raw_Concatenated.csv';
const CROP_META_URL = 'https://raw.githubusercontent.com/chetankdrmz-max/Smart_FarmHer/main/data/crop_meta.json'; // optional - page will try to fetch it, fallback to defaults
const STORAGE_KEY = 'agri_dashboard_store_v1';

let commodityRows = []; // processed rows
let markets = [];
let filteredRows = [];
let currentCommodity = '';
let currentVariety = 'All';
let priceChart = null, forecastChart = null;

/* Minimal default crop meta (fallback). I included some common crops.
   You can later add a full data/crop_meta.json in your repo; the page will fetch it automatically.
   Each entry: { duration_days, yield_kg_per_ha } - these are reasonable defaults and must be tuned regionally.
*/
const CROP_META_DEFAULTS = {
  "Beans": { duration_days: 75, yield_kg_per_ha: 8000 },
  "Beetroot": { duration_days: 90, yield_kg_per_ha: 20000 },
  "Apple": { duration_days: 365, yield_kg_per_ha: 10000 },
  "Banana": { duration_days: 365, yield_kg_per_ha: 40000 },
  "Ragi (Finger Millet)": { duration_days: 120, yield_kg_per_ha: 1500 }
};

/* Editable crop defaults saved per user */
let userCropDefaults = JSON.parse(localStorage.getItem('userCropDefaults') || '{}');

/* -----------------------
   CSV parsing & normalization
   ----------------------- */
function parseCSVText(text, options={header:true,skipEmptyLines:true}) {
  return new Promise((resolve) => {
    if (typeof Papa !== 'undefined') {
      try {
        const res = Papa.parse(text, Object.assign({}, options));
        resolve(res.data);
      } catch (e) {
        resolve(parseCSVFallback(text, { header: options.header }));
      }
    } else {
      resolve(parseCSVFallback(text, { header: options.header }));
    }
  });
}
function parseCSVFallback(text,{delimiter=',',header=true}={}){ const rows=[]; let cur='',row=[],inQuotes=false; for(let i=0;i<text.length;i++){ const ch=text[i], next=text[i+1]; if(ch==='"'){ if(inQuotes && next==='"'){ cur+='"'; i++; } else { inQuotes=!inQuotes; } continue; } if(ch===delimiter && !inQuotes){ row.push(cur); cur=''; continue; } if((ch=='\n' || ch=='\r') && !inQuotes){ if(ch=='\r' && next=='\n') i++; row.push(cur); rows.push(row); row=[]; cur=''; continue; } cur+=ch; } if(cur!=='' || row.length>0){ row.push(cur); rows.push(row);} if(!header) return rows; const headers=rows.shift().map(h=>h.trim()); return rows.map(r=>{ const obj={}; for(let i=0;i<headers.length;i++) obj[headers[i]] = r[i]!==undefined ? r[i] : ''; return obj; });}

/* Normalization function to create consistent row objects */
function normalizeRow(r){
  const dateStr = r.Date || r.date || r.DATE || r.date_of || r['Date '] || '';
  const commodity = (r.Commodity || r.commodity || r.Item || r.item || r['Commodity'] || '').toString().trim();
  const variety = (r.Variety || r.variety || r.SubVariety || r['Sub Variety'] || '').toString().trim() || 'Default';
  const market = (r.Market || r.market || r.MarketName || r['Market '] || '').toString().trim() || 'Default Market';
  const district = (r.District || r.district || r.Districts || '').toString().trim();
  const modal = parseFloat(r.Modal_Price_Kg || r.Modal_Price || r['modal_price'] || r.modal || r['Modal'] || 0) || 0;
  const minp = parseFloat(r.Min_Price_Kg || r.Min_Price || r.min || 0) || 0;
  const maxp = parseFloat(r.Max_Price_Kg || r.Max_Price || r.max || 0) || 0;
  const category = (r.Category || r.category || r.Crop_Type || '').toString().trim() || 'Other';
  const date = dateStr ? new Date(dateStr) : null;
  return { date, commodity, variety, market, district, modalPriceKg: modal, minPriceKg: minp, maxPriceKg: maxp, category };
}

/* Process preloaded CSV rows */
function processPreloadedData(rows){
  const parsed = rows.map(normalizeRow).filter(item => item && item.date instanceof Date && !isNaN(item.date.getTime()) && item.commodity);
  if(!parsed.length) { alert('No valid rows parsed from the file. Check CSV columns.'); return; }
  const foundMarkets = [...new Set(parsed.map(p=>p.market||'Default Market'))];
  if(markets.length===0){ markets = foundMarkets.map(n=>({name:n,lat:null,lon:null})); } else { foundMarkets.forEach(m=>{ if(!markets.find(x=>x.name===m)) markets.push({name:m,lat:null,lon:null}); }); }
  // merge but avoid duplicates by unique key (market+commodity+variety+date)
  const existingKeys = new Set(commodityRows.map(r=>`${r.market}||${r.commodity}||${r.variety}||${new Date(r.date).toISOString().split('T')[0]}`));
  parsed.forEach(p=>{
    const key = `${p.market}||${p.commodity}||${p.variety}||${new Date(p.date).toISOString().split('T')[0]}`;
    if(!existingKeys.has(key)){ commodityRows.push(p); existingKeys.add(key); }
  });
  commodityRows.sort((a,b)=>new Date(a.date)-new Date(b.date));
  localStorage.setItem(STORAGE_KEY, JSON.stringify({rows:commodityRows,markets}));
  refreshAllUI();
}

/* -----------------------
   UI: populate selectors & lists
   ----------------------- */
function populateMarketSelect(){
  const sel = document.getElementById('market-select'); if(!sel) return;
  sel.innerHTML='';
  markets.forEach(m=>{ const o=document.createElement('option'); o.value=m.name; o.textContent=m.name; sel.appendChild(o); });
  if(!sel.value && sel.options.length) sel.value = sel.options[0].value;
}
function populateCategoryFilter(){
  const cats = [...new Set(commodityRows.map(r=>r.category||'Other'))].sort();
  const sel = document.getElementById('category-filter'); if(!sel) return;
  sel.innerHTML = '<option value="All">All</option>';
  cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
}
function populateCommodityList(){
  const container = document.getElementById('commodity-list'); if(!container) return;
  const selCat = (document.getElementById('category-filter')||{}).value || 'All';
  const comms = [...new Set(commodityRows.filter(r => selCat==='All' || r.category===selCat).map(r=>r.commodity))].sort();
  container.innerHTML='';
  comms.forEach(c => {
    const btn = document.createElement('button');
    btn.textContent = c;
    btn.setAttribute('data-commodity', c);
    btn.onclick = ()=>{ selectCommodity(c); };
    btn.onmouseover = ()=> btn.style.transition='background 120ms';
    btn.onfocus = ()=> btn.style.outline='none';
    container.appendChild(btn);
  });
  // set default
  if(!currentCommodity && comms.length) currentCommodity = comms[0];
  highlightSelectedCommodity();
}
function highlightSelectedCommodity(){
  document.querySelectorAll('#commodity-list button').forEach(b=>{
    if(b.getAttribute('data-commodity') === currentCommodity) { b.classList.add('selected'); b.setAttribute('aria-current','true'); b.focus({preventScroll:true}); }
    else { b.classList.remove('selected'); b.removeAttribute('aria-current'); }
  });
}
function selectCommodity(name){
  currentCommodity = name;
  populateVarietyFilter();
  applyFilters();
  highlightSelectedCommodity();
  // also open dashboard tab for context
  document.getElementById('tab-dashboard').click();
}
function populateVarietyFilter(){
  const sel = document.getElementById('variety-filter'); if(!sel) return;
  const varieties = [...new Set(commodityRows.filter(r=>r.commodity===currentCommodity).map(r=>r.variety || 'Default'))].sort();
  sel.innerHTML = '<option value="All">All</option>';
  varieties.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  sel.value='All';
}

/* set default date range to last full year by default */
function setDefaultDateRange(){
  if(!commodityRows.length) return;
  const dates = commodityRows.map(r=>new Date(r.date).getTime());
  const maxDate = new Date(Math.max(...dates));
  const minDate = new Date(Math.min(...dates));
  const endEl = document.getElementById('end-date'); const startEl = document.getElementById('start-date');
  if(endEl) endEl.value = maxDate.toISOString().split('T')[0];
  const startCandidate = new Date(maxDate); startCandidate.setFullYear(startCandidate.getFullYear()-1);
  if(startEl) startEl.value = (startCandidate < minDate ? minDate : startCandidate).toISOString().split('T')[0];
}

/* -----------------------
   Applying filters & updating UI
   ----------------------- */
function applyFilters(){
  const start = new Date((document.getElementById('start-date')||{}).value || '1970-01-01');
  const end = new Date((document.getElementById('end-date')||{}).value || '2100-01-01');
  const cat = (document.getElementById('category-filter')||{}).value || 'All';
  currentVariety = (document.getElementById('variety-filter')||{}).value || 'All';
  filteredRows = commodityRows.filter(r=>{
    return (cat === 'All' || r.category === cat) &&
           (!currentCommodity || r.commodity === currentCommodity) &&
           (currentVariety === 'All' || r.variety === currentVariety) &&
           (new Date(r.date) >= start && new Date(r.date) <= end);
  }).sort((a,b)=>new Date(a.date)-new Date(b.date));
  updateDashboardUI();
}

function updateDashboardUI(){
  document.getElementById('main-header').textContent = currentCommodity ? `${currentCommodity} Dashboard` : 'Dashboard';
  updateSnapshotTable();
  updateSummaryCards();
  updatePriceChart();
  updateDataTable();
  renderWeatherForCurrentMarket();
  // if prediction tab visible, recompute
  if(!document.getElementById('prediction-content').classList.contains('hidden')) computeForecastAndRender();
}

/* Snapshot table */
function updateSnapshotTable(){
  const body = document.getElementById('snapshot-table-body'); if(!body) return;
  if(!commodityRows.length){ body.innerHTML='<tr><td colspan="7" style="text-align:center;padding:12px;color:var(--muted)">No data loaded.</td></tr>'; return; }
  const dates = commodityRows.map(r=>new Date(r.date));
  const latest = new Date(Math.max.apply(null, dates));
  const latestStr = latest.toISOString().split('T')[0];
  document.getElementById('snapshot-date').textContent = `(${latest.toLocaleDateString('en-GB')})`;
  const snapshot = commodityRows.filter(r => (new Date(r.date)).toISOString().split('T')[0] === latestStr);
  document.getElementById('snapshot-count').textContent = snapshot.length;
  if(!snapshot.length){ body.innerHTML='<tr><td colspan="7" style="text-align:center;padding:12px;color:var(--muted)">No data for latest date.</td></tr>'; return; }
  body.innerHTML = snapshot.map(s => {
    const prevRow = commodityRows.find(rr => rr.commodity===s.commodity && rr.market===s.market && new Date(rr.date) < new Date(s.date));
    let trend = 'â€”', trendHtml = 'â€”';
    if(prevRow){
      const diff = s.modalPriceKg - prevRow.modalPriceKg;
      if(Math.abs(diff) < 0.001) trendHtml='â€”';
      else if(diff > 0) trendHtml = '<span style="color:#16a34a">â–²</span>';
      else trendHtml = '<span style="color:#ef4444">â–¼</span>';
    }
    return `<tr><td style="padding:8px">${escapeHtml(s.market)}</td><td style="padding:8px">${escapeHtml(s.commodity)}</td><td style="padding:8px">${escapeHtml(s.variety)}</td><td style="padding:8px;text-align:right">â‚¹${s.modalPriceKg.toFixed(2)}</td><td style="padding:8px;text-align:right">â‚¹${s.minPriceKg.toFixed(2)}</td><td style="padding:8px;text-align:right">â‚¹${s.maxPriceKg.toFixed(2)}</td><td style="padding:8px;text-align:center">${trendHtml}</td></tr>`;
  }).join('');
}

/* Summary cards */
function updateSummaryCards(){
  const container = document.getElementById('summary-cards'); if(!container) return;
  if(!filteredRows.length){ container.innerHTML = '<div class="card" style="text-align:center;color:var(--muted)">No data for selection</div>'; return; }
  const latest = filteredRows[filteredRows.length-1];
  const prev = filteredRows[filteredRows.length-2] || latest;
  const prices = filteredRows.map(r=>r.modalPriceKg);
  const avg = prices.reduce((a,b)=>a+b,0)/prices.length;
  const minP = Math.min(...prices), maxP = Math.max(...prices);
  const cards = [
    {title:'Latest Price', value:`â‚¹${latest.modalPriceKg.toFixed(2)}`, sub: currentCommodity || ''},
    {title:'Average Price', value:`â‚¹${avg.toFixed(2)}`, sub:'Period Avg'},
    {title:'Lowest Price', value:`â‚¹${minP.toFixed(2)}`, sub:'In Period'},
    {title:'Highest Price', value:`â‚¹${maxP.toFixed(2)}`, sub:'In Period'},
  ];
  container.innerHTML = cards.map(c=>`<div class="card"><div style="color:var(--muted);font-size:13px">${c.title}</div><div style="font-weight:700;font-size:20px;margin-top:6px">${c.value}</div><div class="small-muted">${c.sub||''}</div></div>`).join('');
}

/* Price chart: basic time series */
function updatePriceChart(){
  const ctx = document.getElementById('price-chart')?.getContext('2d'); if(!ctx) return;
  if(priceChart) priceChart.destroy();
  if(!filteredRows.length) { ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height); return; }
  priceChart = new Chart(ctx, {
    type:'line',
    data:{ datasets:[
      { label:'Price Trend', data: filteredRows.map(r=>({x:new Date(r.date), y:r.modalPriceKg})), borderColor:'rgb(16,185,129)', backgroundColor:'rgba(16,185,129,0.06)', fill:true, tension:0.2, pointRadius:2 }
    ] },
    options: { parsing:false, responsive:true, maintainAspectRatio:false, scales:{ x:{ type:'time', time:{ unit:'month' }, grid:{color:'rgba(15,23,42,0.04)'} }, y:{ beginAtZero:false, grid:{color:'rgba(15,23,42,0.04)'} } }, plugins:{ legend:{display:true} } }
  });
}

/* Data table */
function updateDataTable(){
  const body = document.getElementById('price-table-body'); if(!body) return;
  if(!filteredRows.length){ body.innerHTML = '<tr><td colspan="8" style="padding:12px;text-align:center;color:var(--muted)">No data</td></tr>'; return; }
  const last = filteredRows.slice(-20).reverse();
  body.innerHTML = last.map(r=>{
    const prev = filteredRows.find(rr=>rr.commodity===r.commodity && new Date(rr.date) < new Date(r.date));
    let trendHtml = 'â€”';
    if(prev){
      const diff = r.modalPriceKg - prev.modalPriceKg;
      if(Math.abs(diff) < 0.001) trendHtml='â€”';
      else if(diff > 0) trendHtml = '<span style="color:#16a34a">â–²</span>';
      else trendHtml = '<span style="color:#ef4444">â–¼</span>';
    }
    return `<tr style="border-bottom:1px solid rgba(15,23,42,0.04)"><td style="padding:10px">${new Date(r.date).toLocaleDateString()}</td><td style="padding:10px">${escapeHtml(r.market)}</td><td style="padding:10px">${escapeHtml(r.commodity)}</td><td style="padding:10px">${escapeHtml(r.variety)}</td><td style="padding:10px;text-align:right">â‚¹${r.modalPriceKg.toFixed(2)}</td><td style="padding:10px;text-align:right">â‚¹${r.minPriceKg.toFixed(2)}</td><td style="padding:10px;text-align:right">â‚¹${r.maxPriceKg.toFixed(2)}</td><td style="padding:10px;text-align:center">${trendHtml}</td></tr>`;
  }).join('');
}

/* -----------------------
   Forecasting & Strategy
   - Enhanced: uses last-season trend & crop duration to compute harvest date and revenue
   ----------------------- */

/* compute forecast: smoothing + linear trend on last N points, returns array of {date,y} for days ahead */
function computeSimpleForecast(series, days=90){
  if(!series.length) return [];
  // Smooth using moving average
  const prices = series.map(s=>s.y);
  const smooth = prices.map((v,i,arr)=>{ const w=7; const start=Math.max(0,i-w+1); const seg=arr.slice(start,i+1); return seg.reduce((a,b)=>a+b,0)/seg.length; });
  // Linear regression on last N
  const N = Math.min(120, smooth.length);
  const x = [], y = [];
  for(let i=0;i<N;i++){ x.push(i); y.push(smooth[smooth.length-N+i]); }
  const xm = x.reduce((a,b)=>a+b,0)/x.length;
  const ym = y.reduce((a,b)=>a+b,0)/y.length;
  let num=0, den=0;
  for(let i=0;i<x.length;i++){ num += (x[i]-xm)*(y[i]-ym); den += (x[i]-xm)*(x[i]-xm); }
  const slope = den === 0 ? 0 : num/den;
  const intercept = ym - slope*xm;
  const lastDate = new Date(series[series.length-1].date);
  const forecasts = [];
  for(let d=1; d<=days; d++){
    const pred = intercept + slope*(x.length-1 + d);
    forecasts.push({ date: new Date(lastDate.getTime() + 24*3600*1000*d), y: Math.max(0, pred) });
  }
  return forecasts;
}

/* compute forecast and render chart + strategy */
function computeForecastAndRender(){
  const predEl = document.getElementById('prediction-content');
  if(!filteredRows.length){ document.getElementById('strategy-signal').textContent='â€”'; document.getElementById('strategy-detail').textContent='â€”'; return; }
  // series sorted by date
  const series = filteredRows.map(r=>({date:new Date(r.date), y:r.modalPriceKg})).sort((a,b)=>a.date-b.date);
  if(series.length < 10){ // we need some history
    document.getElementById('strategy-signal').textContent='â€”';
    document.getElementById('strategy-detail').textContent='Not enough historical data for a reliable forecast (requires multiple weeks/months).';
    renderEmptyForecastChart();
    return;
  }
  const forecast = computeSimpleForecast(series, 90);
  // render forecast chart (compact)
  const ctx = document.getElementById('forecast-chart')?.getContext('2d'); if(!ctx) return;
  if(forecastChart) forecastChart.destroy();
  const dataHist = series.map(s=>({x:s.date, y:s.y}));
  const dataFc = forecast.map(f=>({x:f.date, y:Math.round(f.y*100)/100}));
  forecastChart = new Chart(ctx, {
    type:'line',
    data:{
      datasets:[
        { label:'Historical Price', data: dataHist, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.06)', fill:true, tension:0.25, pointRadius:0 },
        { label:'Forecasted Price', data: dataFc, borderColor:'#ef4444', borderDash:[6,6], pointRadius:0, fill:false, tension:0.25 }
      ]
    },
    options:{ parsing:false, responsive:true, maintainAspectRatio:false, scales:{ x:{ type:'time', time:{unit:'month'} }, y:{ beginAtZero:false } }, plugins:{ legend:{display:true} } }
  });

  // compute short-term slope to decide strategy
  const look = 14;
  const fvals = forecast.slice(0,look).map(f=>f.y);
  const sl = (fvals[fvals.length-1] - fvals[0]) / Math.max(1, fvals[0]);
  const vol = Math.sqrt(series.reduce((acc,p)=>acc + Math.pow(p.y - (series.reduce((a,b)=>a+b.y,0)/series.length),2),0)/series.length);
  const confidence = Math.max(0, Math.min(100, 100 - vol*200));
  document.getElementById('forecast-confidence')?.textContent = `${Math.round(confidence)}%`;

  // strategy selection thresholds tuned empirically
  let signal, detail, className;
  if(sl > 0.08) { signal='Grow Now'; detail='Prices are currently above average and the 90-day forecast is positive. Planting now aligns with a rising market.'; className='strategy-buy'; }
  else if(sl > 0.02) { signal='Consider Growing'; detail='The 90-day forecast shows a positive trend. Good potential for profit if you plant soon.'; className='strategy-buy'; }
  else if(sl < -0.06) { signal='Wait'; detail='Prices are forecast to be stable or decrease. The market is not currently in its peak seasonal period.'; className='strategy-wait'; }
  else { signal='Wait'; detail='No strong upward trend â€” hold or seek alternative crops with better short-term outlook.'; className='strategy-wait'; }
  document.getElementById('strategy-signal').textContent = signal;
  document.getElementById('strategy-detail').textContent = detail;
  // set style class
  const sb = document.getElementById('strategy-box');
  sb.className = `strategy-card ${className} card`;

  // find peak profitability month historically
  const monthly = {};
  filteredRows.forEach(r=>{ const m = new Date(r.date).getMonth()+1; monthly[m] = monthly[m] || []; monthly[m].push(r.modalPriceKg); });
  const avgByMonth = Object.keys(monthly).map(k=>({m:parseInt(k), avg: monthly[k].reduce((a,b)=>a+b,0)/monthly[k].length}));
  if(avgByMonth.length){ const peak = avgByMonth.reduce((a,b)=>a.avg > b.avg ? a : b); const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; document.getElementById('peak-month').textContent = months[peak.m-1]; } else document.getElementById('peak-month').textContent='â€”';

  // Prediction outlook: estimate harvest date and revenue if user plants today, using crop meta defaults + user overrides
  const crop = currentCommodity;
  const meta = (window.CROP_META && window.CROP_META[crop]) || CROP_META_DEFAULTS[crop] || {};
  const duration = meta.duration_days || 90;
  const yieldPerHa = (userCropDefaults[crop] && userCropDefaults[crop].yield) || meta.yield_kg_per_ha || 10000;
  const areaHa = (userCropDefaults[crop] && userCropDefaults[crop].area) || 0.1; // default 0.1ha
  const harvestDate = new Date(); harvestDate.setDate(harvestDate.getDate() + duration);
  // approximate price at harvest: use forecast nearest to harvestDate
  const fcAtHarvest = forecast.find(f => new Date(f.date) >= harvestDate) || forecast[forecast.length-1] || { y: series[series.length-1].y };
  const expectedPrice = Math.round(fcAtHarvest.y * 100)/100;
  const expectedRevenue = Math.round(expectedPrice * yieldPerHa * areaHa);
  const outlookDiv = document.getElementById('prediction-outlook');
  outlookDiv.innerHTML = `<div class="card"><strong>If you plant <em>${escapeHtml(crop||'this crop')}</em> today:</strong>
    <div style="margin-top:8px" class="small-muted">Expected harvest: ${harvestDate.toLocaleDateString()} (duration â‰ˆ ${duration} days)</div>
    <div style="margin-top:8px"><strong>Estimated modal price at harvest:</strong> â‚¹${expectedPrice.toFixed(2)} /kg</div>
    <div style="margin-top:6px"><strong>Estimated revenue for ${areaHa} ha:</strong> â‚¹${expectedRevenue.toLocaleString()}</div>
  </div>`;
}

/* Render empty chart when not enough data */
function renderEmptyForecastChart(){
  const ctx = document.getElementById('forecast-chart')?.getContext('2d'); if(!ctx) return;
  if(forecastChart) forecastChart.destroy();
  forecastChart = new Chart(ctx, {
    type:'line',
    data:{ datasets:[] },
    options:{ plugins:{ legend:{display:false} }, scales:{x:{display:false}, y:{display:false}} }
  });
}

/* -----------------------
   Recommendations (top 10)
   ----------------------- */
function generateRecommendations(count=10){
  const commodities = [...new Set(commodityRows.map(r=>r.commodity))];
  const recs = commodities.map(name=>{
    const rows = commodityRows.filter(r=>r.commodity===name).slice(-90);
    if(rows.length < 6) return null;
    const prices = rows.map(r=>r.modalPriceKg);
    const avg = prices.reduce((a,b)=>a+b,0)/prices.length;
    const change = (prices[prices.length-1]-prices[0]) / Math.max(1, prices[0]);
    const variance = prices.reduce((s,p)=>s+Math.pow(p-avg,2),0)/prices.length;
    const vol = Math.sqrt(variance)/Math.max(1,avg);
    const score = (1 + change) / (vol + 0.05);
    const risk = vol < 0.1 ? 'Low' : vol < 0.2 ? 'Medium' : 'High';
    return {commodity:name, avgPrice:avg, priceChangePct: change*100, volatility: vol, score, risk};
  }).filter(Boolean).sort((a,b)=>b.score-a.score);
  return recs.slice(0,count);
}
function generateTopCropsUI(){
  const recs = generateRecommendations(10);
  const cont = document.getElementById('top-crops-container'); if(!cont) return;
  if(!recs.length) { cont.innerHTML = '<div class="small-muted">Not enough data for recommendations.</div>'; return; }
  cont.innerHTML = recs.map((r,i)=>`<div class="card" style="border:1px solid rgba(16,185,129,0.06);"><div style="display:flex;justify-content:space-between;align-items:start"><div><div style="font-size:14px;color:var(--muted)">#${i+1}</div><div style="font-weight:700;font-size:16px">${r.commodity}</div><div class="small-muted" style="margin-top:6px">Avg â‚¹${r.avgPrice.toFixed(2)}/kg</div></div><div style="text-align:right"><span style="background:${r.risk==='Low'?'#ecfdf5':r.risk==='Medium'?'#fffbeb':'#fff1f2'};padding:6px 8px;border-radius:12px;font-size:12px">${r.risk} RISK</span></div></div><div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end"><button onclick="selectCommodity('${r.commodity.replace(/'/g,'\\\'')}')" style="background:var(--emerald);color:white;padding:8px;border-radius:8px;border:none">View</button></div></div>`).join('');
}

/* Grow sheet and youtube were removed as requested */

/* -----------------------
   Weather
   ----------------------- */
async function renderWeatherForCurrentMarket(){
  const sel = document.getElementById('market-select'); if(!sel) return;
  const marketName = sel.value;
  const market = markets.find(m=>m.name===marketName);
  const container = document.getElementById('weather-container'); if(!container) return;
  if(!market || !market.lat || !market.lon){ container.innerHTML = `<div class="small-muted">No coordinates for "${marketName}". Use Manage or location detect to add coordinates.</div>`; return; }
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${market.lat}&longitude=${market.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;
  try {
    const res = await fetch(url); const json = await res.json();
    if(!json.daily){ container.innerHTML = `<div class="small-muted">Weather not available</div>`; return; }
    const days = json.daily.time.map((t,i)=>({date:t, max: json.daily.temperature_2m_max[i], min: json.daily.temperature_2m_min[i], precip: json.daily.precipitation_sum[i]}));
    container.innerHTML = days.map(d=>`<div style="margin-bottom:6px"><strong>${new Date(d.date).toLocaleDateString()}</strong>: ${d.max}Â°/${d.min}Â° - Rain ${d.precip} mm</div>`).join('');
  } catch(e){ container.innerHTML = `<div class="small-muted">Weather fetch error</div>`; console.warn(e); }
}

/* -----------------------
   Save/load and local storage
   ----------------------- */
function saveToLocal(){
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify({rows:commodityRows,markets})); } catch(e){ console.warn('Save failed', e); }
}
function loadFromLocalSync(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ const parsed = JSON.parse(raw); commodityRows = parsed.rows||[]; markets = parsed.markets||[]; refreshAllUI(); return true; }
  } catch(e){ console.warn(e); }
  return false;
}
function clearLocal(){ if(!confirm('Clear all saved data?')) return; try{ localStorage.removeItem(STORAGE_KEY); }catch(e){} commodityRows=[]; markets=[]; refreshAllUI(); alert('Cleared'); }

/* -----------------------
   File import handlers
   ----------------------- */
async function handleFileImport(file){
  if(!file) return;
  try {
    const name = file.name.toLowerCase();
    if(name.endsWith('.csv') || file.type.includes('text')) {
      const text = await file.text();
      const rows = await parseCSVText(text, {header:true,skipEmptyLines:true});
      processPreloadedData(rows);
    } else {
      const ab = await file.arrayBuffer();
      const wb = XLSX.read(ab, {type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, {defval:''});
      processPreloadedData(rows);
    }
    alert('Imported successfully');
  } catch(e){ console.error(e); alert('Import failed: ' + e.message); }
}

/* -----------------------
   Utilities
   ----------------------- */
function escapeHtml(str) {
  return String(str || '')
    .replace(/&/g, "&amp;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

/* -----------------------
   Load external crop_meta.json if present, else fallback to defaults
   ----------------------- */
async function loadCropMeta(){
  try {
    const resp = await fetch(CROP_META_URL);
    if(!resp.ok) throw new Error('no remote crop_meta');
    const json = await resp.json();
    window.CROP_META = json;
    console.log('Loaded crop_meta.json (remote)');
  } catch(e){
    window.CROP_META = Object.assign({}, CROP_META_DEFAULTS);
    console.log('Using fallback crop meta defaults');
  }
}

/* -----------------------
   Startup & event wiring
   ----------------------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  // load crop meta first (non-blocking)
  await loadCropMeta();

  // wire buttons
  document.getElementById('start-analysis-btn')?.addEventListener('click', async ()=>{
    // When user clicks initial preload, fetch CSV and parse
    try {
      alert('Preloaded dataset loading... (hook your CSV fetch here)');
      const resp = await fetch(PRELOADED_RAW_URL);
      if(!resp.ok) throw new Error('Fetch failed: ' + resp.status);
      const text = await resp.text();
      const rows = await parseCSVText(text, {header:true,skipEmptyLines:true});
      processPreloadedData(rows);
      document.getElementById('start-screen')?.classList?.add('hidden');
    } catch(e){ console.error(e); alert('Preload failed: ' + (e.message||e)); }
  });

  document.getElementById('import-csv-btn')?.addEventListener('click', ()=>document.getElementById('file-input')?.click());
  // virtual hidden file input for import
  const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.accept='.csv,.xlsx,.xls,text/csv'; fileInput.style.display='none';
  fileInput.addEventListener('change', ev=>handleFileImport(ev.target.files[0])); document.body.appendChild(fileInput);
  document.getElementById('import-csv-btn')?.addEventListener('click', ()=>fileInput.click());

  document.getElementById('apply-filters')?.addEventListener('click', applyFilters);
  document.getElementById('reset-filters')?.addEventListener('click', ()=>{ document.getElementById('category-filter').value='All'; currentCommodity=''; populateCommodityList(); setDefaultDateRange(); applyFilters(); });
  document.getElementById('add-record-btn')?.addEventListener('click', openAddModal);
  document.getElementById('export-all-btn')?.addEventListener('click', ()=>{ if(!commodityRows.length){ alert('No data'); return; } const headers=['Date','Market','Commodity','Variety','Category','District','Min','Max','Modal']; const rows=commodityRows.map(r=>[new Date(r.date).toISOString().split('T')[0],r.market,r.commodity,r.variety,r.category,r.district,r.minPriceKg,r.maxPriceKg,r.modalPriceKg]); const csv=[headers.join(','), ...rows.map(rr=>rr.map(cell=>typeof cell==='string' && cell.includes(',')?`"${cell.replace(/"/g,'""')}"`:cell).join(',')).join('\n')]; const link=document.createElement('a'); link.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv.join('\n')); link.download='agri_export.csv'; document.body.appendChild(link); link.click(); link.remove(); });

  document.getElementById('clear-storage-btn')?.addEventListener('click', clearLocal);

  // Get recommendations button
  document.getElementById('get-recommendations')?.addEventListener('click', ()=>{ generateTopCropsUI(); document.getElementById('tab-top-crops').click(); });

  // Tabs
  document.getElementById('tab-dashboard')?.addEventListener('click', ()=>{ document.getElementById('dashboard-content').classList.remove('hidden'); document.getElementById('prediction-content').classList.add('hidden'); document.getElementById('top-crops-content').classList.add('hidden'); document.querySelectorAll('.nav-tabs button').forEach(b=>b.classList.remove('active')); document.getElementById('tab-dashboard').classList.add('active'); });
  document.getElementById('tab-prediction')?.addEventListener('click', ()=>{ document.getElementById('dashboard-content').classList.add('hidden'); document.getElementById('prediction-content').classList.remove('hidden'); document.getElementById('top-crops-content').classList.add('hidden'); document.querySelectorAll('.nav-tabs button').forEach(b=>b.classList.remove('active')); document.getElementById('tab-prediction').classList.add('active'); computeForecastAndRender(); });
  document.getElementById('tab-top-crops')?.addEventListener('click', ()=>{ document.getElementById('dashboard-content').classList.add('hidden'); document.getElementById('prediction-content').classList.add('hidden'); document.getElementById('top-crops-content').classList.remove('hidden'); document.querySelectorAll('.nav-tabs button').forEach(b=>b.classList.remove('active')); document.getElementById('tab-top-crops').classList.add('active'); generateTopCropsUI(); });

  document.getElementById('market-select')?.addEventListener('change', renderWeatherForCurrentMarket);

  document.getElementById('export-csv')?.addEventListener('click', ()=>{
    const rows = filteredRows.map(r => [new Date(r.date).toISOString().split('T')[0], r.market, r.commodity, r.variety, r.minPriceKg, r.maxPriceKg, r.modalPriceKg]);
    if(!rows.length){ alert('No visible rows'); return; }
    const csv = ['Date,Market,Commodity,Variety,Min,Max,Modal', ...rows.map(r=>r.join(','))].join('\n');
    const link = document.createElement('a'); link.href='data:text/csv;charset=utf-8,' + encodeURIComponent(csv); link.download='export_filtered.csv'; document.body.appendChild(link); link.click(); link.remove();
  });

  // load local saved data if present
  loadFromLocalSync();

  // populate UI from initial state
  populateMarketSelect();
  populateCategoryFilter();
  populateCommodityList();
  populateVarietyFilter();
  setDefaultDateRange();
  applyFilters();

  // geolocation
  document.getElementById('geo-locate')?.addEventListener('click', ()=>{
    if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      const name = `My Location (${lat.toFixed(3)},${lon.toFixed(3)})`;
      markets.unshift({ name, lat, lon });
      saveToLocal();
      populateMarketSelect();
      document.getElementById('market-select').value = name;
      renderWeatherForCurrentMarket();
      alert('Location saved to markets list');
    }, err=>{ alert('Failed to get location: ' + err.message); });
  });

  // Crop defaults edit modal wiring
  document.getElementById('save-crop-defaults')?.addEventListener('click', ()=>{
    const commodity = document.getElementById('crop-meta-commodity').value;
    const yieldVal = parseFloat(document.getElementById('crop-yield').value) || 0;
    const areaVal = parseFloat(document.getElementById('crop-area').value) || 0;
    userCropDefaults[commodity] = { yield: yieldVal, area: areaVal };
    localStorage.setItem('userCropDefaults', JSON.stringify(userCropDefaults));
    alert('Saved crop defaults');
    document.getElementById('modal-crop-defaults').style.display='none';
    computeForecastAndRender();
  });

  // open edit crop defaults from context (keyboard accessible)
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'e' && (e.ctrlKey || e.metaKey)){ // ctrl/cmd+e opens modal
      openCropDefaultsModal();
      e.preventDefault();
    }
  });

});

/* Open add record modal */
function openAddModal(){
  document.getElementById('modal-add-record').style.display='flex';
  document.getElementById('delete-record-btn').style.display='none';
  document.getElementById('rec-market').innerHTML = markets.map(m=>`<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join('');
  document.getElementById('record-form').onsubmit = (e)=>{
    e.preventDefault();
    const newRow = {
      date: new Date(document.getElementById('rec-date').value),
      market: document.getElementById('rec-market').value,
      commodity: document.getElementById('rec-commodity').value,
      variety: document.getElementById('rec-variety').value || 'Default',
      category: document.getElementById('rec-category').value || 'Other',
      district: document.getElementById('rec-district').value || '',
      modalPriceKg: parseFloat(document.getElementById('rec-modal').value) || 0,
      minPriceKg: parseFloat(document.getElementById('rec-min').value) || 0,
      maxPriceKg: parseFloat(document.getElementById('rec-max').value) || 0
    };
    commodityRows.push(newRow);
    commodityRows.sort((a,b)=>new Date(a.date)-new Date(b.date));
    saveToLocal();
    document.getElementById('modal-add-record').style.display='none';
    refreshAllUI();
  };
}

/* Open crop defaults modal */
function openCropDefaultsModal(){
  const sel = document.getElementById('crop-meta-commodity');
  if(!sel) return;
  // populate commodity list in modal
  const comms = [...new Set(commodityRows.map(r=>r.commodity))].sort();
  sel.innerHTML = comms.map(c=>`<option>${escapeHtml(c)}</option>`).join('');
  if(comms.length) sel.value = currentCommodity || comms[0];
  // populate with saved or default values
  const cur = sel.value;
  const meta = (window.CROP_META && window.CROP_META[cur]) || CROP_META_DEFAULTS[cur] || {};
  document.getElementById('crop-yield').value = (userCropDefaults[cur] && userCropDefaults[cur].yield) || meta.yield_kg_per_ha || '';
  document.getElementById('crop-area').value = (userCropDefaults[cur] && userCropDefaults[cur].area) || '';
  document.getElementById('modal-crop-defaults').style.display='flex';
  // update fields when commodity changed
  sel.onchange = ()=>{
    const c = sel.value;
    const m = (window.CROP_META && window.CROP_META[c]) || CROP_META_DEFAULTS[c] || {};
    document.getElementById('crop-yield').value = (userCropDefaults[c] && userCropDefaults[c].yield) || m.yield_kg_per_ha || '';
    document.getElementById('crop-area').value = (userCropDefaults[c] && userCropDefaults[c].area) || '';
  };
}

/* refresh UI safely */
function refreshAllUI(){
  try {
    populateMarketSelect();
    populateCategoryFilter();
    populateCommodityList();
    populateVarietyFilter();
    setDefaultDateRange();
    applyFilters();
    updateSnapshotTable();
    updateSummaryCards();
    updatePriceChart();
    updateDataTable();
    if(typeof populateMarketsTable === 'function') populateMarketsTable();
    // if prediction visible compute
    if(!document.getElementById('prediction-content').classList.contains('hidden')) computeForecastAndRender();
  } catch(e){ console.warn('refreshAllUI error', e); }
}

</script>
</body>
</html>
